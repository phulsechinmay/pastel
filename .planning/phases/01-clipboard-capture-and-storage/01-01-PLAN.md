---
phase: 01-clipboard-capture-and-storage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Pastel/PastelApp.swift
  - Pastel/App/AppState.swift
  - Pastel/Models/ClipboardItem.swift
  - Pastel/Models/ContentType.swift
  - Pastel/Views/MenuBar/StatusPopoverView.swift
  - Pastel/Resources/Info.plist
  - Pastel/Resources/Pastel.entitlements
  - Pastel.xcodeproj/project.pbxproj
  - Pastel.xcodeproj/project.xcworkspace/contents.xcworkspacedata
  - Package.swift
autonomous: true

must_haves:
  truths:
    - "App builds and runs on macOS 14+ without errors"
    - "App appears as a menu bar icon (clipboard SF Symbol) with no dock icon"
    - "Clicking the menu bar icon opens a popover window"
    - "SwiftData model container initializes and can persist ClipboardItem objects"
    - "SPM dependencies (KeyboardShortcuts, LaunchAtLogin) resolve successfully"
  artifacts:
    - path: "Pastel/PastelApp.swift"
      provides: "@main app entry point with MenuBarExtra and modelContainer"
      contains: "MenuBarExtra"
    - path: "Pastel/Models/ClipboardItem.swift"
      provides: "SwiftData @Model for clipboard entries"
      contains: "@Model"
    - path: "Pastel/Models/ContentType.swift"
      provides: "Content type enum (text, richText, url, image, file)"
      contains: "enum ContentType"
    - path: "Pastel/App/AppState.swift"
      provides: "@Observable central state object"
      contains: "@Observable"
    - path: "Pastel/Views/MenuBar/StatusPopoverView.swift"
      provides: "Status popover with item count and quit button"
      contains: "StatusPopoverView"
  key_links:
    - from: "Pastel/PastelApp.swift"
      to: "Pastel/Views/MenuBar/StatusPopoverView.swift"
      via: "MenuBarExtra hosts StatusPopoverView"
      pattern: "MenuBarExtra.*StatusPopoverView"
    - from: "Pastel/PastelApp.swift"
      to: "Pastel/Models/ClipboardItem.swift"
      via: "modelContainer for SwiftData"
      pattern: "modelContainer.*ClipboardItem"
    - from: "Pastel/App/AppState.swift"
      to: "Pastel/Views/MenuBar/StatusPopoverView.swift"
      via: "@Environment injection"
      pattern: "Environment.*AppState"
---

<objective>
Bootstrap the Pastel Xcode project from scratch and establish the foundational architecture: SwiftData model, menu bar app shell, and project configuration.

Purpose: This is a greenfield macOS app. Nothing exists yet. This plan creates the entire Xcode project structure, configures build settings, adds SPM dependencies, defines the SwiftData model for clipboard items, and delivers a running menu bar app with a basic status popover. Every subsequent plan depends on this foundation.

Output: A buildable, runnable macOS menu bar app with SwiftData persistence, visible in the menu bar with a clipboard icon, showing a popover when clicked.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-clipboard-capture-and-storage/01-CONTEXT.md
@.planning/phases/01-clipboard-capture-and-storage/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Xcode project with SPM dependencies and build configuration</name>
  <files>
    Pastel.xcodeproj/project.pbxproj
    Pastel.xcodeproj/project.xcworkspace/contents.xcworkspacedata
    Pastel/Resources/Info.plist
    Pastel/Resources/Pastel.entitlements
    Pastel/Resources/Assets.xcassets/Contents.json
    Pastel/Resources/Assets.xcassets/AppIcon.appiconset/Contents.json
  </files>
  <action>
    Create the Xcode project structure for a macOS app. Since this is a CLI-driven workflow without Xcode GUI, use `xcodegen` or create the project files manually.

    **Recommended approach: Use XcodeGen.**

    1. Install xcodegen if not present: `brew install xcodegen`

    2. Create `project.yml` at project root with these settings:
       - name: Pastel
       - targets:
         - Pastel (macOS Application)
           - type: application
           - platform: macOS
           - deploymentTarget: "14.0"
           - sources: [Pastel]
           - settings:
             - base:
               - PRODUCT_BUNDLE_IDENTIFIER: app.pastel.Pastel
               - MARKETING_VERSION: 0.1.0
               - CURRENT_PROJECT_VERSION: 1
               - SWIFT_VERSION: "6.0"
               - INFOPLIST_FILE: Pastel/Resources/Info.plist
               - CODE_SIGN_ENTITLEMENTS: Pastel/Resources/Pastel.entitlements
               - GENERATE_INFOPLIST_FILE: NO
               - ASSETCATALOG_COMPILER_APPICON_NAME: AppIcon
           - dependencies:
             - package: KeyboardShortcuts
             - package: LaunchAtLogin
       - packages:
         - KeyboardShortcuts:
             url: https://github.com/sindresorhus/KeyboardShortcuts
             from: "2.0.0"
         - LaunchAtLogin:
             url: https://github.com/sindresorhus/LaunchAtLogin-Modern
             from: "1.0.0"

    3. Create the directory structure BEFORE running xcodegen:
       ```
       Pastel/
         PastelApp.swift          (placeholder: empty @main struct, will be filled in Task 2)
         App/
         Models/
         Services/
         Views/
           MenuBar/
         Extensions/
         Resources/
           Info.plist
           Pastel.entitlements
           Assets.xcassets/
             Contents.json
             AppIcon.appiconset/
               Contents.json
       ```

    4. Create Info.plist with:
       - LSUIElement = true (hides dock icon -- CRITICAL for INFR-01)
       - CFBundleName = Pastel
       - CFBundleDisplayName = Pastel
       - CFBundleIdentifier = app.pastel.Pastel
       - CFBundleVersion = 1
       - CFBundleShortVersionString = 0.1.0
       - Standard keys: CFBundlePackageType = APPL, CFBundleInfoDictionaryVersion = 6.0

    5. Create Pastel.entitlements with:
       - com.apple.security.app-sandbox = true (start with sandbox per user decision)
       - com.apple.security.files.user-selected.read-write = true (for image storage in Application Support)

    6. Create Assets.xcassets with proper Contents.json files (standard Xcode asset catalog structure).

    7. Run `xcodegen generate` to create the .xcodeproj.

    8. Run `xcodebuild -resolvePackageDependencies -project Pastel.xcodeproj -scheme Pastel` to resolve SPM deps.

    **If xcodegen is not available or fails**, create the project manually by:
    - Creating a minimal project.pbxproj with the correct build settings
    - OR use `swift package init --type executable` and convert to an app target
    - The key requirement is: the project builds with `xcodebuild build -project Pastel.xcodeproj -scheme Pastel`

    **Critical settings that MUST be correct:**
    - LSUIElement = true in Info.plist (no dock icon)
    - Deployment target macOS 14.0
    - Swift 6.0 language version
    - App Sandbox enabled in entitlements
    - Both SPM packages resolve
  </action>
  <verify>
    Run: `xcodebuild build -project Pastel.xcodeproj -scheme Pastel -destination 'platform=macOS' 2>&1 | tail -5`
    Expected: BUILD SUCCEEDED (or at minimum, no project configuration errors -- source errors from placeholder files are acceptable at this stage).
    Run: `xcodebuild -resolvePackageDependencies -project Pastel.xcodeproj -scheme Pastel 2>&1 | tail -5`
    Expected: Package resolution succeeds for KeyboardShortcuts and LaunchAtLogin.
  </verify>
  <done>
    Xcode project exists at Pastel.xcodeproj, opens without errors, targets macOS 14.0, has LSUIElement=true in Info.plist, App Sandbox enabled in entitlements, and both SPM dependencies (KeyboardShortcuts, LaunchAtLogin) resolve successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SwiftData model, ContentType enum, AppState, and menu bar app entry point</name>
  <files>
    Pastel/PastelApp.swift
    Pastel/Models/ClipboardItem.swift
    Pastel/Models/ContentType.swift
    Pastel/App/AppState.swift
    Pastel/Views/MenuBar/StatusPopoverView.swift
  </files>
  <action>
    Create the core Swift source files that make the app functional.

    **1. ContentType.swift** -- Content type enum:
    ```swift
    enum ContentType: String, Codable, CaseIterable {
        case text
        case richText
        case url
        case image
        case file
    }
    ```

    **2. ClipboardItem.swift** -- SwiftData @Model (from research):
    - Import SwiftData, Foundation
    - @Model class ClipboardItem with ALL fields from the research model:
      - textContent: String? (plain text, URL string, or file path)
      - htmlContent: String? (HTML representation when available)
      - rtfData: Data? (RTF data when available)
      - contentType: String (raw value of ContentType enum -- SwiftData works better with String than custom enum for unique constraints)
      - timestamp: Date
      - sourceAppBundleID: String?
      - sourceAppName: String?
      - characterCount: Int
      - byteCount: Int
      - changeCount: Int (NSPasteboard changeCount at capture)
      - imagePath: String? (UUID.png filename, NOT full path)
      - thumbnailPath: String? (UUID_thumb.png filename)
      - isConcealed: Bool
      - expiresAt: Date?
      - @Attribute(.unique) contentHash: String (SHA256 hash for dedup)
    - Full memberwise init with sensible defaults
    - Computed property `type: ContentType` that converts contentType string to/from the enum
    - Store contentType as String because @Attribute(.unique) and SwiftData predicates work more reliably with primitive types on macOS 14

    **3. AppState.swift** -- Central @Observable state:
    ```swift
    import SwiftUI
    import SwiftData

    @Observable
    class AppState {
        var itemCount: Int = 0
        var isMonitoring: Bool = true

        // Will be populated by ClipboardMonitor in Plan 01-02
        // For now, just the state container
    }
    ```

    **4. StatusPopoverView.swift** -- Menu bar popover:
    - Show "Pastel" header with clipboard.fill SF Symbol
    - Display item count from AppState (e.g., "142 items captured")
    - Monitoring toggle (bound to appState.isMonitoring -- toggle logic will be wired in Plan 01-02)
    - Divider
    - "Quit Pastel" button that calls NSApplication.shared.terminate(nil)
    - Frame: width 260, height 160
    - Use @Environment(AppState.self) for state access
    - Match the layout from the research code example

    **5. PastelApp.swift** -- @main entry point:
    ```swift
    import SwiftUI
    import SwiftData

    @main
    struct PastelApp: App {
        @State private var appState = AppState()

        var body: some Scene {
            MenuBarExtra {
                StatusPopoverView()
                    .environment(appState)
                    .frame(width: 260, height: 160)
            } label: {
                Image(systemName: "clipboard")
            }
            .menuBarExtraStyle(.window)
        }
    }
    ```
    - Add .modelContainer(for: ClipboardItem.self) to the MenuBarExtra or as a scene modifier
    - The modelContainer should be created once and shared. Use `.modelContainer(for: ClipboardItem.self)` on the scene.

    **Important considerations:**
    - Do NOT import KeyboardShortcuts or LaunchAtLogin in any file yet -- they are added as dependencies for future phases
    - Use @Observable (not ObservableObject) -- macOS 14+ target
    - Use @Environment(AppState.self) (not @EnvironmentObject) -- macOS 14+ pattern
    - SwiftData @Model does NOT need Codable conformance
    - contentHash should be @Attribute(.unique) for dedup (works on macOS 14, just cannot use #Unique macro)
  </action>
  <verify>
    Run: `xcodebuild build -project Pastel.xcodeproj -scheme Pastel -destination 'platform=macOS' 2>&1 | tail -20`
    Expected: BUILD SUCCEEDED with zero errors.
    Run the app briefly: `xcodebuild build -project Pastel.xcodeproj -scheme Pastel -destination 'platform=macOS' && open $(find ~/Library/Developer/Xcode/DerivedData -name "Pastel.app" -path "*/Build/Products/Debug/*" | head -1) 2>/dev/null`
    Expected: App appears in menu bar as clipboard icon, clicking opens popover showing "0 items captured", monitoring toggle, and quit button. No dock icon visible.
  </verify>
  <done>
    App builds with zero errors and zero warnings (warnings about unused imports acceptable). Running the app shows a clipboard icon in the menu bar. Clicking it opens a popover with item count, monitoring toggle, and quit button. SwiftData model container initializes without errors (visible in console -- no SwiftData migration errors).
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild build -project Pastel.xcodeproj -scheme Pastel -destination 'platform=macOS'` succeeds
2. App runs and appears in menu bar (clipboard SF Symbol icon)
3. No dock icon appears (LSUIElement = true working)
4. Click menu bar icon -> popover opens with "0 items captured", monitoring toggle, quit button
5. Quit button terminates the app
6. No SwiftData errors in console on launch
7. SPM packages resolved (KeyboardShortcuts, LaunchAtLogin present in derived data)
</verification>

<success_criteria>
- Project builds cleanly with xcodebuild
- Menu bar icon appears, dock icon does not
- Popover opens and displays correctly
- SwiftData model container initializes without error
- All SPM dependencies resolve
- Requirements addressed: INFR-01 (menu bar, no dock icon), CLIP-05 (SwiftData model ready for persistence)
</success_criteria>

<output>
After completion, create `.planning/phases/01-clipboard-capture-and-storage/01-01-SUMMARY.md`
</output>
