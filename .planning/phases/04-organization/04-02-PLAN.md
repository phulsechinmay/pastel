---
phase: 04-organization
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - Pastel/Models/LabelColor.swift
  - Pastel/Views/Panel/ChipBarView.swift
  - Pastel/Views/Panel/PanelContentView.swift
  - Pastel/Views/Panel/ClipboardCardView.swift
autonomous: true

must_haves:
  truths:
    - "User sees label chips below search field when labels exist"
    - "User taps a chip to filter items by that label"
    - "User taps active chip to deselect and show all items"
    - "User taps '+' chip to create a new label with name and color"
    - "User right-clicks a card to assign a label via submenu"
    - "Search and chip filter combine with AND logic"
  artifacts:
    - path: "Pastel/Models/LabelColor.swift"
      provides: "LabelColor enum with 8 preset colors"
      contains: "enum LabelColor"
    - path: "Pastel/Views/Panel/ChipBarView.swift"
      provides: "Horizontal scrolling chip bar with label chips and '+' create chip"
      contains: "ScrollView(.horizontal"
  key_links:
    - from: "Pastel/Views/Panel/PanelContentView.swift"
      to: "Pastel/Views/Panel/ChipBarView.swift"
      via: "ChipBarView with selectedLabel binding"
      pattern: "ChipBarView\\("
    - from: "Pastel/Views/Panel/PanelContentView.swift"
      to: "Pastel/Views/Panel/FilteredCardListView.swift"
      via: "passes selectedLabel?.persistentModelID to FilteredCardListView"
      pattern: "selectedLabel\\?\\.persistentModelID"
    - from: "Pastel/Views/Panel/ClipboardCardView.swift"
      to: "Pastel/Models/Label.swift"
      via: "context menu assigns label to item"
      pattern: "\\.contextMenu"
---

<objective>
Add the chip bar for label filtering, inline label creation, and right-click context menu for label assignment on clipboard cards.

Purpose: This is the label management UI that lets users organize clipboard items. The chip bar provides visual filtering, the "+" chip enables quick label creation, and the context menu enables label assignment -- fulfilling ORGN-02, ORGN-03, and ORGN-04.

Output: LabelColor enum, ChipBarView with label chips + "+" create, context menu on cards with label submenu, chip filtering wired through PanelContentView to FilteredCardListView.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-organization/04-CONTEXT.md
@.planning/phases/04-organization/04-RESEARCH.md
@.planning/phases/04-organization/04-01-SUMMARY.md

@Pastel/Models/Label.swift
@Pastel/Models/ClipboardItem.swift
@Pastel/Views/Panel/PanelContentView.swift
@Pastel/Views/Panel/FilteredCardListView.swift
@Pastel/Views/Panel/ClipboardCardView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: LabelColor enum + ChipBarView with inline label creation</name>
  <files>
    Pastel/Models/LabelColor.swift
    Pastel/Views/Panel/ChipBarView.swift
  </files>
  <action>
    1. Create `Pastel/Models/LabelColor.swift`:
       - `enum LabelColor: String, CaseIterable` with cases: red, orange, yellow, green, blue, purple, pink, gray
       - Computed property `var color: Color` that maps each case to the corresponding SwiftUI Color (.red, .orange, etc.)
       - `import SwiftUI` for Color

    2. Create `Pastel/Views/Panel/ChipBarView.swift`:
       - Accepts: `labels: [Label]`, `@Binding var selectedLabel: Label?`
       - Also accepts `modelContext: ModelContext` (passed from environment) for label creation
       - Layout: `ScrollView(.horizontal, showsIndicators: false)` containing an `HStack(spacing: 6)`
       - For each label, render a chip button:
         - Pill shape: `Capsule()` background
         - Show a small colored circle (8x8) using `LabelColor(rawValue: label.colorName)?.color ?? .gray` + the label name text
         - Selected state: accent-colored background at 0.3 opacity with accent border. Unselected: `Color.white.opacity(0.1)` background.
         - Tap toggles: if already selected, set `selectedLabel = nil`. Otherwise set `selectedLabel = label`.
         - Compare using `persistentModelID` (not object equality)
       - After all label chips, render a "+" chip:
         - Shows "+" text in a pill shape with `Color.white.opacity(0.1)` background
         - Tap presents an inline label creation popover/sheet
       - Label creation popover:
         - TextField for label name
         - Horizontal row of color circles (ForEach LabelColor.allCases) -- tap to select
         - "Create" button that: creates a Label with the next sortOrder (fetch max sortOrder + 1, or 0 if none), inserts into modelContext, saves. Dismiss popover on create.
         - "Cancel" button to dismiss
       - Use `@State private var showingCreateLabel = false` for popover visibility
       - Use `@State private var newLabelName = ""` and `@State private var newLabelColor: LabelColor = .blue` for creation form state
       - Padding: `.padding(.horizontal, 12)` on the HStack, `.padding(.vertical, 6)` on the ScrollView
       - The entire ChipBarView should only be visible when `!labels.isEmpty || showingCreateLabel` -- but since we always show the "+" chip, always show the chip bar. Actually per CONTEXT.md: "Chip bar only shows labels that have been created (no chips if no labels exist)". So conditionally show the ENTIRE chip bar (including "+") only when at least one label exists, OR provide the "+" as a standalone element that is always visible. Decision: show the "+" chip always so users can discover label creation. Show the full chip bar row (with "+" at the end) always. If no labels exist, only the "+" chip appears.

    Anti-patterns to avoid:
    - Do NOT compare Label objects directly -- use persistentModelID for selection comparison
    - Do NOT forget to save after inserting a new label
    - Do NOT use a sheet for label creation (would require a window in menu-bar app) -- use `.popover` instead
  </action>
  <verify>
    `cd /Users/phulsechinmay/Desktop/Projects/pastel && xcodebuild -scheme Pastel -destination 'platform=macOS' build 2>&1 | tail -5` -- must show BUILD SUCCEEDED
  </verify>
  <done>LabelColor enum exists with 8 colors. ChipBarView renders label chips with selection toggle and "+" creation chip. Label creation popover allows name + color selection + create.</done>
</task>

<task type="auto">
  <name>Task 2: Context menu on cards + chip bar wired into PanelContentView</name>
  <files>
    Pastel/Views/Panel/ClipboardCardView.swift
    Pastel/Views/Panel/PanelContentView.swift
  </files>
  <action>
    1. Add context menu to `ClipboardCardView.swift`:
       - Add `@Query(sort: \Label.sortOrder) private var labels: [Label]` to fetch all labels
       - Add `@Environment(\.modelContext) private var modelContext`
       - Add `.contextMenu` modifier to the card's outermost container (after the existing .animation modifiers):
         - `Menu("Label")` submenu containing:
           - `ForEach(labels)` with a Button for each label showing: colored circle (8x8 via LabelColor) + label name text + checkmark Image(systemName: "checkmark") if `item.label?.persistentModelID == label.persistentModelID`
           - Button action: `item.label = label; try? modelContext.save()`
           - If `item.label != nil`, add Divider + "Remove Label" button that sets `item.label = nil; try? modelContext.save()`
         - `Divider()`
         - `Button("Delete", role: .destructive)` -- for now, call a placeholder delete action. The actual delete logic will be wired in Plan 03. For now: `modelContext.delete(item); try? modelContext.save()` as a basic implementation. Plan 03 will add proper image cleanup and expiration cancellation.

    2. Wire chip bar into `PanelContentView.swift`:
       - Add `@Query(sort: \Label.sortOrder) private var labels: [Label]` to PanelContentView to pass to ChipBarView
       - The `@State private var selectedLabel: Label?` should already exist from Plan 01
       - In the body, between the SearchFieldView and FilteredCardListView, add:
         ```
         ChipBarView(labels: labels, selectedLabel: $selectedLabel)
         ```
       - The FilteredCardListView already accepts `selectedLabelID: selectedLabel?.persistentModelID` from Plan 01
       - This completes the chain: chip selection -> selectedLabel state -> persistentModelID -> FilteredCardListView predicate -> filtered results

    Anti-patterns to avoid:
    - Do NOT compare Label objects directly in context menu checkmark logic -- use persistentModelID
    - Do NOT forget `try? modelContext.save()` after label assignment changes
    - Do NOT add @Query for labels in FilteredCardListView -- it goes in ClipboardCardView (for context menu) and PanelContentView (for chip bar)
  </action>
  <verify>
    `cd /Users/phulsechinmay/Desktop/Projects/pastel && xcodebuild -scheme Pastel -destination 'platform=macOS' build 2>&1 | tail -5` -- must show BUILD SUCCEEDED
  </verify>
  <done>Chip bar appears between search field and card list. Tapping a chip filters cards to that label. Tapping active chip deselects. Right-clicking a card shows context menu with Label submenu (assign/remove) and Delete. Label assignment persists. Search + chip filter combine with AND logic.</done>
</task>

</tasks>

<verification>
1. Build succeeds: `xcodebuild -scheme Pastel -destination 'platform=macOS' build`
2. LabelColor.swift has 8 color cases with Color mapping
3. ChipBarView renders with "+" creation chip, label chips appear after creation
4. PanelContentView includes ChipBarView between search and card list
5. Selecting a chip filters the card list to items with that label
6. Deselecting a chip shows all items
7. Right-click on card shows "Label" submenu with label list and checkmark for assigned label
8. Right-click on card shows "Delete" action
9. Search + chip filter produce AND-combined results
</verification>

<success_criteria>
- LabelColor enum provides 8 preset colors
- ChipBarView allows label selection/deselection and inline creation
- Context menu on cards enables label assignment with visual checkmark
- Chip filtering correctly narrows displayed items
- Search and chip filter combine (AND logic)
- Label creation persists to SwiftData
- Build succeeds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-organization/04-02-SUMMARY.md`
</output>
