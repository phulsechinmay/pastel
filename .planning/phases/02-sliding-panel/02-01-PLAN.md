---
phase: 02-sliding-panel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Pastel/Views/Panel/SlidingPanel.swift
  - Pastel/Views/Panel/PanelController.swift
  - Pastel/Views/Panel/PanelContentView.swift
  - Pastel/Views/Panel/EmptyStateView.swift
  - Pastel/App/AppState.swift
  - Pastel/PastelApp.swift
  - project.yml
autonomous: true

must_haves:
  truths:
    - "Panel slides in from the right screen edge with smooth ~0.2s animation when toggled"
    - "Panel slides out when Escape is pressed or user clicks outside"
    - "Panel uses dark vibrancy material background (NSVisualEffectView with .dark material)"
    - "Panel appears on the screen where the mouse cursor is"
    - "Panel does not steal focus from the active application (nonactivatingPanel)"
    - "Empty state message shows when no clipboard items exist"
  artifacts:
    - path: "Pastel/Views/Panel/SlidingPanel.swift"
      provides: "NSPanel subclass with nonactivatingPanel style mask set at init"
      contains: "nonactivatingPanel"
    - path: "Pastel/Views/Panel/PanelController.swift"
      provides: "Panel lifecycle: show/hide animation, screen detection, event monitors"
      contains: "NSAnimationContext"
    - path: "Pastel/Views/Panel/PanelContentView.swift"
      provides: "Root SwiftUI view with @Query-driven ScrollView/LazyVStack"
      contains: "@Query"
    - path: "Pastel/Views/Panel/EmptyStateView.swift"
      provides: "Friendly empty state when no items exist"
    - path: "Pastel/App/AppState.swift"
      provides: "PanelController integration with togglePanel()"
      contains: "panelController"
  key_links:
    - from: "Pastel/PastelApp.swift"
      to: "Pastel/App/AppState.swift"
      via: "Menu bar icon click calls appState.togglePanel()"
      pattern: "togglePanel"
    - from: "Pastel/App/AppState.swift"
      to: "Pastel/Views/Panel/PanelController.swift"
      via: "AppState owns PanelController, delegates toggle"
      pattern: "panelController\\.toggle"
    - from: "Pastel/Views/Panel/PanelController.swift"
      to: "Pastel/Views/Panel/SlidingPanel.swift"
      via: "PanelController creates and animates SlidingPanel"
      pattern: "SlidingPanel"
    - from: "Pastel/Views/Panel/PanelController.swift"
      to: "Pastel/Views/Panel/PanelContentView.swift"
      via: "NSHostingView wraps PanelContentView inside the panel"
      pattern: "NSHostingView.*PanelContentView"
---

<objective>
Create the NSPanel-based sliding panel infrastructure: a non-activating floating panel that slides in/out from the right screen edge with dark vibrancy material, hosted SwiftUI content shell, and menu bar toggle integration.

Purpose: This is the foundational AppKit infrastructure for the clipboard history browser. The panel must be non-activating (never steal focus), use NSVisualEffectView for the dark material background, and animate smoothly. All future card UI (Plan 02) builds on top of the SwiftUI content view established here.

Output: Working panel that slides in from the right edge on menu bar click, shows an empty state or placeholder list of clipboard items via @Query, and dismisses on Escape or click-outside.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sliding-panel/02-CONTEXT.md
@.planning/phases/02-sliding-panel/02-RESEARCH.md
@.planning/phases/01-clipboard-capture-and-storage/01-01-SUMMARY.md
@Pastel/App/AppState.swift
@Pastel/PastelApp.swift
@Pastel/Models/ClipboardItem.swift
@Pastel/Models/ContentType.swift
@project.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SlidingPanel NSPanel subclass and PanelController with animation and dismiss</name>
  <files>
    Pastel/Views/Panel/SlidingPanel.swift
    Pastel/Views/Panel/PanelController.swift
  </files>
  <action>
    Create the `Pastel/Views/Panel/` directory structure.

    **SlidingPanel.swift** -- NSPanel subclass:
    - Import AppKit.
    - `final class SlidingPanel: NSPanel` with init setting styleMask to `[.nonactivatingPanel, .fullSizeContentView, .borderless]`, backing `.buffered`, defer `true`.
    - CRITICAL: `.nonactivatingPanel` MUST be in the init styleMask parameter. Do NOT set it after init.
    - Configure: `isFloatingPanel = true`, `level = .floating`, `collectionBehavior = [.canJoinAllSpaces, .fullScreenAuxiliary]`, `hidesOnDeactivate = false`.
    - Transparent: `isOpaque = false`, `backgroundColor = .clear`.
    - Shadow and chrome: `hasShadow = true`, `isReleasedWhenClosed = false`, `titleVisibility = .hidden`, `titlebarAppearsTransparent = true`, `isMovableByWindowBackground = false`.
    - Override `canBecomeKey` -> `true` (forward-compatible for Phase 4 search field).
    - Override `canBecomeMain` -> `false`.

    **PanelController.swift** -- @MainActor class managing panel lifecycle:
    - Import AppKit, SwiftUI, SwiftData.
    - `@MainActor final class PanelController` with private properties: `panel: SlidingPanel?`, `globalClickMonitor: Any?`, `localKeyMonitor: Any?`.
    - Constants: `panelWidth: CGFloat = 300`, `animationDuration: TimeInterval = 0.2`.
    - Computed `isVisible: Bool` returning `panel?.isVisible ?? false`.
    - `toggle()` method: if visible call hide(), else call show().
    - `show()` method:
      1. Call `screenWithMouse()` to get the correct NSScreen.
      2. Use `screen.visibleFrame` (NOT `.frame` -- avoids menu bar/Dock overlap).
      3. If panel is nil, call `createPanel()`.
      4. Calculate `onScreenFrame` = right edge of visibleFrame, full height, panelWidth wide.
      5. Calculate `offScreenFrame` = same but x = visibleFrame.maxX (just off-screen right).
      6. Set panel frame to offScreenFrame without display.
      7. Call `panel.orderFrontRegardless()`.
      8. Animate with `NSAnimationContext.runAnimationGroup`: duration 0.2s, timingFunction `.easeOut`, `panel.animator().setFrame(onScreenFrame, display: true)`.
      9. Call `installEventMonitors()`.
    - `hide()` method:
      1. Guard panel is visible.
      2. Get visibleFrame from panel.screen or fallback to NSScreen.main.
      3. Calculate offScreenFrame at visibleFrame.maxX.
      4. Animate with NSAnimationContext: duration 0.2s, timingFunction `.easeIn`, panel.animator().setFrame(offScreenFrame, display: true).
      5. In completionHandler: `panel.orderOut(nil)`, call `removeEventMonitors()`.
    - `screenWithMouse() -> NSScreen`: iterate NSScreen.screens, find one whose frame contains NSEvent.mouseLocation, fallback to NSScreen.main.
    - `installEventMonitors()`:
      1. Global monitor for `.leftMouseDown, .rightMouseDown` -> call hide().
      2. Local monitor for `.keyDown` -> if keyCode == 53 (Escape), call hide() and return nil to consume event. Otherwise return event.
    - `removeEventMonitors()`: remove both monitors via NSEvent.removeMonitor, nil them out.
    - `createPanel()` private method:
      1. Create SlidingPanel instance.
      2. Create NSVisualEffectView with `material = .dark`, `blendingMode = .behindWindow`, `state = .active`, `appearance = NSAppearance(named: .darkAqua)`.
      3. Set visualEffectView as `panel.contentView`.
      4. Create `NSHostingView(rootView: PanelContentView().environment(\.colorScheme, .dark))`.
      5. Set `translatesAutoresizingMaskIntoConstraints = false`.
      6. Add hostingView as subview of visualEffectView.
      7. Pin hostingView to all 4 edges of visualEffectView with Auto Layout constraints.
      8. Store panel.
    - Add a `setModelContainer(_ container: ModelContainer)` method that can be called to pass the model container to the hosting view. In createPanel(), accept and apply the container. Store the container as a property so createPanel() can use it. The NSHostingView root view needs `.modelContainer(container)` applied.

    Use `import OSLog` and add a Logger for "PanelController" category for structured logging of show/hide events.
  </action>
  <verify>
    Run `xcodebuild build -project Pastel.xcodeproj -scheme Pastel -destination 'platform=macOS' 2>&1 | tail -5` -- must compile without errors. If project.yml changes are needed for compilation, defer to Task 2.
  </verify>
  <done>
    SlidingPanel.swift exists with nonactivatingPanel in init styleMask. PanelController.swift exists with show/hide animation, screen detection, and event monitors. Both files compile.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PanelContentView, EmptyStateView, wire into AppState and PastelApp, update project.yml</name>
  <files>
    Pastel/Views/Panel/PanelContentView.swift
    Pastel/Views/Panel/EmptyStateView.swift
    Pastel/App/AppState.swift
    Pastel/PastelApp.swift
    project.yml
  </files>
  <action>
    **PanelContentView.swift** -- Root SwiftUI view inside the panel:
    - Import SwiftUI, SwiftData.
    - `struct PanelContentView: View` with `@Query(sort: \ClipboardItem.timestamp, order: .reverse) private var items: [ClipboardItem]`.
    - Body: `VStack(spacing: 0)` containing:
      1. A minimal header: `HStack` with `Text("Pastel")` in `.headline` font, `.foregroundStyle(.secondary)`, padded. Keep it minimal to maximize card space.
      2. `Divider()` below header.
      3. If items.isEmpty: show `EmptyStateView()`.
      4. Else: `ScrollView` containing `LazyVStack(spacing: 6)` with `ForEach(items) { item in Text(item.textContent ?? item.contentType).lineLimit(2) }` as a **temporary placeholder** -- Plan 02 replaces this with real card views.
      5. `.padding(.horizontal, 8)` and `.padding(.vertical, 6)` on the LazyVStack.
    - Apply `.frame(maxWidth: .infinity, maxHeight: .infinity)` to the VStack.
    - Apply `.preferredColorScheme(.dark)`.

    **EmptyStateView.swift**:
    - Import SwiftUI.
    - `struct EmptyStateView: View` showing a centered VStack with:
      1. `Image(systemName: "clipboard")` at `.system(size: 40)` in `.secondary` color.
      2. `Text("Copy something to get started")` in `.headline` font, `.secondary` foreground.
      3. Small subtitle: `Text("Your clipboard history will appear here")` in `.caption` font, `.tertiary` foreground.
    - Center it using `.frame(maxWidth: .infinity, maxHeight: .infinity)`.

    **AppState.swift** modifications:
    - Add `let panelController = PanelController()` property.
    - Add `func togglePanel()` that calls `panelController.toggle()`.
    - Add a `func setupPanel(modelContainer: ModelContainer)` method that calls `panelController.setModelContainer(modelContainer)`.

    **PastelApp.swift** modifications:
    - In the `init()`, after `state.setup(modelContext:)`, call `state.setupPanel(modelContainer: container)`.
    - Replace the current MenuBarExtra label `Image(systemName: "clipboard")` with the same icon, but make the menu bar icon clickable to toggle the panel. Since MenuBarExtra with `.window` style shows a popover on click, we need a different approach:
      - Add a second menu bar interaction. The simplest approach: add a button inside the existing StatusPopoverView that says "Show History" and calls `appState.togglePanel()`. The popover remains the primary click target for the menu bar icon.
      - OR: Change the MenuBarExtra to use a `.menu` style and add a "Toggle Panel" menu item. But this loses the status popover.
      - BEST approach for Phase 2: Keep the MenuBarExtra popover as-is. Add a "Show History" button in StatusPopoverView that calls `appState.togglePanel()`. Also register `Cmd+Shift+V` via KeyboardShortcuts as a global shortcut for panel toggle.
    - Register the keyboard shortcut: In AppState or PastelApp init, use the KeyboardShortcuts library to register Cmd+Shift+V mapped to `togglePanel()`. Follow the KeyboardShortcuts library API:
      1. Add `extension KeyboardShortcuts.Name { static let togglePanel = Self("togglePanel", default: .init(.v, modifiers: [.command, .shift])) }` somewhere accessible (e.g., in AppState.swift or a new small file).
      2. In AppState.setup or PastelApp, call `KeyboardShortcuts.onKeyUp(for: .togglePanel) { [weak appState] in appState?.togglePanel() }` -- be mindful of @MainActor requirements.

    **StatusPopoverView.swift** modification:
    - Add a "Show History" button that calls `appState.togglePanel()`. Place it prominently (e.g., a Button with clipboard.fill icon).

    **project.yml** update:
    - The project uses XcodeGen with `sources: [Pastel]` which auto-discovers files. However, regenerate the Xcode project to pick up new files: run `xcodegen generate` after creating all files.

    After all files are created, run `xcodegen generate` to regenerate the Xcode project, then build with `xcodebuild`.
  </action>
  <verify>
    1. Run `xcodegen generate` -- must succeed.
    2. Run `xcodebuild build -project Pastel.xcodeproj -scheme Pastel -destination 'platform=macOS' 2>&1 | tail -20` -- must compile without errors.
    3. Verify files exist: `ls Pastel/Views/Panel/*.swift` shows SlidingPanel.swift, PanelController.swift, PanelContentView.swift, EmptyStateView.swift.
  </verify>
  <done>
    Panel infrastructure compiles and is wired end-to-end: menu bar "Show History" button and Cmd+Shift+V both trigger panel toggle. Panel slides in from right edge with dark vibrancy, shows placeholder item list or empty state, dismisses on Escape or click-outside. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `xcodegen generate && xcodebuild build -project Pastel.xcodeproj -scheme Pastel -destination 'platform=macOS'` succeeds
2. All 4 new Swift files exist in `Pastel/Views/Panel/`
3. AppState has `panelController` property and `togglePanel()` method
4. PastelApp wires the model container to the panel controller
5. SlidingPanel init contains `.nonactivatingPanel` in styleMask
6. PanelController has show/hide animation with NSAnimationContext
7. PanelController has global click monitor and local Escape monitor
8. Cmd+Shift+V shortcut is registered
</verification>

<success_criteria>
- App compiles with zero errors
- Panel slides in from right screen edge with ~0.2s animation
- Panel uses NSVisualEffectView dark material background
- Panel dismisses on Escape key or click outside
- Panel appears on the screen where mouse cursor is
- Empty state shows when no clipboard items exist
- Placeholder item list shows when items exist (real cards in Plan 02)
- Cmd+Shift+V global shortcut toggles the panel
- Menu bar popover has "Show History" button
</success_criteria>

<output>
After completion, create `.planning/phases/02-sliding-panel/02-01-SUMMARY.md`
</output>
