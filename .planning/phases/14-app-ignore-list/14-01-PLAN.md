---
phase: 14-app-ignore-list
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Pastel/Services/AppDiscoveryService.swift
  - Pastel/Services/ClipboardMonitor.swift
autonomous: true

must_haves:
  truths:
    - "Copying text in an app on the ignore list does NOT create a clipboard item in Pastel"
    - "Copying an image in an app on the ignore list does NOT create a clipboard item in Pastel"
    - "Copying in a non-ignored app continues to work exactly as before"
    - "AppDiscoveryService returns installed apps from /Applications, /System/Applications, ~/Applications"
    - "AppDiscoveryService detects installed password managers via bundle ID prefix matching"
  artifacts:
    - path: "Pastel/Services/AppDiscoveryService.swift"
      provides: "App discovery and password manager detection"
      exports: ["AppDiscoveryService", "DiscoveredApp"]
    - path: "Pastel/Services/ClipboardMonitor.swift"
      provides: "Ignore-list filtering in checkForChanges()"
      contains: "ignoredAppBundleIDs"
  key_links:
    - from: "Pastel/Services/ClipboardMonitor.swift"
      to: "UserDefaults ignoredAppBundleIDs"
      via: "UserDefaults.standard.stringArray read in checkForChanges()"
      pattern: "UserDefaults.standard.stringArray.*ignoredAppBundleIDs"
---

<objective>
Create the service layer for Phase 14: App Ignore List. This includes AppDiscoveryService (scans installed apps, detects password managers) and ClipboardMonitor filtering (skips captures from ignored app bundle IDs).

Purpose: Backend foundation -- the ignore list must work before building UI on top of it.
Output: Two files -- new AppDiscoveryService.swift, modified ClipboardMonitor.swift with ignore-list guard.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-app-ignore-list/14-RESEARCH.md

@Pastel/Services/ClipboardMonitor.swift
@Pastel/Services/RetentionService.swift
@Pastel/Extensions/NSWorkspace+AppIcon.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AppDiscoveryService</name>
  <files>Pastel/Services/AppDiscoveryService.swift</files>
  <action>
Create `Pastel/Services/AppDiscoveryService.swift` with:

**DiscoveredApp struct:**
- Properties: `bundleID: String`, `name: String`, `url: URL`
- Conforms to `Identifiable` (id = bundleID), `Equatable`
- `Identifiable.id` computed as `bundleID`

**AppDiscoveryService enum (static methods, @MainActor):**

1. `static func discoverInstalledApps() -> [DiscoveredApp]`
   - Scan three directories: `/Applications`, `/System/Applications`, `~/Applications` (use `NSHomeDirectory()`)
   - Use `FileManager.default.contentsOfDirectory(at:includingPropertiesForKeys:options:)` with `.skipsHiddenFiles`
   - SHALLOW scan only (NOT recursive) -- `.app` bundles are directories, recursive would enter them
   - Filter by `url.pathExtension == "app"`
   - For each .app: `Bundle(url:)` to get bundle, extract `bundleIdentifier` (skip if nil)
   - Name resolution order: `CFBundleDisplayName` > `CFBundleName` > filename without extension
   - Deduplicate by bundleID (first seen wins, use a `Set<String>` for seen IDs)
   - Return sorted alphabetically by name (`localizedCaseInsensitiveCompare`)

2. `static func detectInstalledPasswordManagers(from installedApps: [DiscoveredApp]) -> [DiscoveredApp]`
   - Private constant `passwordManagerPatterns: [(prefix: String, name: String)]` containing:
     - `("com.agilebits.onepassword", "1Password")`
     - `("com.1password", "1Password")`
     - `("2BUA8C4S2C.com.agilebits", "1Password (App Store)")`
     - `("com.bitwarden.desktop", "Bitwarden")`
     - `("com.dashlane.Dashlane", "Dashlane")`
     - `("com.lastpass.LastPass", "LastPass")`
     - `("org.keepassxc.keepassxc", "KeePassXC")`
     - `("com.keepassium", "KeePassium")`
     - `("de.devland.macpass", "MacPass")`
     - `("com.apple.Passwords", "Apple Passwords")`
     - `("com.enpass.Enpass", "Enpass")`
     - `("com.roboform.roboform", "RoboForm")`
   - Filter installed apps where `bundleID.hasPrefix(pattern.prefix)` for any pattern
   - Return matching apps (preserving original DiscoveredApp with real name, not pattern name)

Import only `Foundation` and `AppKit` (for NSWorkspace if needed later, but pure Foundation should suffice here).
  </action>
  <verify>Project builds with `xcodebuild -scheme Pastel build 2>&1 | tail -5` -- no compile errors.</verify>
  <done>AppDiscoveryService.swift exists with DiscoveredApp model and two static methods (discoverInstalledApps, detectInstalledPasswordManagers). Compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Add ignore-list filtering to ClipboardMonitor</name>
  <files>Pastel/Services/ClipboardMonitor.swift</files>
  <action>
Modify `ClipboardMonitor.checkForChanges()` to add an app ignore-list guard.

Insert the ignore check AFTER the `skipNextChange` guard and BEFORE the `processPasteboardContent()` call. This ensures ALL content types (text, image, URL, file, code, color) are filtered uniformly -- images included, since `processImageContent()` is called from within `processPasteboardContent()`.

Add this block at the marked location:

```swift
// Phase 14: App ignore list filtering
if let bundleID = NSWorkspace.shared.frontmostApplication?.bundleIdentifier {
    let ignored = Set(UserDefaults.standard.stringArray(forKey: "ignoredAppBundleIDs") ?? [])
    if ignored.contains(bundleID) {
        Self.logger.debug("Skipping capture from ignored app: \(bundleID)")
        return
    }
}
```

Key design choices (matching existing codebase patterns):
- Read UserDefaults directly each poll cycle (matches RetentionService pattern at line 40 -- reads `historyRetention` fresh each time, no caching)
- Create `Set<String>` for O(1) lookup (tiny cost at 0.5s intervals, typically 5-20 entries)
- Do NOT cache the ignore set or use NotificationCenter -- simplicity over premature optimization
- Log at `.debug` level (not `.info`) to avoid log spam every 0.5s for ignored apps
- Guard on `bundleIdentifier` being non-nil (nil means no frontmost app, allow capture)
  </action>
  <verify>
1. Project builds: `xcodebuild -scheme Pastel build 2>&1 | tail -5`
2. Verify the guard is in the right position: read ClipboardMonitor.swift and confirm the ignore check is between `skipNextChange` and `processPasteboardContent()`.
  </verify>
  <done>ClipboardMonitor.checkForChanges() has an early-exit guard that reads "ignoredAppBundleIDs" from UserDefaults and skips capture when the frontmost app's bundleIdentifier is in the ignore set. Guard is placed after skipNextChange, before processPasteboardContent().</done>
</task>

</tasks>

<verification>
1. `xcodebuild -scheme Pastel build` completes without errors
2. ClipboardMonitor.swift contains `ignoredAppBundleIDs` string key reference
3. AppDiscoveryService.swift exists with DiscoveredApp struct and two static methods
4. The ignore check in checkForChanges() is between skipNextChange guard and processPasteboardContent() call
</verification>

<success_criteria>
- AppDiscoveryService can enumerate installed apps from 3 system directories
- AppDiscoveryService can detect installed password managers via prefix matching
- ClipboardMonitor skips ALL content types (text, image, URL, file) when frontmost app is on the ignore list
- Ignore list reads fresh from UserDefaults each poll (no stale cache)
- Project compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/14-app-ignore-list/14-01-SUMMARY.md`
</output>
