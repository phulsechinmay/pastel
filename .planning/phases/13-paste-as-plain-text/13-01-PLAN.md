---
phase: 13-paste-as-plain-text
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Pastel/Services/PasteService.swift
  - Pastel/Views/Panel/ClipboardCardView.swift
  - Pastel/Views/Panel/FilteredCardListView.swift
  - Pastel/Views/Settings/HistoryGridView.swift
  - Pastel/Views/Settings/HistoryBrowserView.swift
autonomous: true

must_haves:
  truths:
    - "User right-clicks a clipboard card in the panel and sees 'Paste as Plain Text' option that pastes with all formatting stripped"
    - "User selects a card in the panel and presses Shift+Enter to paste as plain text"
    - "User Shift+double-clicks a card in the panel to paste as plain text"
    - "User right-clicks a clipboard card in the History browser and sees 'Paste as Plain Text' option"
    - "User pastes rich HTML content as plain text into Google Docs or Notes and zero formatting appears"
  artifacts:
    - path: "Pastel/Services/PasteService.swift"
      provides: "writeToPasteboardPlainText writes ONLY .string type (no .html, no .rtf)"
      contains: "setString(text, forType: .string)"
      must_not_contain: "setString(html, forType: .html)"
    - path: "Pastel/Views/Panel/ClipboardCardView.swift"
      provides: "Context menu with Paste as Plain Text button"
      contains: "Paste as Plain Text"
    - path: "Pastel/Views/Panel/FilteredCardListView.swift"
      provides: "Shift+Enter handler and Shift+double-click handler"
      contains: "keyPress.modifiers.contains(.shift)"
    - path: "Pastel/Views/Settings/HistoryGridView.swift"
      provides: "Context menu with Paste as Plain Text for single items"
      contains: "Paste as Plain Text"
    - path: "Pastel/Views/Settings/HistoryBrowserView.swift"
      provides: "pastePlainText closure wired to HistoryGridView"
      contains: "pastePlainText"
  key_links:
    - from: "Pastel/Views/Panel/ClipboardCardView.swift"
      to: "PanelActions.pastePlainTextItem"
      via: "panelActions.pastePlainTextItem?(item)"
      pattern: "panelActions\\.pastePlainTextItem\\?"
    - from: "Pastel/Views/Panel/FilteredCardListView.swift"
      to: "onPastePlainText callback"
      via: "onPastePlainText(filteredItems[index])"
      pattern: "onPastePlainText\\(filteredItems"
    - from: "Pastel/Views/Settings/HistoryBrowserView.swift"
      to: "AppState.pastePlainText"
      via: "appState.pastePlainText(item)"
      pattern: "appState\\.pastePlainText"
---

<objective>
Add "Paste as Plain Text" to all clipboard card interaction surfaces (context menu, Shift+Enter, Shift+double-click) and fix the critical HTML bug that causes plain text paste to retain formatting.

Purpose: Users need a reliable way to paste clipboard items without any formatting (RTF or HTML). The existing plain text paste infrastructure is 90% complete but has a bug where HTML is still written to the pasteboard, and the UI entry points are not yet exposed.

Output: Working paste-as-plain-text from both the sliding panel (3 methods) and the History browser (context menu), with the HTML bug fixed so pasting into formatting-aware apps like Google Docs produces zero formatting.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-paste-as-plain-text/13-RESEARCH.md

Key source files:
@Pastel/Services/PasteService.swift
@Pastel/Views/Panel/ClipboardCardView.swift
@Pastel/Views/Panel/FilteredCardListView.swift
@Pastel/Views/Settings/HistoryGridView.swift
@Pastel/Views/Settings/HistoryBrowserView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix HTML bug and add panel paste-as-plain-text UI entry points</name>
  <files>
    Pastel/Services/PasteService.swift
    Pastel/Views/Panel/ClipboardCardView.swift
    Pastel/Views/Panel/FilteredCardListView.swift
  </files>
  <action>
    **FIRST (PAST-23 -- the HTML bug fix):** In `PasteService.swift`, method `writeToPasteboardPlainText(item:)` (around line 231-239), remove the 3 lines that write HTML to the pasteboard:
    ```
    if let html = item.htmlContent {
        pasteboard.setString(html, forType: .html)
    }
    ```
    After removal, the method should ONLY write `.string` type. Update the comment on line 231 from "Write string and HTML only -- NO .rtf data" to "Write ONLY plain string -- no .rtf, no .html". Update the logger message to say "RTF and HTML stripped" instead of just "RTF stripped".

    **SECOND (PAST-20 -- context menu):** In `ClipboardCardView.swift`, inside the `.contextMenu` block (around line 163-222), add a "Paste as Plain Text" button AFTER the "Copy + Paste" button (line 172) and BEFORE the Divider on line 174:
    ```swift
    Button("Paste as Plain Text") {
        panelActions.pastePlainTextItem?(item)
    }
    ```
    The `panelActions.pastePlainTextItem` callback is already wired through PanelController to AppState.pastePlainText(). No new wiring needed.

    **THIRD (PAST-21 -- Shift+Enter):** In `FilteredCardListView.swift`, replace the `.onKeyPress(.return)` handler (lines 230-234) to accept the `keyPress` parameter and check for Shift modifier:
    ```swift
    .onKeyPress(.return) { keyPress in
        if let index = selectedIndex, index < filteredItems.count {
            if keyPress.modifiers.contains(.shift) {
                onPastePlainText(filteredItems[index])
            } else {
                onPaste(filteredItems[index])
            }
        }
        return .handled
    }
    ```
    Note: The existing handler uses `{ ... }` with no arguments. The new handler must use `{ keyPress in ... }` to access modifiers. This pattern is already proven at line 236 (`onKeyPress(characters: .decimalDigits) { keyPress in`).

    **FOURTH (PAST-22 -- Shift+double-click):** In `FilteredCardListView.swift`, update BOTH `.onTapGesture(count: 2)` handlers:

    1. Horizontal layout branch (around line 120): Replace `onPaste(item)` with:
    ```swift
    .onTapGesture(count: 2) {
        if NSEvent.modifierFlags.contains(.shift) {
            onPastePlainText(item)
        } else {
            onPaste(item)
        }
    }
    ```

    2. Vertical layout branch (around line 172): Same replacement:
    ```swift
    .onTapGesture(count: 2) {
        if NSEvent.modifierFlags.contains(.shift) {
            onPastePlainText(item)
        } else {
            onPaste(item)
        }
    }
    ```

    CRITICAL: Both branches MUST be updated identically. The horizontal branch is for top/bottom panel edges; the vertical branch is for left/right panel edges. Missing either one causes inconsistent behavior.

    `NSEvent.modifierFlags` is a static class property that reads current modifier key state -- already proven in `HistoryGridView.swift` line 160 for Cmd-click/Shift-click detection.
  </action>
  <verify>
    Run `xcodebuild build -project Pastel.xcodeproj -scheme Pastel -configuration Debug -quiet 2>&1 | tail -5` (or the project's build command) to confirm compilation succeeds with zero errors.

    Verify with grep:
    - `grep -n "forType: .html" Pastel/Services/PasteService.swift` should return NO matches in `writeToPasteboardPlainText` (may still exist in `writeToPasteboard`)
    - `grep -n "Paste as Plain Text" Pastel/Views/Panel/ClipboardCardView.swift` should return 1 match
    - `grep -c "NSEvent.modifierFlags.contains(.shift)" Pastel/Views/Panel/FilteredCardListView.swift` should return 2 (one per layout branch)
    - `grep -n "keyPress.modifiers.contains(.shift)" Pastel/Views/Panel/FilteredCardListView.swift` should show the .return handler
  </verify>
  <done>
    1. writeToPasteboardPlainText() writes ONLY .string type -- no .html, no .rtf
    2. ClipboardCardView context menu shows "Paste as Plain Text" after "Copy + Paste"
    3. Shift+Enter in FilteredCardListView calls onPastePlainText instead of onPaste
    4. Shift+double-click in BOTH layout branches of FilteredCardListView calls onPastePlainText
    5. Project compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add paste-as-plain-text to History browser context menu</name>
  <files>
    Pastel/Views/Settings/HistoryGridView.swift
    Pastel/Views/Settings/HistoryBrowserView.swift
  </files>
  <action>
    **Wire a new `onPastePlainText` closure from HistoryBrowserView through HistoryGridView.**

    **Step 1 -- HistoryGridView:** Add a new closure parameter to HistoryGridView:

    1. Add a new private property alongside the existing bulk action closures (around line 33):
    ```swift
    private let onPastePlainText: (ClipboardItem) -> Void
    ```

    2. Update the `init` to accept this new parameter with a default empty closure (to not break the existing call site pattern):
    ```swift
    init(searchText: String, selectedLabelIDs: Set<PersistentIdentifier>, selectedIDs: Binding<Set<PersistentIdentifier>>, resolvedItems: Binding<[ClipboardItem]>, onBulkCopy: @escaping () -> Void = {}, onBulkPaste: @escaping () -> Void = {}, onRequestBulkDelete: @escaping () -> Void = {}, onPastePlainText: @escaping (ClipboardItem) -> Void = { _ in })
    ```

    3. Set `self.onPastePlainText = onPastePlainText` in the init body.

    4. In the single-item context menu (the `else` branch around line 111-130), add "Paste as Plain Text" button AFTER the "Paste" button (line 119) and BEFORE the Divider (line 121):
    ```swift
    Button("Paste") {
        selectedIDs = [item.persistentModelID]
        onBulkPaste()
    }
    Button("Paste as Plain Text") {
        onPastePlainText(item)
    }
    Divider()
    ```
    Note: Do NOT add this to the multi-selection branch (lines 99-110). Bulk paste-as-plain-text is out of scope for Phase 13 per research recommendations.

    **Step 2 -- HistoryBrowserView:** Wire the closure when creating HistoryGridView.

    1. In the HistoryGridView instantiation (around line 44-52), add the `onPastePlainText` parameter:
    ```swift
    HistoryGridView(
        searchText: debouncedSearchText,
        selectedLabelIDs: selectedLabelIDs,
        selectedIDs: $selectedIDs,
        resolvedItems: $resolvedItems,
        onBulkCopy: { bulkCopy() },
        onBulkPaste: { bulkPaste() },
        onRequestBulkDelete: { showDeleteConfirmation = true },
        onPastePlainText: { item in singlePastePlainText(item) }
    )
    ```

    2. Add a new private method `singlePastePlainText` in the `// MARK: - Bulk Actions` section (after `bulkPaste()`, around line 152):
    ```swift
    /// Paste a single item as plain text via AppState (same flow as panel paste-as-plain-text).
    private func singlePastePlainText(_ item: ClipboardItem) {
        guard let panelController = appState.panelController,
              let clipboardMonitor = appState.clipboardMonitor else { return }
        appState.pasteService.pastePlainText(
            item: item,
            clipboardMonitor: clipboardMonitor,
            panelController: panelController
        )
    }
    ```

    IMPORTANT: Check how `appState` exposes `pasteService`, `panelController`, and `clipboardMonitor`. If `pastePlainText` is exposed as a convenience method on AppState directly (e.g., `appState.pastePlainText(item:)`), use that instead. The research indicates `AppState.pastePlainText(item:)` exists at line 195 of AppState.swift. Use:
    ```swift
    private func singlePastePlainText(_ item: ClipboardItem) {
        appState.pastePlainText(item: item)
    }
    ```
    Read AppState.swift to confirm the method signature before implementing.
  </action>
  <verify>
    Run `xcodebuild build -project Pastel.xcodeproj -scheme Pastel -configuration Debug -quiet 2>&1 | tail -5` to confirm compilation succeeds.

    Verify with grep:
    - `grep -n "Paste as Plain Text" Pastel/Views/Settings/HistoryGridView.swift` should return 1 match
    - `grep -n "onPastePlainText" Pastel/Views/Settings/HistoryGridView.swift` should return matches for property, init parameter, and usage
    - `grep -n "singlePastePlainText\|onPastePlainText" Pastel/Views/Settings/HistoryBrowserView.swift` should return matches for the method and the closure
  </verify>
  <done>
    1. HistoryGridView single-item context menu shows "Paste as Plain Text" after "Paste"
    2. Clicking "Paste as Plain Text" in History browser calls through to AppState.pastePlainText
    3. Bulk multi-selection context menu is unchanged (no plain text option for bulk)
    4. Project compiles without errors
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Build verification**: `xcodebuild build` succeeds with zero errors and zero warnings related to paste
2. **HTML bug fix (PAST-23)**: Grep confirms `writeToPasteboardPlainText` has NO `.html` pasteboard write
3. **Context menu (PAST-20)**: "Paste as Plain Text" appears in ClipboardCardView context menu
4. **Shift+Enter (PAST-21)**: `.onKeyPress(.return)` handler checks `.shift` modifier
5. **Shift+double-click (PAST-22)**: Both horizontal and vertical `.onTapGesture(count: 2)` handlers check `NSEvent.modifierFlags.contains(.shift)`
6. **History browser**: HistoryGridView single-item context menu includes "Paste as Plain Text"
7. **No regression**: Existing paste (Enter, double-click, Cmd+1-9) still works via the non-shift code paths
</verification>

<success_criteria>
- All 4 requirements delivered: PAST-23 (HTML bug fix), PAST-20 (context menu), PAST-21 (Shift+Enter), PAST-22 (Shift+double-click)
- Plain text paste writes ONLY .string to pasteboard (no .html, no .rtf)
- Three UI entry points in panel: context menu button, Shift+Enter, Shift+double-click
- One UI entry point in History browser: context menu button
- Zero compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-paste-as-plain-text/13-01-SUMMARY.md`
</output>
