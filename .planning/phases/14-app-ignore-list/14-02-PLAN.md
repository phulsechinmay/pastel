---
phase: 14-app-ignore-list
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - Pastel/Views/Settings/PrivacySettingsView.swift
  - Pastel/Views/Settings/AppPickerView.swift
  - Pastel/Views/Settings/SettingsView.swift
autonomous: true

must_haves:
  truths:
    - "User opens Settings and sees a Privacy tab alongside General, Labels, and History"
    - "User sees a table of ignored apps with Name and Date Added columns, both sortable"
    - "User clicks + button and sees a searchable sheet listing all installed apps"
    - "User selects an app in the picker and it appears in the ignore list table"
    - "User selects a row and presses Delete to remove the app from the ignore list"
    - "User can search/filter the ignore list table by app name"
    - "User can use a file picker button to manually add .app files from non-standard locations"
    - "First time user opens Privacy tab, a prompt offers to add installed password managers"
  artifacts:
    - path: "Pastel/Views/Settings/PrivacySettingsView.swift"
      provides: "Privacy settings tab with ignore list table, controls, and password manager prompt"
      min_lines: 100
    - path: "Pastel/Views/Settings/AppPickerView.swift"
      provides: "Sheet with searchable list of installed apps for adding to ignore list"
      min_lines: 50
    - path: "Pastel/Views/Settings/SettingsView.swift"
      provides: "Updated tab bar with Privacy tab"
      contains: "case privacy"
  key_links:
    - from: "Pastel/Views/Settings/PrivacySettingsView.swift"
      to: "UserDefaults ignoredAppBundleIDs"
      via: "@State + UserDefaults.standard read/write"
      pattern: "ignoredAppBundleIDs"
    - from: "Pastel/Views/Settings/PrivacySettingsView.swift"
      to: "Pastel/Services/AppDiscoveryService.swift"
      via: "AppDiscoveryService.discoverInstalledApps()"
      pattern: "AppDiscoveryService"
    - from: "Pastel/Views/Settings/AppPickerView.swift"
      to: "Pastel/Services/AppDiscoveryService.swift"
      via: "Receives [DiscoveredApp] and filters with search"
      pattern: "DiscoveredApp"
    - from: "Pastel/Views/Settings/SettingsView.swift"
      to: "Pastel/Views/Settings/PrivacySettingsView.swift"
      via: "Tab switch case .privacy -> PrivacySettingsView()"
      pattern: "PrivacySettingsView"
---

<objective>
Build the Privacy settings UI for Phase 14: App Ignore List. This includes the Privacy tab in Settings (table of ignored apps, search, add/remove controls, password manager prompt), an app picker sheet, and wiring the new tab into SettingsView.

Purpose: Users need a visual interface to manage which apps are excluded from clipboard monitoring.
Output: Three files -- new PrivacySettingsView.swift, new AppPickerView.swift, modified SettingsView.swift.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-app-ignore-list/14-RESEARCH.md
@.planning/phases/14-app-ignore-list/14-01-SUMMARY.md

@Pastel/Views/Settings/SettingsView.swift
@Pastel/Views/Settings/GeneralSettingsView.swift
@Pastel/Views/Settings/LabelSettingsView.swift
@Pastel/Services/AppDiscoveryService.swift
@Pastel/Extensions/NSWorkspace+AppIcon.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AppPickerView sheet</name>
  <files>Pastel/Views/Settings/AppPickerView.swift</files>
  <action>
Create `Pastel/Views/Settings/AppPickerView.swift` -- a sheet that shows all installed apps for the user to select from.

**Props/bindings:**
- `let apps: [DiscoveredApp]` -- full list of installed apps (passed from parent, already loaded)
- `let alreadyIgnored: Set<String>` -- bundle IDs already on the ignore list (to dim/disable them)
- `let onSelect: (DiscoveredApp) -> Void` -- callback when user picks an app
- `@Environment(\.dismiss) private var dismiss`

**UI layout:**
- Title: "Add Application" (in a toolbar or as heading)
- Search field at top: `@State private var searchText = ""`
- Scrollable list of apps filtered by searchText (case-insensitive match on app name)
- Each row: HStack with app icon (20x20, via `NSWorkspace.shared.icon(forFile: app.url.path)`) + app name
- Rows for already-ignored apps should be dimmed (`.opacity(0.5)`) and disabled
- Clicking a non-ignored row calls `onSelect(app)` then `dismiss()`
- Cancel button to dismiss without selection
- Frame: `.frame(width: 400, height: 500)` for reasonable sheet size

**App icon loading:**
- Use `NSWorkspace.shared.icon(forFile: app.url.path)` which is fast per-call
- SwiftUI `Image(nsImage:)` with `.resizable().aspectRatio(contentMode: .fit).frame(width: 20, height: 20)`
- LazyVStack inside ScrollView ensures only visible rows render icons

**Search filtering:**
- If searchText is empty, show all apps
- Otherwise filter: `app.name.localizedCaseInsensitiveContains(searchText)`
  </action>
  <verify>Project builds: `xcodebuild -scheme Pastel build 2>&1 | tail -5`</verify>
  <done>AppPickerView.swift exists showing a searchable, scrollable list of installed apps with icons. Already-ignored apps are dimmed. Selecting an app calls the onSelect callback and dismisses the sheet.</done>
</task>

<task type="auto">
  <name>Task 2: Create PrivacySettingsView with ignore list table and password manager prompt</name>
  <files>Pastel/Views/Settings/PrivacySettingsView.swift</files>
  <action>
Create `Pastel/Views/Settings/PrivacySettingsView.swift` -- the Privacy tab content.

**UserDefaults keys (three keys):**
- `"ignoredAppBundleIDs"` -- `[String]` array of bundle IDs
- `"ignoredAppDates"` -- `[String: Double]` dictionary of bundleID -> timeIntervalSince1970
- `"ignoredAppNames"` -- `[String: String]` dictionary of bundleID -> display name (for table display without re-resolving)
- `"hasShownPasswordManagerPrompt"` -- `Bool` flag for one-time prompt

**IgnoredApp display model (private to this file):**
```swift
private struct IgnoredApp: Identifiable, Equatable {
    let bundleID: String
    let name: String
    let dateAdded: Date
    var id: String { bundleID }
}
```

**State:**
- `@State private var ignoredApps: [IgnoredApp] = []` -- loaded from UserDefaults on appear
- `@State private var sortOrder = [KeyPathComparator(\IgnoredApp.name)]` -- default sort by name
- `@State private var selectedApp: IgnoredApp.ID?` -- table selection
- `@State private var searchText = ""` -- filter the ignore list table
- `@State private var showingAppPicker = false` -- sheet toggle
- `@State private var installedApps: [DiscoveredApp] = []` -- loaded once on appear
- `@State private var showingPasswordManagerPrompt = false` -- one-time alert

**Layout (VStack, matching GeneralSettingsView pattern):**

1. **Header area:** HStack with section title "Ignored Applications" + spacer + buttons:
   - "+" button (systemImage "plus") -> sets `showingAppPicker = true`
   - "Browse..." button (or folder icon) -> calls `selectAppManually()` via NSOpenPanel

2. **Search field:** TextField or searchable modifier above the table, bound to `searchText`

3. **Table:** SwiftUI `Table` with selection and sortOrder bindings:
   - Column "Name" (value: `\.name`): custom cell with HStack -- app icon (20x20 via `NSWorkspace.shared.appIcon(forBundleIdentifier:)`) + Text(name)
   - Column "Date Added" (value: `\.dateAdded`): `Text(dateAdded, style: .date)`
   - `.onChange(of: sortOrder)` to re-sort ignoredApps
   - `.onDeleteCommand` to remove selected app
   - Filter by searchText: show only apps where `name.localizedCaseInsensitiveContains(searchText)` (or all if empty)

4. **Empty state:** If ignoredApps is empty and searchText is empty, show centered text: "No ignored applications. Apps on this list will be excluded from clipboard monitoring." with secondary styling.

5. **Hint text at bottom:** `.font(.caption).foregroundStyle(.secondary)` -- "Select an app and press Delete to remove it."

**Sheet (app picker):**
- `.sheet(isPresented: $showingAppPicker)` presenting `AppPickerView(apps: installedApps, alreadyIgnored: Set(ignoredApps.map(\.bundleID)), onSelect: addApp)`

**NSOpenPanel for manual .app selection:**
- Private method `selectAppManually()`:
  - Create NSOpenPanel, set `canChooseDirectories = false`, `allowsMultipleSelection = false`
  - `allowedContentTypes = [.application]` (import UniformTypeIdentifiers)
  - `directoryURL = URL(filePath: "/Applications")`
  - `panel.begin { response in ... }` -- on OK, extract bundle and bundleID, call addApp()

**Add/remove helpers:**
- `addApp(_ app: DiscoveredApp)`:
  - Guard not already in ignoredApps (by bundleID)
  - Create IgnoredApp with current date
  - Append to ignoredApps, re-sort
  - Save to UserDefaults (all three keys)

- `removeSelectedApp()`:
  - Guard selectedApp is set
  - Remove from ignoredApps array
  - Save to UserDefaults
  - Clear selection

- `saveToUserDefaults()`:
  - Write `ignoredApps.map(\.bundleID)` to "ignoredAppBundleIDs"
  - Write date dictionary to "ignoredAppDates" (encode [String: Double] via `Dictionary(uniqueKeysWithValues:)`)
  - Write name dictionary to "ignoredAppNames"

- `loadFromUserDefaults()`:
  - Read bundle IDs, dates dict, names dict
  - Reconstruct [IgnoredApp] array
  - Sort using current sortOrder

**Password manager prompt (one-time):**
- In `.onAppear`:
  1. Call `loadFromUserDefaults()`
  2. Load installed apps: `installedApps = AppDiscoveryService.discoverInstalledApps()`
  3. Check `UserDefaults.standard.bool(forKey: "hasShownPasswordManagerPrompt")` -- if false, set `showingPasswordManagerPrompt = true`
- `.alert("Add installed password managers to ignore list?", isPresented: $showingPasswordManagerPrompt)`:
  - "Yes" button: detect password managers via `AppDiscoveryService.detectInstalledPasswordManagers(from: installedApps)`, add each to ignore list, save. Set the prompt flag to true.
  - "No" button: just set the prompt flag to true (don't show again).
  - Keep the alert text simple -- just the one-liner, no verbose explanation.

**Frame constraints:**
- Match GeneralSettingsView approach: content fills available space
- Table should take up most vertical space (use `.frame(maxHeight: .infinity)` on the Table)
  </action>
  <verify>Project builds: `xcodebuild -scheme Pastel build 2>&1 | tail -5`</verify>
  <done>PrivacySettingsView.swift exists with: (1) sortable Table of ignored apps with icon+name and date columns, (2) search field to filter the table, (3) "+" button opening AppPickerView sheet, (4) Browse button for NSOpenPanel manual .app selection, (5) Delete key removes selected app, (6) one-time password manager prompt on first open, (7) UserDefaults persistence for the ignore list.</done>
</task>

<task type="auto">
  <name>Task 3: Wire Privacy tab into SettingsView</name>
  <files>Pastel/Views/Settings/SettingsView.swift</files>
  <action>
Modify `Pastel/Views/Settings/SettingsView.swift` to add the Privacy tab.

**Changes to SettingsTab enum:**
- Add case `privacy` after `labels` (before `history`, so tab order is: General, Labels, Privacy, History)
- `iconName`: return `"hand.raised"` (SF Symbol for privacy/blocking)
- `displayName`: return `"Privacy"`

**Changes to body:**
- In the `switch selectedTab` block, add `case .privacy: PrivacySettingsView()`
- For frame constraints in the content Group: Privacy tab should use the same fixed-width constraints as General/Labels (NOT the expanding history layout). Add `.privacy` to the conditions alongside `.general` and `.labels`:
  - `maxWidth: (selectedTab == .history) ? .infinity : 500`
  - `maxHeight: (selectedTab == .history) ? .infinity : 600`
  (These conditions already handle general/labels via the else branch; privacy will naturally fall into the same branch since only `.history` is special-cased.)

That's it -- minimal change. The SettingsTab enum drives the tab bar rendering automatically via `ForEach(SettingsTab.allCases)`.
  </action>
  <verify>
1. Project builds: `xcodebuild -scheme Pastel build 2>&1 | tail -5`
2. Read SettingsView.swift and confirm `.privacy` case exists in enum and switch.
  </verify>
  <done>SettingsView.swift has a Privacy tab (hand.raised icon) that renders PrivacySettingsView. Tab appears between Labels and History in the tab bar.</done>
</task>

</tasks>

<verification>
1. `xcodebuild -scheme Pastel build` completes without errors
2. SettingsView.swift has 4 tabs: General, Labels, Privacy, History
3. PrivacySettingsView has a Table with Name and Date Added columns
4. AppPickerView shows searchable list of installed apps
5. Privacy tab shows password manager prompt on first open
6. "+" button opens app picker sheet
7. Delete key removes selected app from ignore list
8. UserDefaults keys "ignoredAppBundleIDs", "ignoredAppDates", "ignoredAppNames" are used
</verification>

<success_criteria>
- Privacy tab is visible in Settings window alongside General, Labels, History
- Ignore list table displays app name (with icon) and date added, both columns sortable
- User can add apps via the searchable app picker sheet
- User can add apps via NSOpenPanel file browser for non-standard locations
- User can remove apps by selecting a row and pressing Delete
- Search field filters the ignore list table by app name
- First-time password manager prompt detects and offers to add installed password managers
- All changes persist to UserDefaults and survive app restart
- ClipboardMonitor reads the same UserDefaults key (from Plan 01) to filter captures
</success_criteria>

<output>
After completion, create `.planning/phases/14-app-ignore-list/14-02-SUMMARY.md`
</output>
