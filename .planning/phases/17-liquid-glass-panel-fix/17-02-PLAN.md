---
phase: 17-liquid-glass-panel-fix
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - Pastel/Views/Panel/PanelController.swift
  - Pastel/App/AppState.swift
autonomous: false

must_haves:
  truths:
    - "Paste-back works correctly: user selects item with Enter, panel hides, content pastes into the previously focused app"
    - "Paste-back plain text works: user presses Shift+Enter, RTF stripped, plain text pastes"
    - "Panel dismisses on click outside panel bounds"
    - "Panel dismisses on Escape key press"
    - "Panel dismisses on Cmd+Tab to another app"
    - "Rapid toggle (Option+V twice quickly) leaves panel in clean hidden state"
    - "Drag from card keeps panel open throughout drag session"
    - "No duplicate clipboard entry created when dropping a dragged card into another app"
    - "Debug activation logs removed from PanelController.show()"
    - "TEMPORARY comment removed from DistributedNotification observer in AppState"
  artifacts:
    - path: "Pastel/Views/Panel/PanelController.swift"
      provides: "Clean show() method without debug timing logs"
      contains: "NSApp.activate()"
    - path: "Pastel/App/AppState.swift"
      provides: "Clean DistributedNotification observer without TEMPORARY comment"
      contains: "app.pastel.togglePanel"
  key_links:
    - from: "PanelController.hide()"
      to: "previousApp?.activate()"
      via: "Returns focus to original app after panel dismiss"
      pattern: "previousApp\\?\\.activate"
    - from: "PasteService.paste()"
      to: "CGEvent Cmd+V"
      via: "250ms delayed paste simulation after panel hide"
      pattern: "simulatePaste"
---

<objective>
Verify all panel dismiss and paste-back behaviors work correctly with the activate-on-show architecture, then clean up debug logging and temporary comments.

Purpose: The activate/deactivate lifecycle changed fundamentally when .nonactivatingPanel was removed. This plan systematically verifies that all dismiss paths (click-outside, Escape, Cmd+Tab), paste-back, and edge cases (rapid toggle, drag) still work. After verification, debug logging is cleaned up for production readiness.
Output: Verified functional behaviors, cleaned-up PanelController.swift and AppState.swift with debug code removed.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-liquid-glass-panel-fix/17-RESEARCH.md
@.planning/phases/17-liquid-glass-panel-fix/17-01-SUMMARY.md
@Pastel/Views/Panel/PanelController.swift
@Pastel/App/AppState.swift
@Pastel/Services/PasteService.swift
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 1: Functional verification of dismiss and paste-back behaviors</name>
  <what-built>The panel activation architecture (NSApp.activate on show, previousApp.activate on hide) was implemented in quick tasks 017/018. Plan 17-01 verified glass renders correctly. This checkpoint verifies the functional behaviors that depend on the activation lifecycle.</what-built>
  <how-to-verify>
Run Pastel from Xcode (Cmd+R). Perform each test below sequentially.

**Test 1: Paste-back via Enter**
1. Open TextEdit, type some text so it is the frontmost app
2. Copy something to clipboard from TextEdit (Cmd+C)
3. Press Option+V to open panel
4. Use arrow keys to select an existing clipboard item
5. Press Enter to paste
6. Expected: Panel hides, content appears in TextEdit at the cursor position
7. Verify TextEdit regained focus (title bar is active, not dimmed)

**Test 2: Paste-back plain text via Shift+Enter**
1. Open Notes.app or TextEdit (rich text mode)
2. Press Option+V to open panel
3. Select a rich text item (if available) or any text item
4. Press Shift+Enter
5. Expected: Panel hides, plain text (no formatting) pastes into the app

**Test 3: Dismiss via click outside**
1. Press Option+V to open panel
2. Click anywhere outside the panel (e.g., on the desktop or another app window)
3. Expected: Panel slides away. The app you clicked on has focus.

**Test 4: Dismiss via Escape**
1. Press Option+V to open panel
2. Press Escape
3. Expected: Panel slides away. The previously focused app regains focus.

**Test 5: Dismiss via Cmd+Tab**
1. Press Option+V to open panel
2. Press Cmd+Tab to switch to another app
3. Expected: Panel slides away. The switched-to app has focus.

**Test 6: Rapid toggle**
1. Press Option+V twice in quick succession (as fast as possible)
2. Expected: Panel shows briefly then hides. No stuck panel, no visual glitches.
3. Press Option+V once more -- panel should show normally.

**Test 7: Drag keeps panel open** (if you have items in history)
1. Press Option+V to open panel
2. Start dragging a card from the panel toward another app (e.g., TextEdit)
3. Expected: Panel stays visible while dragging, even as cursor leaves panel bounds
4. Drop the card into the target app
5. Expected: Content transfers to the target app. Panel remains visible until you dismiss it.

**Test 8: Drag self-capture prevention**
1. Check current item count in panel
2. Drag a text card from panel to TextEdit
3. After drop, press Option+V to reopen panel
4. Expected: No new duplicate entry created from the drag operation

**Evaluate:**
- If ALL tests pass: type "approved"
- If any test fails: describe which test failed and what happened
  </how-to-verify>
  <resume-signal>Type "approved" if all 8 tests pass, or describe which test(s) failed and the observed behavior.</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Clean up debug logging and temporary comments</name>
  <files>
    Pastel/Views/Panel/PanelController.swift
    Pastel/App/AppState.swift
  </files>
  <action>
**PanelController.swift -- Remove debug activation logging from show():**

Remove these lines from the `show()` method (around lines 180-199):

1. Remove: `logger.info("Before activate: isActive=\(NSApp.isActive), isKey=\(panel.isKeyWindow)")`
   (the line right before `NSApp.activate()`)

2. Remove: `logger.info("After activate: isActive=\(NSApp.isActive), isKey=\(panel.isKeyWindow)")`
   (the line right after `NSApp.activate()`)

3. Remove the entire 200ms delayed debug check block:
   ```swift
   DispatchQueue.main.asyncAfter(deadline: .now() + 0.2) { [weak self] in
       self?.logger.info("200ms later: isActive=\(NSApp.isActive), panel.isKey=\(panel.isKeyWindow)")
   }
   ```

4. Remove the entire 500ms delayed debug check block:
   ```swift
   DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) { [weak self] in
       self?.logger.info("500ms later: isActive=\(NSApp.isActive), panel.isKey=\(panel.isKeyWindow)")
   }
   ```

5. ALSO remove the `logger.info("Panel windowNumber (for screencapture -l): \(panel.windowNumber)")` line added in Plan 17-01. This was only needed for the screenshot verification step.

**Keep** the following existing log lines (they are production-useful, not debug):
- `logger.info("Panel shown on \(edge.rawValue) edge of screen: \(screen.localizedName)")` -- useful for debugging user-reported issues
- `logger.info("Panel hidden from \(edge.rawValue) edge")` -- useful for debugging
- All logger lines in createPanel(), handleEdgeChange(), and event monitors

The `show()` method should end up with this structure around the activation area:
```swift
panel.orderFrontRegardless()
panel.makeKey()

// Activate the app so the compositor renders full Liquid Glass.
// LSUIElement = true means no Dock icon or Cmd+Tab entry appears.
NSApp.activate()

NSAnimationContext.runAnimationGroup { context in
    // ... animation code unchanged ...
}

installEventMonitors()
logger.info("Panel shown on \(edge.rawValue) edge of screen: \(screen.localizedName)")
// (no more debug lines after this)
```

**Keep the panelWindowNumber computed property** -- it is useful and harmless. Only remove its log line from show().

**AppState.swift -- Clean up TEMPORARY comment on DistributedNotification observer:**

In `setupPanel()`, find these lines (around lines 92-101):

```swift
// TEMPORARY: Allow toggling panel via DistributedNotification (for automated testing loop)
// Remove after liquid glass fix is verified
DistributedNotificationCenter.default().addObserver(
```

Replace the two comment lines with a proper production comment:

```swift
// Route hotkey-triggered panel toggles through DistributedNotification.
// Carbon RegisterEventHotKey handler context blocks NSApp.activate(),
// so KeyboardShortcuts.onKeyUp dispatches to main queue and this observer
// picks it up with a clean call stack.
DistributedNotificationCenter.default().addObserver(
```

Wait -- looking at the code more carefully, the KeyboardShortcuts.onKeyUp handler (lines 86-90) already dispatches to main queue directly and calls `self?.togglePanel()` directly. It does NOT post a DistributedNotification. The DistributedNotification observer is a SEPARATE entry point. Let me re-read...

Actually, looking at AppState.swift lines 86-101:
- Lines 86-90: `KeyboardShortcuts.onKeyUp(for: .togglePanel)` -- dispatches to main queue, calls `self?.togglePanel()` directly
- Lines 92-101: DistributedNotification observer -- a separate listener for "app.pastel.togglePanel"

These are TWO independent paths. The hotkey uses `KeyboardShortcuts.onKeyUp` with `DispatchQueue.main.async` (not DistributedNotification). The DistributedNotification is an ADDITIONAL path for external triggering (testing, automation).

So the comment should be updated to reflect this:

```swift
// External trigger: allow toggling panel via DistributedNotification.
// Used by automated tests and CLI:
//   swift -e 'import Foundation; DistributedNotificationCenter.default().post(name: .init("app.pastel.togglePanel"), object: nil)'
DistributedNotificationCenter.default().addObserver(
```

This accurately describes what the observer does and why it exists, without the misleading "TEMPORARY" or "Remove after" language.

**Build and verify:**
Run `xcodebuild build -scheme Pastel -destination 'platform=macOS'` to confirm zero errors after cleanup.
  </action>
  <verify>
1. `xcodebuild build -scheme Pastel -destination 'platform=macOS'` completes with zero errors
2. Grep PanelController.swift for "200ms later" -- should return no results
3. Grep PanelController.swift for "500ms later" -- should return no results
4. Grep PanelController.swift for "Before activate" -- should return no results
5. Grep PanelController.swift for "After activate" -- should return no results
6. Grep PanelController.swift for "screencapture" -- should return no results in log lines (property comment is fine)
7. Grep AppState.swift for "TEMPORARY" -- should return no results
8. Grep AppState.swift for "Remove after" -- should return no results
9. Grep AppState.swift for "External trigger" -- should return one result (the new comment)
  </verify>
  <done>
Debug activation logging removed from PanelController.show() (6 lines removed: 2 immediate logs, 2 delayed blocks, 1 window number log). TEMPORARY comment on DistributedNotification observer in AppState replaced with accurate production comment. panelWindowNumber property retained. Project builds with zero errors.
  </done>
</task>

</tasks>

<verification>
1. All 8 functional tests pass (paste-back, dismiss paths, rapid toggle, drag)
2. `xcodebuild build -scheme Pastel -destination 'platform=macOS'` zero errors after cleanup
3. No debug activation logs remain in PanelController.show()
4. No "TEMPORARY" comments remain in AppState.swift
5. Production log lines preserved (panel shown/hidden on edge)
</verification>

<success_criteria>
- Paste-back works: Enter pastes, Shift+Enter pastes plain text, previous app regains focus
- All dismiss paths work: click outside, Escape, Cmd+Tab
- Rapid toggle does not leave panel stuck or in inconsistent state
- Drag keeps panel open and does not create duplicate clipboard entries
- Debug logging cleaned up: no activation state logs, no TEMPORARY comments
- Project builds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/17-liquid-glass-panel-fix/17-02-SUMMARY.md`
</output>
