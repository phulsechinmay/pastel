---
phase: 04-organization
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - Pastel/Views/Panel/ClipboardCardView.swift
  - Pastel/Views/Panel/PanelContentView.swift
  - Pastel/Views/MenuBar/StatusPopoverView.swift
  - Pastel/Services/ClipboardMonitor.swift
autonomous: true

must_haves:
  truths:
    - "User right-clicks a card and selects Delete -- item disappears from history"
    - "Deleting an image item also removes image and thumbnail files from disk"
    - "Deleting a concealed item cancels its pending expiration timer"
    - "User can clear all clipboard history from the menu bar popover"
    - "Clear all shows a confirmation dialog before proceeding"
    - "Clear all removes all items, cleans up all image files, and resets item count"
  artifacts:
    - path: "Pastel/Views/Panel/ClipboardCardView.swift"
      provides: "Context menu Delete action with full cleanup"
      contains: "deleteItem"
    - path: "Pastel/Views/MenuBar/StatusPopoverView.swift"
      provides: "Clear All History button with confirmation"
      contains: "Clear All"
  key_links:
    - from: "Pastel/Views/Panel/ClipboardCardView.swift"
      to: "Pastel/Services/ImageStorageService.swift"
      via: "deleteImage called before modelContext.delete"
      pattern: "ImageStorageService.*deleteImage"
    - from: "Pastel/Views/MenuBar/StatusPopoverView.swift"
      to: "Pastel/Services/ClipboardMonitor.swift"
      via: "clearAllHistory resets itemCount and cleans images"
      pattern: "clearAllHistory"
---

<objective>
Implement robust deletion for individual items and clear-all-history, with proper cleanup of image files, expiration timers, and item count.

Purpose: Completes ORGN-05 (individual delete) and ORGN-06 (clear all). The basic delete added in Plan 02's context menu is upgraded with image cleanup and expiration cancellation. Clear all is added to the menu bar popover with a danger-styled confirmation.

Output: Full delete lifecycle (image cleanup + expiration cancel + SwiftData delete), clear all history button in status popover with confirmation dialog.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-organization/04-CONTEXT.md
@.planning/phases/04-organization/04-RESEARCH.md
@.planning/phases/04-organization/04-02-SUMMARY.md

@Pastel/Views/Panel/ClipboardCardView.swift
@Pastel/Views/Panel/PanelContentView.swift
@Pastel/Views/MenuBar/StatusPopoverView.swift
@Pastel/Services/ClipboardMonitor.swift
@Pastel/Services/ExpirationService.swift
@Pastel/Services/ImageStorageService.swift
@Pastel/App/AppState.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Robust individual delete with image cleanup and expiration cancellation</name>
  <files>
    Pastel/Views/Panel/ClipboardCardView.swift
    Pastel/Services/ClipboardMonitor.swift
  </files>
  <action>
    1. Expose ExpirationService from ClipboardMonitor:
       - In `ClipboardMonitor.swift`, change `private let expirationService` to `let expirationService` (remove `private`)
       - This allows deletion code to cancel pending expirations for concealed items

    2. Upgrade the delete action in `ClipboardCardView.swift` context menu:
       - Plan 02 added a basic `modelContext.delete(item); try? modelContext.save()` in the Delete button
       - Replace with a proper `deleteItem` function that:
         a. Calls `ImageStorageService.shared.deleteImage(imagePath: item.imagePath, thumbnailPath: item.thumbnailPath)` to clean up disk files
         b. Cancels pending expiration if item is concealed: need access to ExpirationService. Since ClipboardCardView is a SwiftUI view inside the panel, it needs a way to reach ClipboardMonitor's expirationService.
         c. Approach: Add an `onDelete: ((ClipboardItem) -> Void)?` callback to ClipboardCardView, similar to the existing `onPaste` pattern. The Delete button in the context menu calls `onDelete?(item)`. The actual deletion logic lives in PanelContentView (or a parent) which has access to AppState via environment.
         d. Alternatively (simpler): perform image cleanup directly in ClipboardCardView (ImageStorageService.shared is accessible), skip expiration cancellation in the view (concealed items auto-expire in 60s anyway -- if deleted early, the expiration timer will find the item already gone and no-op safely via the `guard let item = modelContext.model(for: itemID)` check in ExpirationService.performExpiration).
         e. DECISION: Use the simpler approach. In the Delete button action:
            - `ImageStorageService.shared.deleteImage(imagePath: item.imagePath, thumbnailPath: item.thumbnailPath)`
            - `modelContext.delete(item)`
            - `try? modelContext.save()`
         f. The ExpirationService timer will harmlessly no-op when it fires for a deleted item (already handled in existing code).

    Anti-patterns to avoid:
    - Do NOT forget image cleanup before SwiftData delete -- orphaned files waste disk space
    - Do NOT add complex callback chains just for expiration cancellation -- the existing guard-let in ExpirationService handles this gracefully
  </action>
  <verify>
    `cd /Users/phulsechinmay/Desktop/Projects/pastel && xcodebuild -scheme Pastel -destination 'platform=macOS' build 2>&1 | tail -5` -- must show BUILD SUCCEEDED
  </verify>
  <done>Delete context menu action cleans up image files from disk before removing item from SwiftData. Orphaned expiration timers are handled by existing guard in ExpirationService.</done>
</task>

<task type="auto">
  <name>Task 2: Clear all history button in status popover with confirmation</name>
  <files>
    Pastel/Views/MenuBar/StatusPopoverView.swift
    Pastel/App/AppState.swift
  </files>
  <action>
    1. Add `clearAllHistory` method to `AppState.swift`:
       - Accept `modelContext: ModelContext` parameter
       - Step 1: Fetch all ClipboardItems to collect image paths:
         `let descriptor = FetchDescriptor<ClipboardItem>()`
         `let allItems = try modelContext.fetch(descriptor)`
       - Step 2: Delete all image files from disk:
         `for item in allItems { ImageStorageService.shared.deleteImage(imagePath: item.imagePath, thumbnailPath: item.thumbnailPath) }`
       - Step 3: Batch delete all items:
         `try modelContext.delete(model: ClipboardItem.self)`
         `try modelContext.save()`
       - Step 4: Reset clipboardMonitor itemCount to 0:
         `clipboardMonitor?.itemCount = 0`
       - Wrap in do/catch, rollback on failure
       - Note: Do NOT delete Labels -- they are reusable (per CONTEXT.md: "optionally keep Labels (they are reusable)")
       - Note: Pending expiration timers will harmlessly no-op when they fire (items already deleted)

    2. Add clear all button to `StatusPopoverView.swift`:
       - Read the existing StatusPopoverView first to understand its current layout
       - Add a `@State private var showingClearConfirmation = false` state
       - Add a "Clear All History" button styled with red foreground color (`role: .destructive` or `.foregroundColor(.red)`)
       - Place it below the existing content, separated by a Divider
       - On tap, set `showingClearConfirmation = true`
       - Use `.confirmationDialog` or `.alert` modifier:
         - Title: "Clear All History"
         - Message: "This will permanently delete all clipboard items. This action cannot be undone."
         - Destructive action button: "Clear All" -- calls `appState.clearAllHistory(modelContext: modelContext)`
         - Cancel button: "Cancel"
       - Add `@Environment(\.modelContext) private var modelContext` if not already present

    Anti-patterns to avoid:
    - Do NOT delete Labels during clear all -- they are reusable organizational tools
    - Do NOT skip the confirmation dialog -- clear all is destructive and irreversible
    - Do NOT forget to reset itemCount on ClipboardMonitor after clearing
    - Do NOT forget to fetch items BEFORE batch delete to collect image paths for cleanup
  </action>
  <verify>
    `cd /Users/phulsechinmay/Desktop/Projects/pastel && xcodebuild -scheme Pastel -destination 'platform=macOS' build 2>&1 | tail -5` -- must show BUILD SUCCEEDED
  </verify>
  <done>Clear All History button appears in status popover with red styling. Confirmation dialog appears on tap. Confirming deletes all items, cleans up all images from disk, resets item count. Labels are preserved.</done>
</task>

</tasks>

<verification>
1. Build succeeds: `xcodebuild -scheme Pastel -destination 'platform=macOS' build`
2. Delete context menu action removes item from list AND deletes image files from disk
3. StatusPopoverView has "Clear All History" button with red styling
4. Confirmation dialog appears before clear all executes
5. After clear all: item list is empty, image files are deleted, item count shows 0
6. Labels survive clear all (still appear in chip bar)
7. ExpirationService gracefully handles deleted items (no crashes)
</verification>

<success_criteria>
- Individual delete removes item + cleans up disk images
- Clear all history has destructive confirmation dialog
- Clear all deletes all items, all images, resets count
- Labels persist through clear all
- No orphaned image files after deletion
- Build succeeds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-organization/04-03-SUMMARY.md`
</output>
