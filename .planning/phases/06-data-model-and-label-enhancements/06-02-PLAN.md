---
phase: 06-data-model-and-label-enhancements
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - Pastel/Views/Settings/LabelSettingsView.swift
  - Pastel/Views/Panel/ChipBarView.swift
  - Pastel/Views/Panel/ClipboardCardView.swift
autonomous: true

must_haves:
  truths:
    - "User assigns an emoji to a label and the emoji replaces the color dot in chip bar and card headers"
    - "User opens the system emoji picker from label settings to choose an emoji"
    - "User clears an emoji and the color dot returns"
    - "User opens label settings and sees 12 color options in a 2-row grid in the create-label popover"
  artifacts:
    - path: "Pastel/Views/Settings/LabelSettingsView.swift"
      provides: "Emoji input field with system picker button in LabelRow"
      contains: "orderFrontCharacterPalette"
    - path: "Pastel/Views/Panel/ChipBarView.swift"
      provides: "Emoji-or-dot rendering in label chips and 2-row color grid in popover"
      contains: "label.emoji"
    - path: "Pastel/Views/Panel/ClipboardCardView.swift"
      provides: "Emoji-or-dot rendering in context menu label submenu"
      contains: "label.emoji"
  key_links:
    - from: "Pastel/Views/Settings/LabelSettingsView.swift"
      to: "Label.emoji"
      via: "Binding that truncates to single grapheme cluster"
      pattern: "prefix\\(1\\)"
    - from: "Pastel/Views/Panel/ChipBarView.swift"
      to: "Label.emoji"
      via: "Conditional rendering: emoji Text or color Circle"
      pattern: "label\\.emoji"
    - from: "Pastel/Views/Panel/ClipboardCardView.swift"
      to: "Label.emoji"
      via: "Conditional rendering in context menu label items"
      pattern: "label\\.emoji"
---

<objective>
Add emoji support to labels with input in settings, and render emoji-or-dot everywhere labels appear.

Purpose: Users can personalize labels with emoji that replace the generic color dots, making labels more recognizable at a glance in the chip bar and card context menus.

Output: Emoji input field with system picker in LabelSettingsView, emoji-or-dot rendering in ChipBarView chips and ClipboardCardView context menu, 2-row color grid in create-label popover.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-data-model-and-label-enhancements/06-RESEARCH.md
@.planning/phases/06-data-model-and-label-enhancements/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Emoji input in LabelSettingsView and color grid update</name>
  <files>
    Pastel/Views/Settings/LabelSettingsView.swift
  </files>
  <action>
    Modify the `LabelRow` struct in LabelSettingsView.swift to add an emoji input field.

    **Add emoji input to LabelRow:**

    In the LabelRow HStack (between the color dot menu and the name field), add an emoji input section:

    1. Add a `@FocusState private var isEmojiFieldFocused: Bool` to LabelRow.

    2. Create a computed binding for the emoji field that truncates to a single grapheme cluster:

    ```swift
    private var emojiBinding: Binding<String> {
        Binding(
            get: { label.emoji ?? "" },
            set: { newValue in
                let trimmed = newValue.trimmingCharacters(in: .whitespacesAndNewlines)
                label.emoji = trimmed.isEmpty ? nil : String(trimmed.prefix(1))
                try? modelContext.save()
            }
        )
    }
    ```

    3. In the HStack, after the color dot Menu and before the name field, insert:

    ```swift
    // Emoji input
    HStack(spacing: 2) {
        TextField("", text: emojiBinding)
            .textFieldStyle(.plain)
            .frame(width: 24)
            .multilineTextAlignment(.center)
            .focused($isEmojiFieldFocused)

        Button {
            isEmojiFieldFocused = true
            // Small delay to ensure TextField gains focus before picker opens
            DispatchQueue.main.asyncAfter(deadline: .now() + 0.1) {
                NSApp.orderFrontCharacterPalette(nil)
            }
        } label: {
            Image(systemName: "face.smiling")
                .font(.system(size: 12))
                .foregroundStyle(.secondary)
        }
        .buttonStyle(.plain)
        .help("Open emoji picker (or press Ctrl+Cmd+Space in the emoji field)")
    }
    ```

    The `.focused` + small delay pattern ensures the TextField has first responder status when the emoji picker opens, so the selected emoji is inserted into the correct field.

    4. Also update the color dot Menu label to show emoji-or-dot. Replace the current Menu label:

    From:
    ```swift
    } label: {
        Circle()
            .fill(LabelColor(rawValue: label.colorName)?.color ?? .gray)
            .frame(width: 14, height: 14)
    }
    ```

    To:
    ```swift
    } label: {
        if let emoji = label.emoji, !emoji.isEmpty {
            Text(emoji)
                .font(.system(size: 14))
        } else {
            Circle()
                .fill(LabelColor(rawValue: label.colorName)?.color ?? .gray)
                .frame(width: 14, height: 14)
        }
    }
    ```

    This way the color menu button itself reflects whether the label uses an emoji or a color dot.

    **Color palette in LabelSettingsView:**
    The color menu in LabelRow is a dropdown Menu (not a grid), so it handles 12 items natively with no layout changes needed. No changes required here beyond what was already done in 06-01 (LabelColor.allCases now has 12 items and the ForEach iterates them all).
  </action>
  <verify>
    Build: `xcodebuild -project Pastel.xcodeproj -scheme Pastel build 2>&1 | tail -20`. Must succeed.

    Manual check: Launch app, open Settings > Labels. For each label row:
    - Emoji field visible between color dot and name
    - Type an emoji in the field -- it replaces the color dot in the Menu label
    - Click smiley button -- system emoji picker opens
    - Select emoji from picker -- it appears in the field
    - Clear the emoji field (select all + delete) -- color dot returns
    - Type multiple characters -- only the first grapheme cluster is kept
  </verify>
  <done>
    LabelSettingsView has emoji input per label row. System emoji picker accessible via button. Single-character truncation works. Emoji-or-dot renders in the color menu label.
  </done>
</task>

<task type="auto">
  <name>Task 2: Emoji-or-dot rendering in ChipBarView and ClipboardCardView</name>
  <files>
    Pastel/Views/Panel/ChipBarView.swift
    Pastel/Views/Panel/ClipboardCardView.swift
  </files>
  <action>
    **ChipBarView.swift** -- Update label chips to show emoji instead of color dot when set.

    1. In `labelChip(for:)`, replace the Circle() inside the HStack with conditional emoji-or-dot rendering:

    From:
    ```swift
    HStack(spacing: 4) {
        Circle()
            .fill(LabelColor(rawValue: label.colorName)?.color ?? .gray)
            .frame(width: 8, height: 8)

        Text(label.name)
            .font(.caption)
            .lineLimit(1)
    }
    ```

    To:
    ```swift
    HStack(spacing: 4) {
        if let emoji = label.emoji, !emoji.isEmpty {
            Text(emoji)
                .font(.system(size: 10))
        } else {
            Circle()
                .fill(LabelColor(rawValue: label.colorName)?.color ?? .gray)
                .frame(width: 8, height: 8)
        }

        Text(label.name)
            .font(.caption)
            .lineLimit(1)
    }
    ```

    2. Update the create-label popover color palette to use a 2-row grid layout (6 colors per row) instead of a single HStack, since 12 colors in a row is too wide:

    Replace the color palette HStack in `createLabelPopover`:

    From:
    ```swift
    // Color palette
    HStack(spacing: 6) {
        ForEach(LabelColor.allCases, id: \.self) { labelColor in
            Circle()
                .fill(labelColor.color)
                .frame(width: 20, height: 20)
                .overlay(
                    Circle()
                        .strokeBorder(
                            newLabelColor == labelColor ? Color.white : Color.clear,
                            lineWidth: 2
                        )
                )
                .onTapGesture {
                    newLabelColor = labelColor
                }
        }
    }
    ```

    To:
    ```swift
    // Color palette (6x2 grid)
    let columns = Array(repeating: GridItem(.fixed(20), spacing: 6), count: 6)
    LazyVGrid(columns: columns, spacing: 6) {
        ForEach(LabelColor.allCases, id: \.self) { labelColor in
            Circle()
                .fill(labelColor.color)
                .frame(width: 20, height: 20)
                .overlay(
                    Circle()
                        .strokeBorder(
                            newLabelColor == labelColor ? Color.white : Color.clear,
                            lineWidth: 2
                        )
                )
                .onTapGesture {
                    newLabelColor = labelColor
                }
        }
    }
    ```

    Adjust the popover width if needed -- the `.frame(width: 180)` on the TextField should still work since a 6x2 grid of 20pt circles with 6pt spacing = ~146pt wide, which fits within 180pt.

    **ClipboardCardView.swift** -- Update the context menu label submenu to show emoji-or-dot.

    In the context menu's `Menu("Label")` section, find the ForEach that renders label items. Replace the Circle() with conditional emoji-or-dot:

    From:
    ```swift
    HStack {
        Circle()
            .fill(LabelColor(rawValue: label.colorName)?.color ?? .gray)
            .frame(width: 8, height: 8)
        Text(label.name)
        if item.label?.persistentModelID == label.persistentModelID {
            Image(systemName: "checkmark")
        }
    }
    ```

    To:
    ```swift
    HStack {
        if let emoji = label.emoji, !emoji.isEmpty {
            Text(emoji)
                .font(.system(size: 10))
        } else {
            Circle()
                .fill(LabelColor(rawValue: label.colorName)?.color ?? .gray)
                .frame(width: 8, height: 8)
        }
        Text(label.name)
        if item.label?.persistentModelID == label.persistentModelID {
            Image(systemName: "checkmark")
        }
    }
    ```
  </action>
  <verify>
    Build: `xcodebuild -project Pastel.xcodeproj -scheme Pastel build 2>&1 | tail -20`. Must succeed.

    Manual checks:
    1. Open panel -- chip bar shows emoji instead of color dot for labels that have emoji set
    2. Labels without emoji still show color dot as before
    3. Right-click a clipboard card -- label submenu shows emoji-or-dot for each label
    4. Click "+" in chip bar -- create-label popover shows 12 colors in a 6x2 grid
    5. Create a label with a new color (e.g., mint) -- chip renders correctly
  </verify>
  <done>
    ChipBarView label chips render emoji-or-dot. ClipboardCardView context menu label items render emoji-or-dot. Create-label popover shows 12 colors in a 2-row grid. All label rendering is consistent across the app.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild -project Pastel.xcodeproj -scheme Pastel build` succeeds with 0 errors
2. Open Settings > Labels, create a label, assign an emoji via the smiley button -- emoji picker opens and emoji is inserted
3. Type multiple characters in emoji field -- truncated to single grapheme cluster
4. Clear emoji -- color dot returns in all locations
5. Open panel -- chip bar shows emoji for labels with emoji, dot for labels without
6. Right-click card -- context menu label submenu shows emoji-or-dot
7. Click "+" in chip bar -- create-label popover shows 12 colors in 6x2 grid
</verification>

<success_criteria>
- Emoji can be assigned and cleared on any label
- System emoji picker opens from the smiley button
- Emoji replaces color dot in chip bar, context menu, and settings
- 12-color grid renders in create-label popover
- Single grapheme cluster enforcement prevents multi-character input
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-model-and-label-enhancements/06-02-SUMMARY.md`
</output>
