---
phase: 08-url-preview-cards
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - Pastel/Views/Panel/URLCardView.swift
  - Pastel/Views/Panel/ClipboardCardView.swift
  - Pastel/Views/Settings/GeneralSettingsView.swift
  - Pastel/Services/RetentionService.swift
  - Pastel/App/AppState.swift
autonomous: false

must_haves:
  truths:
    - "User copies a URL with og:image and sees the preview image as a full-width banner above favicon + title"
    - "User copies a URL without og:image and sees a compact card with just favicon + title row"
    - "User copies a URL and while metadata loads sees the existing plain URL card with a spinner"
    - "User copies a URL and the card animates smoothly from plain to enriched state"
    - "User disables URL metadata fetching in Settings and newly copied URLs stay as plain URL cards"
    - "Expired URL items have their cached favicon and og:image files cleaned up from disk"
  artifacts:
    - path: "Pastel/Views/Panel/URLCardView.swift"
      provides: "Rich URL card with og:image banner, favicon + title footer, loading state, progressive animation"
      min_lines: 80
    - path: "Pastel/Views/Settings/GeneralSettingsView.swift"
      provides: "Toggle for fetchURLMetadata setting"
    - path: "Pastel/Services/RetentionService.swift"
      provides: "Cleanup of urlFaviconPath and urlPreviewImagePath files on purge"
    - path: "Pastel/Views/Panel/ClipboardCardView.swift"
      provides: "Updated min height for URL cards with banners"
  key_links:
    - from: "Pastel/Views/Panel/URLCardView.swift"
      to: "ClipboardItem.urlTitle"
      via: "reads urlTitle, urlFaviconPath, urlPreviewImagePath, urlMetadataFetched"
      pattern: "item\\.url(Title|FaviconPath|PreviewImagePath|MetadataFetched)"
    - from: "Pastel/Views/Panel/URLCardView.swift"
      to: "Pastel/Services/ImageStorageService.swift"
      via: "resolves favicon and og:image filenames to disk URLs"
      pattern: "ImageStorageService.*resolveImageURL"
    - from: "Pastel/Views/Settings/GeneralSettingsView.swift"
      to: "UserDefaults fetchURLMetadata"
      via: "@AppStorage binding"
      pattern: "fetchURLMetadata"
    - from: "Pastel/Services/RetentionService.swift"
      to: "ImageStorageService.deleteImage"
      via: "deletes favicon and og:image files during purge"
      pattern: "urlFaviconPath|urlPreviewImagePath"
---

<objective>
Redesign URLCardView to show rich preview cards with og:image banner, favicon + title footer, loading spinner, and smooth animation. Add Settings toggle for URL metadata fetching. Extend RetentionService to clean up cached metadata images.

Purpose: Transforms plain URL text cards into rich link previews (like iMessage/Slack). This is the user-facing half of the URL preview feature -- Plan 01 provided the data, this plan renders it beautifully.

Output: Enhanced URLCardView.swift, updated GeneralSettingsView.swift (toggle), updated RetentionService.swift (cleanup), updated ClipboardCardView.swift (height adjustment), updated AppState.swift (clear-all cleanup).
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-url-preview-cards/08-CONTEXT.md
@.planning/phases/08-url-preview-cards/08-01-SUMMARY.md

Key source files:
@Pastel/Views/Panel/URLCardView.swift — Current plain URL card (globe icon + blue text)
@Pastel/Views/Panel/ClipboardCardView.swift — Card dispatcher with min height and routing
@Pastel/Views/Panel/ImageCardView.swift — Pattern for async image display
@Pastel/Views/Panel/AsyncThumbnailView.swift — Pattern for loading images from disk
@Pastel/Views/Settings/GeneralSettingsView.swift — Where to add the toggle
@Pastel/Services/RetentionService.swift — Needs favicon/og:image cleanup
@Pastel/Models/ClipboardItem.swift — urlTitle, urlFaviconPath, urlPreviewImagePath, urlMetadataFetched fields
</context>

<tasks>

<task type="auto">
  <name>Task 1: Redesign URLCardView with rich preview layout</name>
  <files>
    Pastel/Views/Panel/URLCardView.swift
    Pastel/Views/Panel/ClipboardCardView.swift
  </files>
  <action>
  Completely rewrite `Pastel/Views/Panel/URLCardView.swift` to implement the rich URL preview card per CONTEXT.md decisions.

  **Header row (RICH-07 compliance -- consistent with all other card types):**
  The existing header row showing the source app icon + timestamp MUST remain at the top of every URL card, in ALL states (loading, enriched, failed). This header row is rendered by ClipboardCardView above the card-specific content, so URLCardView does NOT need to render it -- but the URLCardView content must be designed to sit BELOW the header row. Do NOT hide or remove the header. Verify that ClipboardCardView's header row (source app icon + timestamp) renders above URLCardView's content, consistent with how ImageCardView, CodeCardView, and ColorCardView all display beneath the shared header.

  **URLCardView layout (3 states):**

  **State 1: Loading (urlMetadataFetched == nil)**
  - Show existing plain URL card layout (globe + URL text in blue) with a small ProgressView spinner
  - Spinner placement: trailing edge of the URL text row, or bottom-right corner. Keep it subtle (12pt).
  - This state is brief (metadata fetches within seconds)

  **State 2: Enriched (urlMetadataFetched == true)**
  The full rich card. Structure top to bottom:

  a) **og:image banner** (only if urlPreviewImagePath is non-nil):
     - Full-width image spanning the card content area
     - Fixed 2:1 aspect ratio (e.g., width fills card, height = width / 2)
     - Image cropped to fill (`.scaledToFill()` + `.clipped()`)
     - Load image from disk via `ImageStorageService.shared.resolveImageURL(path)`
     - Use `AsyncImage`-like pattern: load NSImage from the file URL in a .task modifier, store in @State
     - Rounded top corners (6pt) for the banner

  b) **Favicon + title row** (always shown when enriched):
     - HStack: favicon image (16pt) + title text
     - Favicon: load from disk via urlFaviconPath. If nil or missing, use SF Symbol "globe" as placeholder (16pt, .secondary color)
     - Title: `item.urlTitle ?? ""`, single line, truncated with ellipsis, .callout font
     - Title foreground: .primary (not blue -- the enriched card uses standard text)

  c) **Raw URL text is HIDDEN** when enriched (per CONTEXT.md: "Raw URL text hidden once metadata loads")

  **State 3: Failed (urlMetadataFetched == false)**
  - Fall back to existing plain URL card: globe icon + URL text in blue
  - No spinner (fetch already completed and failed)

  **Transitions and animation:**
  - Use `.animation(.easeInOut(duration: 0.3), value: item.urlMetadataFetched)` on the card content
  - The card height animates open as the banner appears (SwiftUI handles this naturally with frame changes)
  - Content fades in with `.transition(.opacity)` on the enriched content

  **Progressive reveal (per CONTEXT.md):**
  - Favicon + title appear immediately when urlTitle is set (even if og:image is still saving)
  - Banner image appears when urlPreviewImagePath is set
  - Since URLMetadataService saves everything at once, the progressive feel comes from the image load from disk being slightly slower than text rendering

  **Horizontal panel adaptation:**
  - Keep the isHorizontal check from current code
  - In horizontal mode, the banner should still be full-width of the card (260pt fixed width from FilteredCardListView)

  **Image loading from disk:**
  - Create a private helper or use @State + .task pattern:
    ```swift
    @State private var bannerImage: NSImage?
    @State private var faviconImage: NSImage?

    .task(id: item.urlPreviewImagePath) {
        guard let path = item.urlPreviewImagePath else { bannerImage = nil; return }
        let url = ImageStorageService.shared.resolveImageURL(path)
        bannerImage = NSImage(contentsOf: url)
    }
    .task(id: item.urlFaviconPath) {
        guard let path = item.urlFaviconPath else { faviconImage = nil; return }
        let url = ImageStorageService.shared.resolveImageURL(path)
        faviconImage = NSImage(contentsOf: url)
    }
    ```

  **ClipboardCardView.swift update:**
  - Update `cardMinHeight` to account for URL cards with banners: URL cards with og:image need more height
  - Change the minHeight logic: `item.type == .image ? 120 : (item.type == .url && item.urlPreviewImagePath != nil ? 140 : 80)`
  - Also consider the maxHeight (currently 195) -- URL cards with banners may need up to 195pt, which is already the max. This should be fine since the 2:1 banner at ~260pt width = ~130pt height + favicon row ~24pt + padding = ~170pt total. Fits within 195.
  </action>
  <verify>
  Build succeeds: `cd /Users/phulsechinmay/Desktop/Projects/pastel && xcodebuild -project Pastel.xcodeproj -scheme Pastel -configuration Debug build 2>&1 | tail -5`

  Verify URLCardView has enriched layout:
  - grep for "urlMetadataFetched" in URLCardView.swift
  - grep for "urlPreviewImagePath" in URLCardView.swift
  - grep for "urlFaviconPath" in URLCardView.swift
  - grep for "ProgressView" in URLCardView.swift (loading spinner)
  - grep for "resolveImageURL" in URLCardView.swift
  </verify>
  <done>
  URLCardView shows 3 states: loading (plain card + spinner), enriched (og:image banner + favicon + title), failed (plain URL fallback). The header row (source app icon + timestamp) remains visible above the card content in all states, consistent with other card types. Images load from disk. Animations smooth the transition. ClipboardCardView min height adjusted for URL banner cards. Build compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Settings toggle and RetentionService cleanup</name>
  <files>
    Pastel/Views/Settings/GeneralSettingsView.swift
    Pastel/Services/RetentionService.swift
    Pastel/App/AppState.swift
  </files>
  <action>
  **GeneralSettingsView.swift -- Add URL metadata toggle:**

  Add a new section between "History Retention" and "Paste Behavior" (or after Paste Behavior -- wherever it fits best in the visual flow). Add:

  ```swift
  Divider()

  // 6. URL Previews
  VStack(alignment: .leading, spacing: 6) {
      Text("URL Previews")
          .font(.headline)
      Toggle("Fetch page title, favicon, and preview image for copied URLs", isOn: $fetchURLMetadata)
          .toggleStyle(.switch)
      Text("When disabled, URL cards show only the raw link text.")
          .font(.caption)
          .foregroundStyle(.secondary)
  }
  ```

  Add the @AppStorage binding:
  ```swift
  @AppStorage("fetchURLMetadata") private var fetchURLMetadata: Bool = true
  ```

  Default is `true` (enabled) -- users opt OUT if they don't want fetching.

  **RetentionService.swift -- Clean up URL metadata images:**

  In the `purgeExpiredItems()` method, inside the loop that deletes associated image files (lines ~68-72), add cleanup for URL metadata images:

  ```swift
  // Delete associated image files from disk
  for item in expiredItems {
      ImageStorageService.shared.deleteImage(
          imagePath: item.imagePath,
          thumbnailPath: item.thumbnailPath
      )
      // Clean up URL metadata cached images
      ImageStorageService.shared.deleteImage(
          imagePath: item.urlFaviconPath,
          thumbnailPath: item.urlPreviewImagePath
      )
  }
  ```

  This reuses the existing deleteImage method which accepts optional strings and handles nil gracefully. The parameter names (imagePath/thumbnailPath) are slightly misleading for favicon/preview but the method just deletes files by filename from the images directory -- it works for any file there.

  **AppState.swift -- Clean up URL metadata images on clear-all:**

  In `Pastel/App/AppState.swift`, inside the `clearAllHistory` method, after the existing `deleteImage(imagePath:thumbnailPath:)` call, add:
  ```swift
  // Clean up URL metadata cached images
  ImageStorageService.shared.deleteImage(
      imagePath: item.urlFaviconPath,
      thumbnailPath: item.urlPreviewImagePath
  )
  ```

  **ClipboardCardView.swift -- Clean up URL metadata images on individual delete:**

  In ClipboardCardView's deleteItem method (already in Task 1's file scope), after the existing `deleteImage(imagePath:, thumbnailPath:)` call, add:
  ```swift
  // Clean up URL metadata cached images
  ImageStorageService.shared.deleteImage(
      imagePath: item.urlFaviconPath,
      thumbnailPath: item.urlPreviewImagePath
  )
  ```

  Summary of all cleanup points:
  1. RetentionService.purgeExpiredItems -- periodic auto-purge
  2. AppState.clearAllHistory -- "clear all" action
  3. ClipboardCardView.deleteItem -- individual delete

  All three need the same two-line addition.
  </action>
  <verify>
  Build succeeds: `cd /Users/phulsechinmay/Desktop/Projects/pastel && xcodebuild -project Pastel.xcodeproj -scheme Pastel -configuration Debug build 2>&1 | tail -5`

  Verify Settings toggle:
  - grep for "fetchURLMetadata" in GeneralSettingsView.swift
  - grep for "URL Previews" in GeneralSettingsView.swift

  Verify RetentionService cleanup:
  - grep for "urlFaviconPath" in RetentionService.swift
  - grep for "urlPreviewImagePath" in RetentionService.swift

  Verify individual delete cleanup:
  - grep for "urlFaviconPath" in ClipboardCardView.swift

  Verify clear-all cleanup:
  - grep for "urlFaviconPath" in AppState.swift
  </verify>
  <done>
  Settings has a "URL Previews" toggle (default: enabled) that controls whether metadata is fetched. RetentionService, AppState.clearAllHistory, and ClipboardCardView.deleteItem all clean up favicon and og:image files when items are purged or deleted. Build compiles cleanly.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  Rich URL preview cards with auto-fetched metadata. The full feature:
  1. Copy a URL (e.g., https://github.com or https://www.apple.com) -- card should show a loading spinner briefly, then animate to show og:image banner + favicon + page title
  2. Copy a URL without og:image (e.g., a simple page) -- card should show compact favicon + title only (no banner)
  3. Copy a private URL (e.g., http://localhost:3000) -- card should remain a plain URL (no fetch attempted)
  4. Settings > General has a "URL Previews" toggle -- turn it off and copy a new URL, it should stay plain
  </what-built>
  <how-to-verify>
  1. Build and run Pastel from Xcode
  2. **Test enriched URL card:**
     - Copy `https://github.com` from a browser
     - Open Pastel panel (Cmd+Shift+V)
     - Verify: card shows a loading state briefly, then shows og:image banner (GitHub social preview) + favicon + "GitHub" title
     - Verify: the header row (source app icon + timestamp) remains visible ABOVE the banner, consistent with image/code/color cards
     - The raw URL text should be hidden once metadata loads
  3. **Test URL without og:image:**
     - Copy a simple URL like `https://example.com`
     - Verify: card shows compact layout with just globe/favicon icon + page title, no banner
     - Verify: header row (source app icon + timestamp) still visible at top
  4. **Test failed/offline:**
     - Copy an invalid URL like `https://thissitedoesnotexist12345.com`
     - Verify: card falls back to plain URL display (globe + blue URL text) after timeout
  5. **Test private URL skip:**
     - Copy `http://localhost:3000`
     - Verify: card stays as plain URL immediately (no loading spinner)
  6. **Test Settings toggle:**
     - Open Settings > General, find "URL Previews" toggle, turn it OFF
     - Copy a new URL (e.g., `https://www.apple.com`)
     - Verify: card stays as plain URL (no fetch)
     - Turn toggle back ON
  7. **Test animation:**
     - Copy a URL and watch the card transition -- it should smoothly animate from plain to enriched
  </how-to-verify>
  <resume-signal>Type "approved" or describe any visual/functional issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `xcodebuild -project Pastel.xcodeproj -scheme Pastel -configuration Debug build` succeeds
2. URLCardView renders 3 states: loading (spinner), enriched (banner + favicon + title), failed (plain URL)
3. Header row (source app icon + timestamp) visible above URL card content in all states
4. og:image banner uses 2:1 aspect ratio, scaled to fill, clipped
5. Favicon at 16pt, globe placeholder when missing
6. Title single-line truncated with ellipsis
7. Raw URL text hidden when enriched
8. Smooth animation from plain to enriched state
9. Settings "URL Previews" toggle exists, defaults to enabled
10. RetentionService cleans up favicon and og:image files
11. Individual delete and clear-all also clean up URL metadata images
</verification>

<success_criteria>
- URL cards show rich previews: og:image banner + favicon + title (RICH-07)
- Header row (source app icon + timestamp) remains on enriched cards, consistent with other card types (RICH-07)
- Loading state with spinner visible while fetching (RICH-08)
- Failed/offline URLs fall back to plain URL card gracefully (RICH-08)
- Settings toggle disables fetching for new URLs (RICH-09)
- All image cleanup paths handle favicon and og:image files
- Animations smooth and card feels like a progression from the plain URL card
- Human verification confirms visual quality
</success_criteria>

<output>
After completion, create `.planning/phases/08-url-preview-cards/08-02-SUMMARY.md`
</output>
