---
phase: 15-importexport
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - Pastel/Views/Settings/GeneralSettingsView.swift
autonomous: true

must_haves:
  truths:
    - "User clicks Export in Settings and saves a .pastel file via NSSavePanel"
    - "User clicks Import in Settings and selects a .pastel file via NSOpenPanel"
    - "Progress bar shows during export and import operations"
    - "After import, user sees result summary with imported/skipped/labels-created counts"
    - "After export, user sees confirmation with item count"
    - "Import errors show user-friendly alert"
  artifacts:
    - path: "Pastel/Views/Settings/GeneralSettingsView.swift"
      provides: "Export/Import buttons in Data section, progress bar, result alerts"
      contains: "ImportExportService"
  key_links:
    - from: "Pastel/Views/Settings/GeneralSettingsView.swift"
      to: "Pastel/Services/ImportExportService.swift"
      via: "Service instance calls for export/import"
      pattern: "importExportService\\.(export|import)"
    - from: "Pastel/Views/Settings/GeneralSettingsView.swift"
      to: "NSSavePanel/NSOpenPanel"
      via: "Native file dialogs for save/open"
      pattern: "NSSavePanel|NSOpenPanel"
---

<objective>
Add Import and Export buttons to the GeneralSettingsView Data section with NSSavePanel/NSOpenPanel file dialogs, progress feedback, and result/error alerts.

Purpose: This is the user-facing UI for Phase 15 -- connects the ImportExportService (Plan 01) to Settings with file dialogs and visual feedback. Covers DATA-07 (settings section) and DATA-08 (progress feedback).

Output: Updated GeneralSettingsView.swift with working Export and Import buttons.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-importexport/15-RESEARCH.md
@.planning/phases/15-importexport/15-01-SUMMARY.md

@Pastel/Views/Settings/GeneralSettingsView.swift
@Pastel/Services/ImportExportService.swift
@Pastel/App/AppState.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Export/Import buttons, file dialogs, progress bar, and result alerts to GeneralSettingsView</name>
  <files>Pastel/Views/Settings/GeneralSettingsView.swift</files>
  <action>
Modify the existing `Pastel/Views/Settings/GeneralSettingsView.swift` to add import/export UI to the "Data" section (section 7, currently only has "Clear All History...").

**1. Add new state properties:**

```swift
@State private var importExportService = ImportExportService()
@State private var showingExportSuccess = false
@State private var showingImportResult = false
@State private var showingImportError = false
@State private var exportedItemCount = 0
@State private var lastImportResult: ImportResult?
@State private var importErrorMessage = ""
```

**2. Replace the current Data section (section 7) with an expanded version:**

The new Data section should contain:

- Section header "Data" with `.font(.headline)`
- HStack with three buttons: "Export...", "Import...", "Clear All History..." (red). Buttons disabled when `importExportService.isProcessing`.
- Existing clear-all alert stays exactly as-is (`.alert("Clear All History", isPresented: $showingClearConfirmation)`)
- Below buttons: if `importExportService.isProcessing`, show a VStack with:
  - `ProgressView(value: importExportService.progress)` (determinate progress bar)
  - `Text(importExportService.progressMessage).font(.caption).foregroundStyle(.secondary)`
- Caption text below: "Export saves text-based clipboard history to a .pastel file. Images are not included."
- `.alert("Export Complete", isPresented: $showingExportSuccess)` with OK button, message: "Exported {exportedItemCount} items to .pastel file."
- `.alert("Import Complete", isPresented: $showingImportResult)` with OK button, message: "Imported {importedCount} items, skipped {skippedCount} duplicates. {labelsCreated} new labels created." (from lastImportResult)
- `.alert("Import Failed", isPresented: $showingImportError)` with OK button, message: importErrorMessage

**3. Export button action (`performExport`):**

```swift
private func performExport() {
    let panel = NSSavePanel()
    panel.allowedContentTypes = [.pastelExport]
    panel.nameFieldStringValue = "Clipboard History.pastel"
    panel.title = "Export Clipboard History"
    panel.message = "Choose where to save your clipboard history."
    panel.canCreateDirectories = true

    let response = panel.runModal()
    guard response == .OK, let url = panel.url else { return }

    Task {
        do {
            let data = try importExportService.exportHistory(modelContext: modelContext)
            try data.write(to: url, options: .atomic)
            // Decode to get item count for confirmation
            let export = try JSONDecoder().decode(PastelExport.self, from: data)
            // No -- simpler: just use the service to report count, or decode version struct
            exportedItemCount = (try? JSONDecoder().decode(CountHelper.self, from: data))?.items.count ?? 0
            showingExportSuccess = true
        } catch {
            importErrorMessage = "Export failed: \(error.localizedDescription)"
            showingImportError = true
        }
    }
}
```

Actually, simplify: make `exportHistory` return a tuple or have the service track the count. Better approach -- since we already have the encoded data, decode just the items count. OR even simpler: have `exportHistory` also set a property on the service. Simplest: after encoding, count items from the PastelExport struct before encoding:

In the performExport function:
- Call `importExportService.exportHistory(modelContext:)` which returns Data
- The service's progressMessage will have the count. But we also need it for the alert.
- Best approach: have the service expose `lastExportCount: Int` property, set during export. OR just decode the items array length from the returned Data. OR compute it from the fetch.

**Simplest correct approach:** Add a `lastExportCount: Int` property to ImportExportService, set it in `exportHistory` after fetching items (before encoding). Then in the UI: `exportedItemCount = importExportService.lastExportCount`.

Update performExport:
```swift
private func performExport() {
    let panel = NSSavePanel()
    panel.allowedContentTypes = [.pastelExport]
    panel.nameFieldStringValue = "Clipboard History.pastel"
    panel.title = "Export Clipboard History"
    panel.message = "Choose where to save your clipboard history."
    panel.canCreateDirectories = true

    let response = panel.runModal()
    guard response == .OK, let url = panel.url else { return }

    Task {
        do {
            let data = try importExportService.exportHistory(modelContext: modelContext)
            try data.write(to: url, options: .atomic)
            exportedItemCount = importExportService.lastExportCount
            showingExportSuccess = true
        } catch {
            importErrorMessage = "Export failed: \(error.localizedDescription)"
            showingImportError = true
        }
    }
}
```

**4. Import button action (`performImport`):**

```swift
private func performImport() {
    let panel = NSOpenPanel()
    panel.allowedContentTypes = [.pastelExport]
    panel.canChooseFiles = true
    panel.canChooseDirectories = false
    panel.allowsMultipleSelection = false
    panel.title = "Import Clipboard History"
    panel.message = "Select a .pastel file to import."

    let response = panel.runModal()
    guard response == .OK, let url = panel.url else { return }

    Task {
        do {
            let data = try Data(contentsOf: url)
            let result = try importExportService.importHistory(from: data, modelContext: modelContext)
            lastImportResult = result
            showingImportResult = true
        } catch {
            importErrorMessage = "Import failed: \(error.localizedDescription)"
            showingImportError = true
        }
    }
}
```

**5. Add `import UniformTypeIdentifiers` at the top** of GeneralSettingsView.swift (needed for `.pastelExport` UTType reference in allowedContentTypes).

**6. Add `lastExportCount: Int` property to ImportExportService** (in the service file from Plan 01). Set it in exportHistory after the fetch, before encoding. This is a minor addition -- if Plan 01 didn't include it, add it now.

**Important layout notes:**
- Keep the existing section structure and styling consistent with the rest of GeneralSettingsView
- Export and Import buttons should use the default button style (not red like Clear All)
- The progress bar should only appear when `importExportService.isProcessing` is true
- All three alerts are independent (export success, import result, import/export error)
- Disable all three buttons during processing to prevent concurrent operations
  </action>
  <verify>
Build the project: `cd /Users/phulsechinmay/Desktop/Projects/pastel && xcodebuild -project Pastel.xcodeproj -scheme Pastel -configuration Debug build 2>&1 | tail -5`. Must compile with zero errors. Then visually verify: open app, go to Settings > General, scroll to Data section -- Export and Import buttons should be visible alongside Clear All History.
  </verify>
  <done>
GeneralSettingsView Data section shows Export, Import, and Clear All History buttons. Export opens NSSavePanel with .pastel filter, imports opens NSOpenPanel with .pastel filter. Progress bar appears during operations. Success/error alerts display with appropriate counts. All three buttons disabled during processing.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete import/export feature: Export button saves .pastel file with all text-based clipboard history and metadata. Import button loads .pastel file, skips duplicates, creates missing labels, shows result counts.</what-built>
  <how-to-verify>
1. Open Pastel Settings > General tab
2. Scroll to "Data" section -- should see "Export...", "Import...", and "Clear All History..." buttons
3. Click "Export..." -- NSSavePanel should appear with "Clipboard History.pastel" as default name
4. Save the file to Desktop
5. Verify the .pastel file is valid JSON: open in text editor, confirm it has version, exportDate, items array, labels array
6. Verify exported items have metadata: textContent, contentType, timestamp, sourceAppName, contentHash, labelNames
7. Verify NO image-type items in the export (contentType should never be "image")
8. Verify NO concealed items in the export (isConcealed should always be false, or concealed items absent)
9. Click "Import..." -- NSOpenPanel should appear filtered to .pastel files
10. Select the same file you just exported -- should show "Imported 0 items, skipped N duplicates" (all items already exist)
11. Edit the .pastel file: change one item's contentHash to something unique (e.g., "test123"), save
12. Import the edited file -- should show "Imported 1 item, skipped N-1 duplicates"
13. Verify the newly imported item appears in clipboard history
14. During import/export, verify a progress bar appears briefly (may be too fast for small histories)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Project compiles: `xcodebuild -project Pastel.xcodeproj -scheme Pastel build` succeeds
2. GeneralSettingsView Data section has Export, Import, and Clear All History buttons
3. Export opens NSSavePanel filtered to .pastel, saves JSON file excluding images and concealed items
4. Import opens NSOpenPanel filtered to .pastel, reads file, skips duplicates, creates missing labels
5. Progress bar visible during import/export operations
6. Result alerts show correct counts (imported, skipped, labels created)
7. Error alerts show user-friendly messages on failure
</verification>

<success_criteria>
- DATA-01: Export button saves .pastel file (JSON format) -- VERIFIED by NSSavePanel + file write
- DATA-02: Export preserves titles, labels, timestamps, source apps, content -- VERIFIED by ExportedItem fields
- DATA-03: Export excludes images -- VERIFIED by #Predicate filter on contentType != "image"
- DATA-04: Import loads .pastel file -- VERIFIED by NSOpenPanel + importHistory call
- DATA-05: Import skips duplicates by contentHash -- VERIFIED by pre-check fetchCount
- DATA-06: Import creates missing labels and wires relationships -- VERIFIED by label resolution logic
- DATA-07: Settings has Import/Export section -- VERIFIED by Data section in GeneralSettingsView
- DATA-08: Progress feedback during operations -- VERIFIED by ProgressView bound to service.progress
</success_criteria>

<output>
After completion, create `.planning/phases/15-importexport/15-02-SUMMARY.md`
</output>
