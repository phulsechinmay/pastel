---
phase: 10-drag-drop-label-assignment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Pastel/Extensions/PersistentIdentifier+Transfer.swift
  - Pastel/Views/Panel/ChipBarView.swift
  - Pastel/Views/Panel/FilteredCardListView.swift
  - Pastel/Views/Panel/ClipboardCardView.swift
autonomous: true

must_haves:
  truths:
    - "User can drag a label chip from the chip bar and see a chip-shaped drag preview"
    - "User can drop a label chip onto a clipboard card and the label is assigned to that item"
    - "Card visually highlights with accent border/background when a label chip is dragged over it"
    - "Tapping a label chip in the chip bar still toggles label filtering (no regression)"
    - "Dropping an invalid payload (non-label string) onto a card does nothing"
  artifacts:
    - path: "Pastel/Extensions/PersistentIdentifier+Transfer.swift"
      provides: "JSON encode/decode helpers for PersistentIdentifier drag transfer"
      exports: ["asTransferString", "fromTransferString"]
    - path: "Pastel/Views/Panel/ChipBarView.swift"
      provides: "Draggable label chips with tap-to-filter preserved"
      contains: ".draggable"
    - path: "Pastel/Views/Panel/FilteredCardListView.swift"
      provides: "Per-card drop targets with isTargeted state tracking"
      contains: ".dropDestination"
    - path: "Pastel/Views/Panel/ClipboardCardView.swift"
      provides: "Drop target visual feedback via isDropTarget property"
      contains: "isDropTarget"
  key_links:
    - from: "Pastel/Views/Panel/ChipBarView.swift"
      to: "Pastel/Extensions/PersistentIdentifier+Transfer.swift"
      via: ".draggable(label.persistentModelID.asTransferString)"
      pattern: "asTransferString"
    - from: "Pastel/Views/Panel/FilteredCardListView.swift"
      to: "Pastel/Extensions/PersistentIdentifier+Transfer.swift"
      via: ".dropDestination decoding with fromTransferString"
      pattern: "fromTransferString"
    - from: "Pastel/Views/Panel/FilteredCardListView.swift"
      to: "Pastel/Views/Panel/ClipboardCardView.swift"
      via: "isDropTarget property passed from dropTargetIndex state"
      pattern: "isDropTarget.*dropTargetIndex"
---

<objective>
Add drag-and-drop label assignment so users can drag a label chip from the chip bar and drop it onto any clipboard card to assign that label. This provides a faster alternative to the existing right-click context menu for label assignment.

Purpose: Improve label assignment UX with direct manipulation -- drag a chip, drop on a card, done.
Output: Four modified/created files implementing the full drag-and-drop flow with visual feedback.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-drag-drop-label-assignment/10-RESEARCH.md

@Pastel/Models/Label.swift
@Pastel/Models/ClipboardItem.swift
@Pastel/Views/Panel/ChipBarView.swift
@Pastel/Views/Panel/FilteredCardListView.swift
@Pastel/Views/Panel/ClipboardCardView.swift
@Pastel/Views/Panel/PanelContentView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: PersistentIdentifier transfer helpers and draggable chip bar</name>
  <files>
    Pastel/Extensions/PersistentIdentifier+Transfer.swift
    Pastel/Views/Panel/ChipBarView.swift
  </files>
  <action>
**1. Create `Pastel/Extensions/PersistentIdentifier+Transfer.swift`:**

Add a new file with a `PersistentIdentifier` extension providing two helpers:

```swift
import SwiftData
import Foundation

extension PersistentIdentifier {
    /// Encode this identifier as a JSON string for drag-and-drop transfer.
    var asTransferString: String {
        let data = try! JSONEncoder().encode(self)
        return String(data: data, encoding: .utf8)!
    }

    /// Decode a PersistentIdentifier from a JSON string produced by `asTransferString`.
    static func fromTransferString(_ string: String) -> PersistentIdentifier? {
        guard let data = string.data(using: .utf8) else { return nil }
        return try? JSONDecoder().decode(PersistentIdentifier.self, from: data)
    }
}
```

**2. Refactor `ChipBarView.swift` -- `labelChip(for:)` method only:**

Replace the `Button { ... } label: { ... } .buttonStyle(.plain)` pattern with a plain View + `.onTapGesture` + `.draggable`. This is required because `Button` and `.draggable` have a gesture conflict on macOS where the drag consumes the mouse-down before the button registers a click.

The refactored `labelChip(for:)` should:
- Remove the `Button` wrapper entirely
- Keep the identical `HStack` content (emoji/dot + label name) with all existing styling (padding, background capsule, overlay stroke)
- Add `.contentShape(Capsule())` to ensure the full capsule area is tappable/draggable
- Add `.onTapGesture` with the same toggle logic: `selectedLabel = isActive ? nil : label`
- Add `.draggable(label.persistentModelID.asTransferString)` with a trailing closure providing a custom drag preview

The drag preview should be a mini chip matching the label appearance:
```swift
.draggable(label.persistentModelID.asTransferString) {
    HStack(spacing: 4) {
        if let emoji = label.emoji, !emoji.isEmpty {
            Text(emoji).font(.system(size: 10))
        } else {
            Circle()
                .fill(LabelColor(rawValue: label.colorName)?.color ?? .gray)
                .frame(width: 8, height: 8)
        }
        Text(label.name)
            .font(.caption)
            .lineLimit(1)
    }
    .padding(.horizontal, 8)
    .padding(.vertical, 4)
    .background(Color.accentColor.opacity(0.4), in: Capsule())
}
```

Do NOT modify the `createChip` or `createLabelPopover` sections -- those stay as `Button` since they don't need drag support.

**Important:** Add `import SwiftData` if not already present (it is already imported in ChipBarView).
  </action>
  <verify>
Build the project with `xcodebuild -project Pastel.xcodeproj -scheme Pastel -configuration Debug build 2>&1 | tail -20`. Verify zero errors. The new extension file must be added to the Xcode project -- if using folder references it should be auto-included; if not, check the build output for "no such module" or missing file errors and add it to the target manually via `xcodebuild` or by editing the pbxproj.
  </verify>
  <done>
PersistentIdentifier+Transfer.swift exists with asTransferString/fromTransferString. ChipBarView label chips use onTapGesture + .draggable instead of Button. Build succeeds with zero errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Drop targets on cards with visual feedback</name>
  <files>
    Pastel/Views/Panel/ClipboardCardView.swift
    Pastel/Views/Panel/FilteredCardListView.swift
  </files>
  <action>
**1. Add `isDropTarget` property to `ClipboardCardView`:**

Add a new stored property `var isDropTarget: Bool = false` to ClipboardCardView. Update the `init` to accept it:

```swift
var isDropTarget: Bool

init(item: ClipboardItem, isSelected: Bool = false, badgePosition: Int? = nil, isDropTarget: Bool = false, onPaste: (() -> Void)? = nil) {
    self.item = item
    self.isSelected = isSelected
    self.badgePosition = badgePosition
    self.isDropTarget = isDropTarget
    self.onPaste = onPaste
}
```

Modify `cardBorderColor` to prioritize drop target state (highest priority visual cue):

```swift
private var cardBorderColor: Color {
    if isDropTarget {
        return Color.accentColor          // Bright accent border during drag hover
    } else if isSelected {
        return Color.accentColor.opacity(0.5)
    } else if isColorCard {
        return Color.white.opacity(0.15)
    }
    return Color.clear
}
```

Modify `cardBackground` to include drop target highlight (between colorCard and isSelected checks):

```swift
private var cardBackground: AnyShapeStyle {
    if isColorCard {
        return AnyShapeStyle(colorFromHex(item.detectedColorHex))
    } else if isDropTarget {
        return AnyShapeStyle(Color.accentColor.opacity(0.15))   // Subtle accent highlight
    } else if isSelected {
        return AnyShapeStyle(Color.accentColor.opacity(0.3))
    } else if isHovered {
        return AnyShapeStyle(Color.white.opacity(0.12))
    } else {
        return AnyShapeStyle(Color.white.opacity(0.06))
    }
}
```

Also add an animation for `isDropTarget` alongside the existing hover/selected animations:
```swift
.animation(.easeInOut(duration: 0.15), value: isDropTarget)
```

**2. Add drop targets in `FilteredCardListView`:**

Add `import SwiftData` at the top if not already present (it is already imported).

Add a `@State` property to track which card index is the current drop target:
```swift
@State private var dropTargetIndex: Int? = nil
```

In BOTH the horizontal and vertical `ForEach` loops, wrap each `ClipboardCardView` with `.dropDestination` and pass `isDropTarget`. The pattern for each card (applied identically in both horizontal and vertical branches):

```swift
ClipboardCardView(
    item: item,
    isSelected: selectedIndex == index,
    badgePosition: badge,
    isDropTarget: dropTargetIndex == index
)
```

Then AFTER the existing `.onTapGesture(count: 1)` modifier on each card, add:

```swift
.dropDestination(for: String.self) { strings, location in
    guard let encodedID = strings.first,
          let labelID = PersistentIdentifier.fromTransferString(encodedID),
          let label = try? modelContext.model(for: labelID) as? Label else {
        return false
    }
    item.label = label
    try? modelContext.save()
    return true
} isTargeted: { targeted in
    withAnimation(.easeInOut(duration: 0.15)) {
        dropTargetIndex = targeted ? index : nil
    }
}
```

Place `.dropDestination` AFTER `.onTapGesture` but BEFORE `.id(index)` so the drop frame matches the visible card.

**Important placement notes:**
- The `.dropDestination` must be on the per-card level (NOT on ScrollView or LazyVStack/LazyHStack)
- Both the horizontal `LazyHStack` loop AND the vertical `LazyVStack` loop need the same treatment
- The `modelContext` is already available via `@Environment(\.modelContext)` -- FilteredCardListView does NOT currently have this, so add: `@Environment(\.modelContext) private var modelContext`

**NSPanel fallback note:** If `.dropDestination` does not work in the NSPanel at runtime (the `isTargeted` callback never fires), the fallback is to replace `.dropDestination` with `.onDrop(of: [.text], isTargeted:)` using an `NSItemProvider`-based approach. However, the research indicates `.dropDestination` should work since it operates at the SwiftUI view layer, not the window activation layer. Implement with `.dropDestination` first.
  </action>
  <verify>
Build the project with `xcodebuild -project Pastel.xcodeproj -scheme Pastel -configuration Debug build 2>&1 | tail -20`. Verify zero errors. Specifically check:
1. No compile errors related to `modelContext` in FilteredCardListView
2. No compile errors related to `isDropTarget` parameter in ClipboardCardView init calls
3. No type mismatch errors on `.dropDestination(for: String.self)`
  </verify>
  <done>
ClipboardCardView has isDropTarget property with accent border/background visual feedback. FilteredCardListView has per-card .dropDestination modifiers in both horizontal and vertical layouts. Dropping a label-encoded string assigns the label to the clipboard item and saves. Invalid payloads are rejected (return false). Build succeeds with zero errors.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild -project Pastel.xcodeproj -scheme Pastel -configuration Debug build` completes with zero errors
2. New file `Pastel/Extensions/PersistentIdentifier+Transfer.swift` exists and compiles
3. ChipBarView no longer uses `Button` for label chips (uses `onTapGesture` + `.draggable`)
4. ClipboardCardView has `isDropTarget` property affecting `cardBackground` and `cardBorderColor`
5. FilteredCardListView has `.dropDestination` on each card in both horizontal and vertical layouts
6. No regressions: chip tap-to-filter still works, card tap/double-click/keyboard nav still works

**NSPanel risk mitigation:** If runtime testing reveals `.dropDestination` does not fire in the NSPanel (drag preview appears but drop never registers, `isTargeted` never fires), the fallback path is:
- Replace `.dropDestination(for: String.self)` with `.onDrop(of: [.plainText], isTargeted: $binding) { providers in ... }` using `NSItemProvider.loadItem(forTypeIdentifier: UTType.plainText.identifier)` to extract the encoded string
- This is a known workaround documented in the research (10-RESEARCH.md, Open Questions section)
</verification>

<success_criteria>
- Label chips in ChipBarView are draggable with a chip-shaped drag preview
- Dropping a label chip onto any clipboard card assigns that label to the item
- Cards show accent border and subtle background highlight when a label chip is hovered over them
- Tapping label chips still toggles filtering (no regression from Button-to-onTapGesture refactor)
- Invalid/non-label string drops are silently rejected
- Project builds with zero errors and zero warnings from modified files
</success_criteria>

<output>
After completion, create `.planning/phases/10-drag-drop-label-assignment/10-01-SUMMARY.md`
</output>
