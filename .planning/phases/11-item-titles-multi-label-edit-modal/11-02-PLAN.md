---
phase: 11-item-titles-multi-label-edit-modal
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - Pastel/Views/Panel/ClipboardCardView.swift
autonomous: true

must_haves:
  truths:
    - "Card header shows source app icon, title (when set, bold caption2), spacer, and abbreviated relative time"
    - "Card footer shows metadata text, up to 3 label chips with +N overflow badge, spacer, and keycap badge"
    - "Context menu has Edit option that opens EditItemView sheet"
    - "Context menu Label submenu toggles labels (add/remove) with checkmarks for assigned labels"
    - "Relative time uses abbreviated format: secs, mins, hours, days"
  artifacts:
    - path: "Pastel/Views/Panel/ClipboardCardView.swift"
      provides: "Restructured card header, footer, context menu, edit sheet"
      contains: "showingEditSheet"
  key_links:
    - from: "Pastel/Views/Panel/ClipboardCardView.swift"
      to: "Pastel/Views/Panel/EditItemView.swift"
      via: ".sheet presentation"
      pattern: "sheet.*isPresented.*showingEditSheet"
    - from: "Pastel/Views/Panel/ClipboardCardView.swift"
      to: "Pastel/Models/ClipboardItem.swift"
      via: "item.labels array access"
      pattern: "item\\.labels"
---

<objective>
Restructure ClipboardCardView to display the user-assigned title in the card header, move label chips to the card footer with overflow handling, update the context menu for multi-label toggle assignment and Edit action, and add abbreviated relative time formatting.

Purpose: This transforms the visual card layout to accommodate titles and multiple labels, and connects the edit modal created in Plan 01.
Output: Fully restructured ClipboardCardView with new header/footer layout, multi-label context menu, and edit sheet trigger.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-item-titles-multi-label-edit-modal/11-RESEARCH.md
@.planning/phases/11-item-titles-multi-label-edit-modal/11-01-SUMMARY.md

Key files to read:
@Pastel/Views/Panel/ClipboardCardView.swift
@Pastel/Views/Panel/EditItemView.swift (from Plan 01)
@Pastel/Models/ClipboardItem.swift (updated in Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure card header with title and abbreviated time</name>
  <files>Pastel/Views/Panel/ClipboardCardView.swift</files>
  <action>
**Replace the header row** (currently lines ~58-87) with the new layout from CONTEXT.md:
`[App Icon] [Title] [Spacer] [Timestamp]`

New header:
```swift
HStack {
    sourceAppIcon

    // Title (when set) -- bold caption2, visually distinct
    if let title = item.title, !title.isEmpty {
        Text(title)
            .font(.caption2.bold())
            .lineLimit(1)
            .foregroundStyle(isColorCard ? colorCardTextColor : .primary)
    }

    Spacer()

    // Abbreviated relative time
    Text(relativeTimeString(for: item.timestamp))
        .font(.caption2)
        .foregroundStyle(isColorCard ? colorCardTextColor.opacity(0.7) : .secondary)
}
```

The old header showed a single label chip between the app icon and timestamp. That label chip display moves to the footer (Task 2 handles footer). Remove the label chip from the header entirely.

**Add the `relativeTimeString` helper** as a private method on ClipboardCardView:
```swift
/// Custom relative time formatter for abbreviated "secs/mins/hours/days" output.
/// Static computation is acceptable since the panel is open briefly.
private func relativeTimeString(for date: Date) -> String {
    let interval = Date.now.timeIntervalSince(date)
    switch interval {
    case ..<2:
        return "now"
    case ..<60:
        let secs = Int(interval)
        return secs == 1 ? "1 sec ago" : "\(secs) secs ago"
    case ..<3600:
        let mins = Int(interval / 60)
        return mins == 1 ? "1 min ago" : "\(mins) mins ago"
    case ..<86400:
        let hours = Int(interval / 3600)
        return hours == 1 ? "1 hour ago" : "\(hours) hours ago"
    default:
        let days = Int(interval / 86400)
        return days == 1 ? "1 day ago" : "\(days) days ago"
    }
}
```

Note: This replaces the SwiftUI `Text(date, format: .relative(...))` which auto-updates but uses different abbreviation style. The user explicitly requested "mins/sec/secs" format. For a clipboard panel opened briefly, static computation on appear is fine.
  </action>
  <verify>Build succeeds. Header shows title when set, omits it when nil. Timestamp uses abbreviated format.</verify>
  <done>Card header displays `[App Icon] [Title?] [Spacer] [Time]` with bold caption2 title and "X mins ago" time format. No label chip in header.</done>
</task>

<task type="auto">
  <name>Task 2: Restructure footer with label chips, update context menu, attach edit sheet</name>
  <files>Pastel/Views/Panel/ClipboardCardView.swift</files>
  <action>
**Restructure the footer row** (currently lines ~92-106). The new footer layout:
`[Metadata] [Label Chips (max 3) + "+N"] [Spacer] [Keycap Badge]`

Replace the footer with:
```swift
// Footer row: metadata + label chips + badge
HStack(spacing: 4) {
    if let metadata = footerMetadataText {
        Text(metadata)
            .font(.caption2)
            .foregroundStyle(isColorCard ? colorCardTextColor.opacity(0.5) : .secondary.opacity(0.7))
            .lineLimit(1)
    }

    // Label chips (max 3 visible)
    let visibleLabels = Array(item.labels.prefix(3))
    ForEach(visibleLabels) { label in
        labelChipSmall(for: label)
    }
    if item.labels.count > 3 {
        Text("+\(item.labels.count - 3)")
            .font(.caption2)
            .foregroundStyle(isColorCard ? colorCardTextColor.opacity(0.7) : .secondary)
            .padding(.horizontal, 4)
            .padding(.vertical, 1)
            .background(
                isColorCard ? colorCardTextColor.opacity(0.15) : Color.white.opacity(0.1),
                in: Capsule()
            )
    }

    Spacer()

    if let badgePosition {
        KeycapBadge(number: badgePosition, isShiftHeld: isShiftHeld)
    }
}
```

The footer should ALWAYS show (it previously only showed when metadata or badge existed). Label chips may exist even without metadata text. Change the conditional from `if footerMetadataText != nil || badgePosition != nil` to unconditional rendering but only show the HStack if there's at least one thing to display:
```swift
if footerMetadataText != nil || !item.labels.isEmpty || badgePosition != nil {
    HStack(spacing: 4) { ... }
}
```

**Add `labelChipSmall` helper:**
```swift
@ViewBuilder
private func labelChipSmall(for label: Label) -> some View {
    HStack(spacing: 2) {
        if let emoji = label.emoji, !emoji.isEmpty {
            Text(emoji)
                .font(.system(size: 8))
        } else {
            Circle()
                .fill(LabelColor(rawValue: label.colorName)?.color ?? .gray)
                .frame(width: 6, height: 6)
        }
        Text(label.name)
            .font(.system(size: 9))
            .lineLimit(1)
    }
    .padding(.horizontal, 5)
    .padding(.vertical, 2)
    .background(
        cardLabelChipBackground(label),
        in: Capsule()
    )
}
```

**Update context menu** (currently lines ~152-191). Replace the entire `.contextMenu` block:

1. Add `@State private var showingEditSheet = false` to the state properties at the top of the struct.

2. New context menu:
```swift
.contextMenu {
    Button("Copy") { panelActions.copyOnlyItem?(item) }
    Button("Paste") { panelActions.pasteItem?(item) }
    Button("Copy + Paste") { panelActions.pasteItem?(item) }

    Divider()

    Button("Edit...") {
        showingEditSheet = true
    }

    Divider()

    // Multi-label assignment submenu (toggle on/off with checkmarks)
    Menu("Label") {
        ForEach(labels) { label in
            let isAssigned = item.labels.contains {
                $0.persistentModelID == label.persistentModelID
            }
            Button {
                if isAssigned {
                    item.labels.removeAll {
                        $0.persistentModelID == label.persistentModelID
                    }
                } else {
                    item.labels.append(label)
                }
                try? modelContext.save()
            } label: {
                HStack {
                    Image(nsImage: menuIcon(for: label))
                    Text(label.name)
                    if isAssigned {
                        Image(systemName: "checkmark")
                    }
                }
            }
        }

        if !item.labels.isEmpty {
            Divider()
            Button("Remove All Labels") {
                item.labels.removeAll()
                try? modelContext.save()
            }
        }
    }

    Divider()

    Button("Delete", role: .destructive) { deleteItem() }
}
.sheet(isPresented: $showingEditSheet) {
    EditItemView(item: item)
}
```

**Key changes from old context menu:**
- `item.label = label` -> toggle add/remove from `item.labels`
- Added checkmark for assigned labels
- Added "Remove All Labels" option
- Added "Edit..." button that triggers the sheet
- `.sheet()` attached right after `.contextMenu`
- `if item.label != nil` -> `if !item.labels.isEmpty`

**Remove the old `cardLabelChipBackground` usage from the header** -- the method itself stays (reused in footer). But the header no longer renders label chips, so any header-specific label chip code can be removed.
  </action>
  <verify>
Build succeeds. Run the app, right-click a card -- context menu should show "Edit..." and multi-label submenu with checkmarks. The card footer should show label chips. The edit sheet should open when clicking "Edit...".
  </verify>
  <done>
Card footer displays metadata text, up to 3 label chips with "+N" overflow, and keycap badge. Context menu has "Edit..." triggering EditItemView sheet, and Label submenu toggles labels with checkmarks. "Remove All Labels" option appears when labels are assigned.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild -project Pastel.xcodeproj -scheme Pastel build` succeeds
2. Card header shows `[App Icon] [Title?] [Spacer] [abbreviated time]`
3. Card footer shows `[Metadata] [Label chips (max 3) + "+N"] [Spacer] [Badge]`
4. Right-click "Edit..." opens EditItemView as sheet
5. Right-click Label submenu shows checkmarks for assigned labels and toggles on click
6. "Remove All Labels" option visible when item has labels
7. Time displays as "X mins ago", "X secs ago" etc.
</verification>

<success_criteria>
- Card layout matches CONTEXT.md decisions exactly: title in header, labels in footer
- Context menu supports multi-label toggle with visual checkmarks
- Edit sheet opens from context menu and allows title/label editing
- Abbreviated time formatting uses "secs/mins/hours/days" pattern
</success_criteria>

<output>
After completion, create `.planning/phases/11-item-titles-multi-label-edit-modal/11-02-SUMMARY.md`
</output>
