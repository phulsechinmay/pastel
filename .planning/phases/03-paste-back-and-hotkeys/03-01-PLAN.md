---
phase: 03-paste-back-and-hotkeys
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Pastel/Resources/Pastel.entitlements
  - Pastel/Services/AccessibilityService.swift
  - Pastel/Services/PasteService.swift
  - Pastel/Views/Panel/PanelController.swift
  - Pastel/App/AppState.swift
autonomous: true

must_haves:
  truths:
    - "App sandbox is disabled so CGEvent posting can work"
    - "AccessibilityService can check whether Accessibility permission is granted"
    - "AccessibilityService can trigger the macOS system permission prompt"
    - "PasteService writes a ClipboardItem's content to NSPasteboard.general"
    - "PasteService sets skipNextChange on ClipboardMonitor before writing to pasteboard"
    - "PasteService hides the panel and simulates Cmd+V via CGEvent after 50ms delay"
    - "PasteService handles all 5 content types (text, richText, url, image, file)"
    - "PasteService checks for secure input and falls back to copy-only when active"
    - "PanelController tracks the previously active app before showing the panel"
    - "AppState exposes a paste(item:) method that delegates to PasteService"
  artifacts:
    - path: "Pastel/Resources/Pastel.entitlements"
      provides: "Non-sandboxed entitlements for CGEvent access"
      contains: "com.apple.security.app-sandbox.*false|^(?!.*app-sandbox)"
    - path: "Pastel/Services/AccessibilityService.swift"
      provides: "Accessibility permission check and request"
      contains: "AXIsProcessTrusted"
    - path: "Pastel/Services/PasteService.swift"
      provides: "Pasteboard writing and CGEvent Cmd+V simulation"
      contains: "CGEvent.*keyboardEventSource"
    - path: "Pastel/Views/Panel/PanelController.swift"
      provides: "Previously-active app tracking and paste callback"
      contains: "previousApp.*NSRunningApplication"
    - path: "Pastel/App/AppState.swift"
      provides: "Paste orchestration wired to PasteService"
      contains: "pasteService"
  key_links:
    - from: "Pastel/Services/PasteService.swift"
      to: "Pastel/Services/ClipboardMonitor.swift"
      via: "Sets skipNextChange before writing to pasteboard"
      pattern: "skipNextChange.*=.*true"
    - from: "Pastel/Services/PasteService.swift"
      to: "Pastel/Views/Panel/PanelController.swift"
      via: "Calls hide() before simulating paste"
      pattern: "panelController.*hide|hide.*panel"
    - from: "Pastel/Services/PasteService.swift"
      to: "Pastel/Services/AccessibilityService.swift"
      via: "Checks permission before every paste"
      pattern: "AccessibilityService.*isGranted"
    - from: "Pastel/App/AppState.swift"
      to: "Pastel/Services/PasteService.swift"
      via: "AppState owns PasteService and calls paste()"
      pattern: "pasteService.*paste"
---

<objective>
Build the core paste-back infrastructure: PasteService (writes content to NSPasteboard and simulates Cmd+V via CGEvent), AccessibilityService (permission check/request), sandbox removal, and wire everything into AppState and PanelController.

Purpose: This is the foundation for ALL paste-back operations. Double-click paste, Enter-to-paste, and future Cmd+1-9 hotkeys all depend on PasteService existing. Nothing in Phase 3 works without this plan.

Output: Two new service files, modified entitlements, updated PanelController (tracks previous app), updated AppState (exposes paste action). The app compiles and PasteService is callable (but no UI triggers yet -- those come in Plan 02).
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-paste-back-and-hotkeys/03-RESEARCH.md

@Pastel/Resources/Pastel.entitlements
@Pastel/Services/ClipboardMonitor.swift
@Pastel/Services/ImageStorageService.swift
@Pastel/Views/Panel/PanelController.swift
@Pastel/App/AppState.swift
@Pastel/Models/ClipboardItem.swift
@Pastel/Models/ContentType.swift
@Pastel/PastelApp.swift
@project.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AccessibilityService, PasteService, and remove sandbox</name>
  <files>
    Pastel/Resources/Pastel.entitlements
    Pastel/Services/AccessibilityService.swift
    Pastel/Services/PasteService.swift
  </files>
  <action>
    **1. Remove App Sandbox from entitlements.**

    Edit `Pastel/Resources/Pastel.entitlements` to remove BOTH sandbox-related keys entirely. The file should be a valid plist with an empty dict:

    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
    <plist version="1.0">
    <dict/>
    </plist>
    ```

    Remove `com.apple.security.app-sandbox` and `com.apple.security.files.user-selected.read-write` (the latter is a sandbox sub-entitlement, meaningless outside sandbox). Do NOT set app-sandbox to false -- just remove the keys entirely.

    **2. Create `Pastel/Services/AccessibilityService.swift`.**

    An enum (no instances) with three static members:
    - `static var isGranted: Bool` -- returns `AXIsProcessTrusted()`. Import `ApplicationServices`. This is cheap to call and MUST be called before every paste (permission can be revoked at any time).
    - `@discardableResult static func requestPermission() -> Bool` -- calls `AXIsProcessTrustedWithOptions` with `kAXTrustedCheckOptionPrompt: true`. This shows the macOS system dialog.
    - `static func openAccessibilitySettings()` -- opens `x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility` via `NSWorkspace.shared.open()`.

    Mark the enum `@MainActor` since it interacts with system UI.

    **3. Create `Pastel/Services/PasteService.swift`.**

    A `@MainActor final class` with a Logger (subsystem from Bundle, category "PasteService").

    Main method: `func paste(item: ClipboardItem, clipboardMonitor: ClipboardMonitor, panelController: PanelController)`

    Flow:
    1. Check `AccessibilityService.isGranted`. If false, call `AccessibilityService.requestPermission()` and return early (do NOT paste).
    2. Check `IsSecureEventInputEnabled()` (import `Carbon`). If true, log a warning, still write to pasteboard and set skipNextChange (so user can manually Cmd+V), but do NOT simulate CGEvent. Return after writing.
    3. Call `writeToPasteboard(item:)` (private method, see below).
    4. Set `clipboardMonitor.skipNextChange = true`.
    5. Call `panelController.hide()`.
    6. After 50ms delay (`DispatchQueue.main.asyncAfter(deadline: .now() + 0.05)`), call `Self.simulatePaste()`.

    Private method `writeToPasteboard(item: ClipboardItem)`:
    - Get `NSPasteboard.general`, call `clearContents()`.
    - Switch on `item.type`:
      - `.text`: Set `.string` from textContent. If rtfData exists, also set `.rtf`. If htmlContent exists, also set `.html`.
      - `.richText`: Set `.rtf` from rtfData, `.html` from htmlContent, `.string` from textContent (all if non-nil). RTF first for maximum fidelity.
      - `.url`: Set `.string` from textContent. Also create `URL(string:)` and `writeObjects([url as NSURL])` for proper URL type.
      - `.image`: Resolve full image path via `ImageStorageService.shared.resolveImageURL(imagePath)`, read Data, set `.png`. Also create NSImage from data and set `.tiff` from `tiffRepresentation` for broader app compatibility.
      - `.file`: Parse textContent as file path, create `URL(fileURLWithPath:)`, call `writeObjects([url as NSURL])`.

    Private static method `simulatePaste()`:
    - Create `CGEventSource(stateID: .combinedSessionState)`.
    - Call `source?.setLocalEventsFilterDuringSuppressionState([.permitLocalMouseEvents, .permitSystemDefinedEvents], state: .eventSuppressionStateSuppressionInterval)`.
    - Create keyDown and keyUp `CGEvent(keyboardEventSource: source, virtualKey: 0x09, keyDown: true/false)`.
    - Set `.flags = .maskCommand` on both.
    - Post both to `.cgSessionEventTap` (keyDown first, then keyUp).

    Use `import CoreGraphics` for CGEvent, `import Carbon` for `IsSecureEventInputEnabled()`.

    **CRITICAL anti-patterns to avoid:**
    - Do NOT use `.cghidEventTap` -- use `.cgSessionEventTap`.
    - Do NOT cache AXIsProcessTrusted result.
    - Do NOT post CGEvent synchronously after hide() -- the 50ms delay is mandatory.
    - Do NOT use `canBecomeMain = true` anywhere.
    - Do NOT create a custom pasteboard marker type -- use the existing skipNextChange flag.
  </action>
  <verify>
    1. Run `xcodegen generate` from the project root to regenerate the Xcode project with the new files.
    2. Run `xcodebuild -project Pastel.xcodeproj -scheme Pastel -configuration Debug build 2>&1 | tail -20` to confirm the build succeeds with zero errors.
    3. Verify entitlements: `cat Pastel/Resources/Pastel.entitlements` should show no sandbox keys.
    4. Verify AccessibilityService: `grep -c "AXIsProcessTrusted" Pastel/Services/AccessibilityService.swift` should return 2+ (isGranted + requestPermission).
    5. Verify PasteService: `grep -c "CGEvent" Pastel/Services/PasteService.swift` should return 4+ (keyDown, keyUp, two posts).
    6. Verify PasteService: `grep -c "skipNextChange" Pastel/Services/PasteService.swift` should return 1+ (setting the flag).
  </verify>
  <done>
    - Pastel.entitlements has no sandbox keys
    - AccessibilityService.swift exists with isGranted, requestPermission, openAccessibilitySettings
    - PasteService.swift exists with paste(), writeToPasteboard(), simulatePaste()
    - PasteService handles all 5 content types in writeToPasteboard
    - PasteService checks AccessibilityService.isGranted before every paste
    - PasteService checks IsSecureEventInputEnabled and falls back gracefully
    - PasteService sets skipNextChange before writing to pasteboard
    - PasteService hides panel and simulates Cmd+V after 50ms delay
    - Project compiles with zero errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire PasteService into PanelController and AppState</name>
  <files>
    Pastel/Views/Panel/PanelController.swift
    Pastel/App/AppState.swift
  </files>
  <action>
    **1. Update PanelController to track the previously active app and accept a paste callback.**

    In `PanelController.swift`:

    - Add a private property: `private var previousApp: NSRunningApplication?`
    - Add a public closure property: `var onPasteItem: ((ClipboardItem) -> Void)?` -- this callback will be set by AppState and called by PanelContentView (via environment) when the user triggers a paste.
    - In the `show()` method, BEFORE the existing code that positions the panel, capture: `previousApp = NSWorkspace.shared.frontmostApplication`. This must happen before `orderFrontRegardless()`.
    - In the `hide()` method, after `panel.orderOut(nil)` in the completion handler, clear previousApp: `self?.previousApp = nil`.

    Update `createPanel()` to pass the `onPasteItem` callback into the SwiftUI environment. The PanelContentView needs access to a paste action. Use a closure-based approach:

    - Create a simple `@Observable` class called `PanelActions` (define it at the top of PanelController.swift or in a separate small file -- PanelController.swift is fine):
      ```swift
      @MainActor @Observable
      final class PanelActions {
          var pasteItem: ((ClipboardItem) -> Void)?
      }
      ```
    - Add a property to PanelController: `let panelActions = PanelActions()`
    - In `createPanel()`, set `panelActions.pasteItem = onPasteItem` and pass panelActions into the SwiftUI view via `.environment()`.
    - When creating the SwiftUI contentView, wrap it: `PanelContentView().environment(panelActions)`.

    **Important:** The panel is created lazily (first show). The `onPasteItem` callback must be set BEFORE the first show. AppState will set it during `setupPanel()`.

    Also, since the panel is created once and reused, update `show()` to sync the callback: after `createPanel()` guard, add `panelActions.pasteItem = onPasteItem` so it stays current even if the callback is set after panel creation.

    **2. Update AppState to own PasteService and wire the paste callback.**

    In `AppState.swift`:

    - Add a property: `let pasteService = PasteService()`
    - Add a method:
      ```swift
      func paste(item: ClipboardItem) {
          guard let clipboardMonitor else { return }
          pasteService.paste(item: item, clipboardMonitor: clipboardMonitor, panelController: panelController)
      }
      ```
    - In `setupPanel(modelContainer:)`, BEFORE the KeyboardShortcuts registration, set the paste callback:
      ```swift
      panelController.onPasteItem = { [weak self] item in
          self?.paste(item: item)
      }
      ```

    This wiring ensures: UI triggers paste -> PanelActions.pasteItem -> PanelController.onPasteItem -> AppState.paste -> PasteService.paste. The PasteService then handles pasteboard write, skip flag, hide, and CGEvent simulation.
  </action>
  <verify>
    1. Run `xcodegen generate && xcodebuild -project Pastel.xcodeproj -scheme Pastel -configuration Debug build 2>&1 | tail -20` to confirm clean build.
    2. Verify PanelController has previousApp: `grep "previousApp" Pastel/Views/Panel/PanelController.swift`.
    3. Verify PanelController has onPasteItem: `grep "onPasteItem" Pastel/Views/Panel/PanelController.swift`.
    4. Verify PanelActions class exists: `grep "PanelActions" Pastel/Views/Panel/PanelController.swift`.
    5. Verify AppState has pasteService: `grep "pasteService" Pastel/App/AppState.swift`.
    6. Verify AppState has paste method: `grep "func paste" Pastel/App/AppState.swift`.
    7. Verify the callback wiring: `grep "onPasteItem" Pastel/App/AppState.swift`.
  </verify>
  <done>
    - PanelController.previousApp captures frontmostApplication in show(), cleared in hide()
    - PanelController.onPasteItem callback is defined and synced to PanelActions
    - PanelActions @Observable class exists and is passed into SwiftUI environment
    - AppState owns PasteService and exposes paste(item:)
    - AppState wires panelController.onPasteItem to call self.paste(item:)
    - Full callback chain: SwiftUI -> PanelActions -> PanelController -> AppState -> PasteService
    - Project compiles with zero errors
  </done>
</task>

</tasks>

<verification>
1. `xcodegen generate && xcodebuild -project Pastel.xcodeproj -scheme Pastel -configuration Debug build` succeeds with zero errors
2. `Pastel/Resources/Pastel.entitlements` contains no `app-sandbox` key
3. `Pastel/Services/AccessibilityService.swift` exists with `AXIsProcessTrusted` calls
4. `Pastel/Services/PasteService.swift` exists with CGEvent paste simulation and all 5 content types
5. `PasteService.paste()` checks accessibility, checks secure input, writes pasteboard, sets skipNextChange, hides panel, posts CGEvent after 50ms
6. `PanelController.show()` captures `NSWorkspace.shared.frontmostApplication` before showing
7. `PanelController` has `onPasteItem` callback and `PanelActions` observable class
8. `AppState` owns `PasteService` and exposes `paste(item:)` method
9. The callback chain is fully wired: PanelActions -> onPasteItem -> AppState.paste -> PasteService.paste
</verification>

<success_criteria>
- Sandbox removed from entitlements (prerequisite for CGEvent)
- AccessibilityService provides check/request/open-settings for Accessibility permission
- PasteService can write any ClipboardItem to NSPasteboard and simulate Cmd+V
- Self-paste loop prevention is wired (skipNextChange set before pasteboard write)
- Secure input detected and handled gracefully (copy-only fallback)
- PanelController tracks previously active app
- AppState provides a single paste(item:) entry point for all future UI triggers
- PanelActions class enables SwiftUI views to invoke paste without coupling to AppKit
- Project compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-paste-back-and-hotkeys/03-01-SUMMARY.md`
</output>
