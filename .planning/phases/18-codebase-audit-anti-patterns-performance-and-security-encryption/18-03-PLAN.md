---
phase: 18-codebase-audit-anti-patterns-performance-and-security-encryption
plan: 03
type: execute
wave: 2
depends_on: ["18-01", "18-02"]
files_modified:
  - Pastel/Views/Panel/ClipboardCardView.swift
  - Pastel/Views/Panel/FilteredCardListView.swift
  - Pastel/Views/Panel/PanelContentView.swift
  - Pastel/Views/Settings/HistoryGridView.swift
  - Pastel/Views/Settings/HistoryBrowserView.swift
  - Pastel/Views/Panel/EditItemView.swift
autonomous: true

must_haves:
  truths:
    - "ClipboardCardView no longer declares @Query for labels -- it receives allLabels as a parameter from its parent"
    - "FilteredCardListView horizontal and vertical branches share a single @ViewBuilder helper for card rendering instead of duplicating ~60 lines"
    - "PanelContentView .id() modifier does NOT include appState.itemCount -- SwiftData @Query handles item additions automatically"
    - "NSImage.lockFocus/unlockFocus is replaced with NSImage(size:flipped:drawingHandler:) in ClipboardCardView.menuIcon(for:)"
  artifacts:
    - path: "Pastel/Views/Panel/ClipboardCardView.swift"
      provides: "Label-query-free card view receiving allLabels parameter"
      contains: "let allLabels: [Label]"
    - path: "Pastel/Views/Panel/FilteredCardListView.swift"
      provides: "Shared @ViewBuilder cardView helper eliminating horizontal/vertical duplication"
      contains: "@ViewBuilder"
  key_links:
    - from: "Pastel/Views/Panel/FilteredCardListView.swift"
      to: "Pastel/Views/Panel/ClipboardCardView.swift"
      via: "Passes allLabels parameter to ClipboardCardView"
      pattern: "allLabels:"
    - from: "Pastel/Views/Settings/HistoryGridView.swift"
      to: "Pastel/Views/Panel/ClipboardCardView.swift"
      via: "Passes allLabels parameter to ClipboardCardView"
      pattern: "allLabels:"
    - from: "Pastel/Views/Panel/PanelContentView.swift"
      to: "Pastel/Views/Panel/FilteredCardListView.swift"
      via: "Passes labels array from @Query and .id() no longer includes itemCount"
      pattern: "allLabels:"
---

<objective>
Refactor the SwiftUI view layer to eliminate redundant @Query subscriptions, remove unnecessary view rebuilds, replace deprecated APIs, and extract duplicated rendering logic into a shared helper.

Purpose: Remove N redundant @Query label subscriptions per visible card (A4/P3), prevent full view tree reconstruction on every clipboard capture (P1), modernize deprecated NSImage.lockFocus API (A8), investigate the `#Predicate { _ in true }` fetch-all pattern (A5), and DRY up the horizontal/vertical card rendering (A6).

Output: Leaner ClipboardCardView without @Query, optimized .id() modifier, modern NSImage drawing, shared card rendering @ViewBuilder.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-codebase-audit-anti-patterns-performance-and-security-encryption/18-RESEARCH.md

Prior plan summaries (needed because Plan 01 modified these same files):
@.planning/phases/18-codebase-audit-anti-patterns-performance-and-security-encryption/18-01-SUMMARY.md
@.planning/phases/18-codebase-audit-anti-patterns-performance-and-security-encryption/18-02-SUMMARY.md

Source files to modify:
@Pastel/Views/Panel/ClipboardCardView.swift
@Pastel/Views/Panel/FilteredCardListView.swift
@Pastel/Views/Panel/PanelContentView.swift
@Pastel/Views/Settings/HistoryGridView.swift
@Pastel/Views/Settings/HistoryBrowserView.swift
@Pastel/Views/Panel/EditItemView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove @Query from ClipboardCardView and pass labels as parameter from all parents</name>
  <files>
    Pastel/Views/Panel/ClipboardCardView.swift
    Pastel/Views/Panel/FilteredCardListView.swift
    Pastel/Views/Panel/PanelContentView.swift
    Pastel/Views/Settings/HistoryGridView.swift
    Pastel/Views/Settings/HistoryBrowserView.swift
    Pastel/Views/Panel/EditItemView.swift
  </files>
  <action>
    **Step 1: Modify ClipboardCardView to accept labels as a parameter**

    In `ClipboardCardView.swift`:
    1. Remove the `@Query(sort: \Label.sortOrder) private var labels: [Label]` property (line 21).
    2. Add a new stored property: `let allLabels: [Label]`
    3. Update the `init(...)` to accept `allLabels: [Label] = []`:
       ```swift
       init(item: ClipboardItem, isSelected: Bool = false, allLabels: [Label] = [],
            badgePosition: Int? = nil, isDropTarget: Bool = false, isShiftHeld: Bool = false,
            hideContextMenu: Bool = false, onPaste: (() -> Void)? = nil) {
           self.item = item
           self.isSelected = isSelected
           self.allLabels = allLabels
           self.badgePosition = badgePosition
           self.isDropTarget = isDropTarget
           self.isShiftHeld = isShiftHeld
           self.hideContextMenu = hideContextMenu
           self.onPaste = onPaste
       }
       ```
    4. In the context menu `Menu("Label")` block, change `ForEach(labels)` to `ForEach(allLabels)`.
    5. Remove the `import SwiftData` import if no other SwiftData types are used in the file. Check if `@Environment(\.modelContext)` is still used -- it is (for delete and label toggle), so keep SwiftData import.

    **Step 2: Update FilteredCardListView to pass labels**

    `FilteredCardListView` does NOT currently have `@Query` for labels -- it gets labels from its parent (PanelContentView) indirectly. It needs a new `allLabels` parameter.

    1. Add `let allLabels: [Label]` property to FilteredCardListView.
    2. Add `allLabels: [Label] = []` parameter to the init.
    3. Pass `allLabels: allLabels` to every `ClipboardCardView(...)` call (both horizontal and vertical branches).

    **Step 3: Update PanelContentView to pass labels through**

    PanelContentView already has `@Query(sort: \Label.sortOrder) private var labels: [Label]`.

    1. Pass `allLabels: labels` to the `FilteredCardListView(...)` init call (around line 118).

    **Step 4: Update HistoryGridView to pass labels**

    HistoryGridView does NOT currently have labels. Its parent (HistoryBrowserView) has `@Query(sort: \Label.sortOrder) private var labels: [Label]`.

    1. Add `let allLabels: [Label]` property to HistoryGridView.
    2. Add `allLabels: [Label] = []` parameter to the init.
    3. Pass `allLabels: allLabels` to every `ClipboardCardView(...)` call in the grid.

    **Step 5: Update HistoryBrowserView to pass labels to HistoryGridView**

    1. Pass `allLabels: labels` in the `HistoryGridView(...)` call (around line 44).

    **Step 6: Verify EditItemView**

    `EditItemView` has its own `@Query(sort: \Label.sortOrder) private var allLabels: [Label]`. This is acceptable because EditItemView is presented as a standalone modal window (not in a ForEach). It creates only ONE @Query subscription. Leave it unchanged -- the anti-pattern is specifically about @Query inside per-card views in a ForEach.

    **A5 Investigation: `#Predicate { _ in true }` fetch-all pattern**

    The `#Predicate { _ in true }` pattern in FilteredCardListView and HistoryGridView fetches all items when no search is active. Adding `fetchLimit` would break the in-memory label filtering (which needs access to all items to filter by label). Since label filtering is a post-filter on the @Query results, a fetchLimit would silently exclude matching items beyond the limit.

    **Decision: Accept as known limitation.** The in-memory label filtering design (necessary because SwiftData #Predicate cannot use .contains() on to-many relationships -- see decision [11-03]) requires loading all items. This is acceptable for typical clipboard history sizes. Add a brief code comment documenting this decision:

    In both `FilteredCardListView.swift` and `HistoryGridView.swift`, above the `predicate = #Predicate<ClipboardItem> { _ in true }` line, add:
    ```swift
    // Fetch all items (no fetchLimit): required for in-memory label post-filtering.
    // SwiftData #Predicate cannot use .contains() on to-many relationships.
    ```
  </action>
  <verify>
    Build: `cd /Users/phulsechinmay/Desktop/Projects/pastel && xcodebuild build -scheme Pastel -destination 'platform=macOS' -quiet 2>&1 | tail -5`
    Verify no @Query in ClipboardCardView: `grep "@Query" Pastel/Views/Panel/ClipboardCardView.swift` should return nothing.
    Verify allLabels parameter exists: `grep "let allLabels:" Pastel/Views/Panel/ClipboardCardView.swift` should return 1 match.
    Verify labels passed through FilteredCardListView: `grep "allLabels:" Pastel/Views/Panel/FilteredCardListView.swift` should show the init param and ClipboardCardView calls.
    Verify labels passed through HistoryGridView: `grep "allLabels:" Pastel/Views/Settings/HistoryGridView.swift` should show the init param and ClipboardCardView calls.
  </verify>
  <done>
    ClipboardCardView receives labels as `allLabels` parameter instead of @Query. All parent views (FilteredCardListView, HistoryGridView) pass labels through. PanelContentView and HistoryBrowserView provide labels from their existing @Query. No N-per-card redundant query subscriptions. A5 documented as accepted limitation. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove itemCount from .id() modifier and replace deprecated NSImage.lockFocus</name>
  <files>
    Pastel/Views/Panel/PanelContentView.swift
    Pastel/Views/Panel/ClipboardCardView.swift
  </files>
  <action>
    **P1: Remove `appState.itemCount` from the `.id()` modifier on FilteredCardListView**

    In `PanelContentView.swift`, find the `.id(...)` modifier on `FilteredCardListView` (around line 138):
    ```swift
    // BEFORE:
    .id("\(debouncedSearchText)\(selectedLabelIDs.sorted(by: { "\($0)" < "\($1)" }).map { "\($0)" }.joined())\(appState.itemCount)")

    // AFTER:
    .id("\(debouncedSearchText)\(selectedLabelIDs.sorted(by: { "\($0)" < "\($1)" }).map { "\($0)" }.joined())")
    ```

    The rationale: SwiftData's `@Query` already automatically observes item additions/deletions and updates the view. Including `itemCount` in `.id()` forces a complete destruction and recreation of FilteredCardListView (and all its child views, state, queries, and the NSEvent key monitor) every time ANY new clipboard item is captured. This causes:
    - Scroll position reset
    - Selection state loss
    - Visual flicker
    - Unnecessary CPU work rebuilding the entire card list

    Add a comment explaining why itemCount is NOT included:
    ```swift
    // .id() triggers full view recreation when filters change (required for @Query predicate update).
    // Intentionally excludes appState.itemCount: @Query auto-observes item additions/deletions.
    ```

    **A8: Replace deprecated NSImage.lockFocus() with NSImage(size:flipped:drawingHandler:)**

    In `ClipboardCardView.swift`, replace the `menuIcon(for:)` method:

    ```swift
    // BEFORE:
    private func menuIcon(for label: Label) -> NSImage {
        let size: CGFloat = 16
        let image = NSImage(size: NSSize(width: size, height: size))
        image.lockFocus()
        if let emoji = label.emoji, !emoji.isEmpty {
            let attributes: [NSAttributedString.Key: Any] = [
                .font: NSFont.systemFont(ofSize: 12)
            ]
            let str = NSAttributedString(string: emoji, attributes: attributes)
            let strSize = str.size()
            str.draw(at: NSPoint(
                x: (size - strSize.width) / 2,
                y: (size - strSize.height) / 2
            ))
        } else {
            let nsColor = NSColor(LabelColor(rawValue: label.colorName)?.color ?? .gray)
            nsColor.setFill()
            NSBezierPath(ovalIn: NSRect(x: 2, y: 2, width: 12, height: 12)).fill()
        }
        image.unlockFocus()
        image.isTemplate = false
        return image
    }

    // AFTER:
    private func menuIcon(for label: Label) -> NSImage {
        let size: CGFloat = 16
        let image = NSImage(size: NSSize(width: size, height: size), flipped: false) { rect in
            if let emoji = label.emoji, !emoji.isEmpty {
                let attributes: [NSAttributedString.Key: Any] = [
                    .font: NSFont.systemFont(ofSize: 12)
                ]
                let str = NSAttributedString(string: emoji, attributes: attributes)
                let strSize = str.size()
                str.draw(at: NSPoint(
                    x: (size - strSize.width) / 2,
                    y: (size - strSize.height) / 2
                ))
            } else {
                let nsColor = NSColor(LabelColor(rawValue: label.colorName)?.color ?? .gray)
                nsColor.setFill()
                NSBezierPath(ovalIn: NSRect(x: 2, y: 2, width: 12, height: 12)).fill()
            }
            return true
        }
        image.isTemplate = false
        return image
    }
    ```

    The `NSImage(size:flipped:drawingHandler:)` initializer is the modern replacement for lockFocus/unlockFocus. The `flipped: false` parameter matches the default coordinate system (origin at bottom-left). The drawing handler receives a `rect` parameter but we use `size` directly for consistent behavior with the original code.
  </action>
  <verify>
    Build: `cd /Users/phulsechinmay/Desktop/Projects/pastel && xcodebuild build -scheme Pastel -destination 'platform=macOS' -quiet 2>&1 | tail -5`
    Verify itemCount removed from .id(): `grep "itemCount" Pastel/Views/Panel/PanelContentView.swift` should return nothing (the only reference was in the .id() modifier).
    Verify no lockFocus: `grep "lockFocus\|unlockFocus" Pastel/Views/Panel/ClipboardCardView.swift` should return nothing.
    Verify modern API used: `grep "NSImage(size:" Pastel/Views/Panel/ClipboardCardView.swift` should return 1 match.
  </verify>
  <done>
    `appState.itemCount` removed from PanelContentView .id() modifier -- no more full view rebuild on every clipboard capture. NSImage.lockFocus/unlockFocus replaced with NSImage(size:flipped:drawingHandler:). Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 3: Extract duplicated horizontal/vertical card rendering into shared @ViewBuilder</name>
  <files>Pastel/Views/Panel/FilteredCardListView.swift</files>
  <action>
    In `FilteredCardListView`, the horizontal branch (lines ~113-158) and vertical branch (lines ~174-217) contain nearly identical card rendering logic. The differences are:
    - Horizontal: `.frame(width: 260, height: 195)` and `.clipped()` on each card
    - Vertical: no frame constraint
    - Both: identical `ClipboardCardView(...)` init, `.onDrag {}`, `.onTapGesture(count: 2)`, `.onTapGesture(count: 1)`, `.dropDestination(for:)`, `.id(index)`

    Extract the common card rendering into a `@ViewBuilder` private method:

    ```swift
    @ViewBuilder
    private func cardView(for item: ClipboardItem, at index: Int, isHorizontalLayout: Bool) -> some View {
        let badge: Int? = quickPasteEnabled && index < 9 ? index + 1 : nil
        ClipboardCardView(
            item: item,
            isSelected: selectedIndex == index,
            allLabels: allLabels,
            badgePosition: badge,
            isDropTarget: dropTargetIndex == index,
            isShiftHeld: isShiftHeld
        )
        .if(isHorizontalLayout) { view in
            view.frame(width: 260, height: 195).clipped()
        }
        .onDrag {
            onDragStarted?()
            return DragItemProviderService.createItemProvider(for: item)
        }
        .onTapGesture(count: 2) {
            if NSEvent.modifierFlags.contains(.shift) {
                onPastePlainText(item)
            } else {
                onPaste(item)
            }
        }
        .onTapGesture(count: 1) {
            selectedIndex = index
        }
        .dropDestination(for: String.self) { strings, _ in
            guard let encodedID = strings.first,
                  let labelID = PersistentIdentifier.fromTransferString(encodedID),
                  let label = try? modelContext.model(for: labelID) as? Label else {
                return false
            }
            guard !item.labels.contains(where: {
                $0.persistentModelID == label.persistentModelID
            }) else { return true }
            item.labels.append(label)
            saveWithLogging(modelContext, operation: "label drop assignment")
            return true
        } isTargeted: { targeted in
            withAnimation(.easeInOut(duration: 0.15)) {
                dropTargetIndex = targeted ? index : nil
            }
        }
        .id(index)
    }
    ```

    **IMPORTANT:** SwiftUI does not have a built-in `.if()` conditional modifier. Instead of using `.if()`, use a simpler approach -- apply the frame/clipped modifiers OUTSIDE the helper when calling it, OR use a `Group` wrapper:

    Actually, the cleanest approach is to NOT use `.if()` and instead have the caller wrap the result:

    ```swift
    @ViewBuilder
    private func cardView(for item: ClipboardItem, at index: Int) -> some View {
        let badge: Int? = quickPasteEnabled && index < 9 ? index + 1 : nil
        ClipboardCardView(
            item: item,
            isSelected: selectedIndex == index,
            allLabels: allLabels,
            badgePosition: badge,
            isDropTarget: dropTargetIndex == index,
            isShiftHeld: isShiftHeld
        )
        .onDrag {
            onDragStarted?()
            return DragItemProviderService.createItemProvider(for: item)
        }
        .onTapGesture(count: 2) {
            if NSEvent.modifierFlags.contains(.shift) {
                onPastePlainText(item)
            } else {
                onPaste(item)
            }
        }
        .onTapGesture(count: 1) {
            selectedIndex = index
        }
        .dropDestination(for: String.self) { strings, _ in
            guard let encodedID = strings.first,
                  let labelID = PersistentIdentifier.fromTransferString(encodedID),
                  let label = try? modelContext.model(for: labelID) as? Label else {
                return false
            }
            guard !item.labels.contains(where: {
                $0.persistentModelID == label.persistentModelID
            }) else { return true }
            item.labels.append(label)
            saveWithLogging(modelContext, operation: "label drop assignment")
            return true
        } isTargeted: { targeted in
            withAnimation(.easeInOut(duration: 0.15)) {
                dropTargetIndex = targeted ? index : nil
            }
        }
        .id(index)
    }
    ```

    Then update the body to use the helper:

    **Horizontal branch:**
    ```swift
    ForEach(Array(filteredItems.enumerated()), id: \.element.id) { index, item in
        cardView(for: item, at: index)
            .frame(width: 260, height: 195)
            .clipped()
    }
    ```

    **Vertical branch:**
    ```swift
    ForEach(Array(filteredItems.enumerated()), id: \.element.id) { index, item in
        cardView(for: item, at: index)
    }
    ```

    This eliminates ~50 lines of duplication. The `.frame()` and `.clipped()` modifiers that differentiate horizontal from vertical are applied by the caller, not the shared helper.

    Place the `cardView(for:at:)` method in a `// MARK: - Private Helpers` section alongside the existing `installArrowKeyMonitor()` and `moveSelection(by:)` methods.
  </action>
  <verify>
    Build: `cd /Users/phulsechinmay/Desktop/Projects/pastel && xcodebuild build -scheme Pastel -destination 'platform=macOS' -quiet 2>&1 | tail -5`
    Verify shared helper exists: `grep "private func cardView" Pastel/Views/Panel/FilteredCardListView.swift` should return 1 match.
    Verify no duplicate ClipboardCardView init in body: count `ClipboardCardView(` occurrences in the file body (should be exactly 1, inside the helper -- grep for it).
    Verify the file compiles and card rendering logic appears once.
  </verify>
  <done>
    Horizontal and vertical card rendering branches share a single `cardView(for:at:)` @ViewBuilder helper. ~50 lines of duplication eliminated. Only the horizontal-specific `.frame()` and `.clipped()` modifiers remain at the call site. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild build -scheme Pastel -destination 'platform=macOS' -quiet` succeeds
2. `grep "@Query" Pastel/Views/Panel/ClipboardCardView.swift` returns nothing
3. `grep "itemCount" Pastel/Views/Panel/PanelContentView.swift` returns nothing
4. `grep "lockFocus\|unlockFocus" Pastel/Views/Panel/ClipboardCardView.swift` returns nothing
5. `grep -c "ClipboardCardView(" Pastel/Views/Panel/FilteredCardListView.swift` returns 1 (only in the shared helper)
6. `grep "let allLabels:" Pastel/Views/Panel/ClipboardCardView.swift` returns 1
</verification>

<success_criteria>
- ClipboardCardView has zero @Query declarations
- All ClipboardCardView callers pass allLabels parameter
- PanelContentView .id() does not reference itemCount
- NSImage.lockFocus/unlockFocus replaced with modern API
- FilteredCardListView card rendering is in a single @ViewBuilder helper
- A5 predicate investigation documented as accepted limitation
- Build compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/18-codebase-audit-anti-patterns-performance-and-security-encryption/18-03-SUMMARY.md`
</output>
