---
phase: 02-sliding-panel
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - Pastel/Views/Panel/ClipboardCardView.swift
  - Pastel/Views/Panel/TextCardView.swift
  - Pastel/Views/Panel/ImageCardView.swift
  - Pastel/Views/Panel/URLCardView.swift
  - Pastel/Views/Panel/FileCardView.swift
  - Pastel/Views/Panel/AsyncThumbnailView.swift
  - Pastel/Extensions/NSWorkspace+AppIcon.swift
  - Pastel/Views/Panel/PanelContentView.swift
  - project.yml
autonomous: true

must_haves:
  truths:
    - "Text cards show 2-3 lines of text preview content"
    - "Image cards show the 200px thumbnail loaded asynchronously from disk"
    - "URL cards show globe icon and URL text in accent color, visually distinct from text cards"
    - "File cards show file name or path"
    - "Each card shows the source app icon (small, left side) when available"
    - "Each card shows relative timestamp (e.g. '2m ago')"
    - "Cards are ~70-90px tall with rounded corners and hover states"
  artifacts:
    - path: "Pastel/Views/Panel/ClipboardCardView.swift"
      provides: "Card dispatcher that routes to type-specific subviews"
      contains: "switch.*type"
    - path: "Pastel/Views/Panel/TextCardView.swift"
      provides: "Text/richText card with multi-line preview"
      contains: "lineLimit"
    - path: "Pastel/Views/Panel/ImageCardView.swift"
      provides: "Image card with async thumbnail loading"
      contains: "AsyncThumbnailView"
    - path: "Pastel/Views/Panel/URLCardView.swift"
      provides: "URL card with globe icon and accent color"
      contains: "link"
    - path: "Pastel/Views/Panel/FileCardView.swift"
      provides: "File card with file name/path display"
      contains: "doc"
    - path: "Pastel/Views/Panel/AsyncThumbnailView.swift"
      provides: "Async disk-based thumbnail loader with placeholder"
      contains: "task.*id"
    - path: "Pastel/Extensions/NSWorkspace+AppIcon.swift"
      provides: "Bundle ID to app icon resolution"
      contains: "urlForApplication"
  key_links:
    - from: "Pastel/Views/Panel/PanelContentView.swift"
      to: "Pastel/Views/Panel/ClipboardCardView.swift"
      via: "ForEach(items) renders ClipboardCardView for each item"
      pattern: "ClipboardCardView"
    - from: "Pastel/Views/Panel/ClipboardCardView.swift"
      to: "Pastel/Views/Panel/TextCardView.swift"
      via: "switch dispatches .text/.richText to TextCardView"
      pattern: "TextCardView"
    - from: "Pastel/Views/Panel/ClipboardCardView.swift"
      to: "Pastel/Views/Panel/ImageCardView.swift"
      via: "switch dispatches .image to ImageCardView"
      pattern: "ImageCardView"
    - from: "Pastel/Views/Panel/ImageCardView.swift"
      to: "Pastel/Views/Panel/AsyncThumbnailView.swift"
      via: "ImageCardView uses AsyncThumbnailView to load thumbnail from disk"
      pattern: "AsyncThumbnailView"
    - from: "Pastel/Views/Panel/AsyncThumbnailView.swift"
      to: "Pastel/Services/ImageStorageService.swift"
      via: "Resolves thumbnail filename to URL via ImageStorageService.shared.resolveImageURL()"
      pattern: "resolveImageURL"
    - from: "Pastel/Views/Panel/ClipboardCardView.swift"
      to: "Pastel/Extensions/NSWorkspace+AppIcon.swift"
      via: "Card uses NSWorkspace.shared.appIcon(forBundleIdentifier:) for source app icon"
      pattern: "appIcon"
---

<objective>
Build all clipboard card views: type-specific subviews for text, image, URL, and file content with source app icons, relative timestamps, and async thumbnail loading. Replace the placeholder item list in PanelContentView with real card rendering.

Purpose: This transforms the panel from a structural shell into the visual clipboard history browser. Each content type gets a distinct visual treatment per the design spec: text shows multi-line preview, images show thumbnails, URLs have accent-colored link text, files show paths. Source app icons and relative timestamps provide context on every card.

Output: Fully rendered clipboard history cards in the sliding panel, with all 5 content types (text, richText, URL, image, file) displaying correctly.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sliding-panel/02-CONTEXT.md
@.planning/phases/02-sliding-panel/02-RESEARCH.md
@.planning/phases/02-sliding-panel/02-01-SUMMARY.md
@Pastel/Models/ClipboardItem.swift
@Pastel/Models/ContentType.swift
@Pastel/Services/ImageStorageService.swift
@Pastel/Views/Panel/PanelContentView.swift
@Pastel/Views/Panel/PanelController.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create card views for text, URL, and file content types with shared card chrome</name>
  <files>
    Pastel/Views/Panel/ClipboardCardView.swift
    Pastel/Views/Panel/TextCardView.swift
    Pastel/Views/Panel/URLCardView.swift
    Pastel/Views/Panel/FileCardView.swift
    Pastel/Extensions/NSWorkspace+AppIcon.swift
  </files>
  <action>
    **NSWorkspace+AppIcon.swift** -- Extension for resolving bundle ID to app icon:
    - Import AppKit.
    - `extension NSWorkspace` with method `func appIcon(forBundleIdentifier bundleID: String) -> NSImage?`.
    - Implementation: call `urlForApplication(withBundleIdentifier: bundleID)`, if nil return nil. Then call `icon(forFile: url.path)` and return the result.
    - This returns the app's icon at the system's default resolution. Cards display it at 20x20.

    **ClipboardCardView.swift** -- Dispatcher card view:
    - Import SwiftUI, AppKit.
    - `struct ClipboardCardView: View` accepting `let item: ClipboardItem`.
    - Body structure: `HStack(spacing: 8)` containing:
      1. **Source app icon** (left): If `item.sourceAppBundleID` is non-nil, resolve the app icon using `NSWorkspace.shared.appIcon(forBundleIdentifier:)`. Display as `Image(nsImage:)` at 20x20 frame, clipped to circle. If no bundleID, show a small generic `Image(systemName: "app")` in `.secondary` color at 16x16.
      2. **Content preview** (center, fills space): A `@ViewBuilder` computed property that switches on `item.type`:
         - `.text, .richText` -> `TextCardView(item: item)`
         - `.url` -> `URLCardView(item: item)`
         - `.image` -> `ImageCardView(item: item)` (created in Task 2)
         - `.file` -> `FileCardView(item: item)`
      3. **Relative timestamp** (right): `Text(item.timestamp, format: .relative(presentation: .named))` in `.caption2` font, `.secondary` foreground.
    - Card chrome: `.padding(.horizontal, 12)`, `.padding(.vertical, 8)`.
    - Card height: Use a computed property based on content type -- `.image` gets 90pt, all others get 72pt.
    - Background: `.background(Color.white.opacity(0.06))` (subtle light layer for card separation on dark background).
    - Rounded corners: `.clipShape(RoundedRectangle(cornerRadius: 8))`.
    - Hover state: Add `@State private var isHovered = false` and `.onHover { isHovered = $0 }`. When hovered, change background to `Color.white.opacity(0.12)`. Use `.animation(.easeInOut(duration: 0.15), value: isHovered)` for smooth hover transition.

    **TextCardView.swift** -- Text/richText card content:
    - Import SwiftUI.
    - `struct TextCardView: View` accepting `let item: ClipboardItem`.
    - Body: `Text(item.textContent ?? "")` with `.font(.system(.body, design: .default))`, `.lineLimit(3)`, `.foregroundStyle(.primary)`, `.frame(maxWidth: .infinity, alignment: .leading)`.
    - This provides a 2-3 line text preview as specified.

    **URLCardView.swift** -- URL card content:
    - Import SwiftUI.
    - `struct URLCardView: View` accepting `let item: ClipboardItem`.
    - Body: `HStack(spacing: 4)` containing:
      1. `Image(systemName: "globe")` in `.font(.system(size: 14))` with `.foregroundStyle(Color.blue)` (accent color for URLs).
      2. `Text(item.textContent ?? "")` with `.font(.system(.body, design: .default))`, `.lineLimit(2)`, `.foregroundStyle(Color.blue)`.
    - `.frame(maxWidth: .infinity, alignment: .leading)`.

    **FileCardView.swift** -- File card content:
    - Import SwiftUI.
    - `struct FileCardView: View` accepting `let item: ClipboardItem`.
    - Body: `HStack(spacing: 4)` containing:
      1. `Image(systemName: "doc")` in `.font(.system(size: 14))` with `.foregroundStyle(.secondary)`.
      2. A VStack(alignment: .leading, spacing: 2) with:
         - File name (last path component): extract from `item.textContent` using `URL(fileURLWithPath:).lastPathComponent` or just `(item.textContent as NSString?)?.lastPathComponent ?? ""`. Display in `.body` font, `.primary` foreground, lineLimit(1).
         - Full path in `.caption` font, `.secondary` foreground, lineLimit(1), if the text differs from just the filename.
    - `.frame(maxWidth: .infinity, alignment: .leading)`.
  </action>
  <verify>
    Run `xcodegen generate && xcodebuild build -project Pastel.xcodeproj -scheme Pastel -destination 'platform=macOS' 2>&1 | tail -20` -- must compile. Note: ImageCardView is referenced in ClipboardCardView but created in Task 2. To avoid compile error, either:
    (a) Create a stub ImageCardView in this task that just shows a placeholder, OR
    (b) Create both tasks' files in sequence.
    Prefer option (a): create a minimal `ImageCardView.swift` stub with `struct ImageCardView: View { let item: ClipboardItem; var body: some View { Text("Image") } }` so ClipboardCardView compiles. Task 2 replaces this stub.
  </verify>
  <done>
    ClipboardCardView dispatches to TextCardView, URLCardView, FileCardView, and stub ImageCardView. NSWorkspace+AppIcon resolves bundle IDs to app icons. Text cards show 3-line preview. URL cards show blue globe icon + URL text. File cards show filename and path. Cards have rounded corners, hover states, and relative timestamps. Compiles successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ImageCardView with async thumbnail loading and wire cards into PanelContentView</name>
  <files>
    Pastel/Views/Panel/AsyncThumbnailView.swift
    Pastel/Views/Panel/ImageCardView.swift
    Pastel/Views/Panel/PanelContentView.swift
  </files>
  <action>
    **AsyncThumbnailView.swift** -- Async disk-based thumbnail loader:
    - Import SwiftUI, AppKit.
    - `struct AsyncThumbnailView: View` with `let filename: String` and `@State private var image: NSImage?`.
    - Body: `Group` containing:
      1. If `image` is non-nil: `Image(nsImage: image)` with `.resizable()`, `.aspectRatio(contentMode: .fill)`.
      2. Else (placeholder): `Rectangle().fill(Color.white.opacity(0.05))` with an overlay of `ProgressView().scaleEffect(0.7)`.
    - `.task(id: filename)` modifier that calls `await loadThumbnail()` and assigns result to `image`.
    - Private `loadThumbnail() async -> NSImage?` method:
      1. Resolve the thumbnail URL: `ImageStorageService.shared.resolveImageURL(filename)`.
      2. Load on background thread: use `withCheckedContinuation` wrapping `DispatchQueue.global(qos: .userInitiated).async` that creates `NSImage(contentsOf: url)` and resumes with the result.
      3. Return the loaded image or nil.
    - This pattern avoids blocking the main thread during scroll.

    **ImageCardView.swift** -- Replace the stub from Task 1:
    - Import SwiftUI.
    - `struct ImageCardView: View` accepting `let item: ClipboardItem`.
    - Body: If `item.thumbnailPath` is non-nil, show `AsyncThumbnailView(filename: thumbnailPath)` with `.frame(maxWidth: .infinity, maxHeight: .infinity)`, clipped to `RoundedRectangle(cornerRadius: 4)`. The thumbnail should fill most of the card height (~74px content area within the 90px card).
    - If thumbnailPath is nil, show a fallback: `Image(systemName: "photo")` in `.secondary` color centered in the available space.

    **PanelContentView.swift** -- Replace placeholder with real cards:
    - Update the ForEach in the ScrollView/LazyVStack to use `ClipboardCardView(item: item)` instead of the placeholder Text.
    - The ForEach should iterate over `items` (from @Query).
    - Ensure `.id(item.id)` is used if needed for stable identity (ClipboardItem conforms to PersistentModel which has an `id`).
    - No other structural changes needed -- the header, empty state, ScrollView, and LazyVStack structure from Plan 01 remain intact.

    After all files are created/modified, run `xcodegen generate` to update the Xcode project.
  </action>
  <verify>
    1. Run `xcodegen generate && xcodebuild build -project Pastel.xcodeproj -scheme Pastel -destination 'platform=macOS' 2>&1 | tail -20` -- must compile without errors.
    2. Verify all card view files exist: `ls Pastel/Views/Panel/*CardView.swift Pastel/Views/Panel/AsyncThumbnailView.swift`.
    3. Verify PanelContentView uses ClipboardCardView: `grep 'ClipboardCardView' Pastel/Views/Panel/PanelContentView.swift` returns a match.
    4. Verify AsyncThumbnailView uses resolveImageURL: `grep 'resolveImageURL' Pastel/Views/Panel/AsyncThumbnailView.swift` returns a match.
  </verify>
  <done>
    All 5 content types render correctly in the panel: text cards show 3-line preview, image cards load thumbnails asynchronously from disk, URL cards show blue globe icon and link text, file cards show filename/path. PanelContentView uses ClipboardCardView for all items. AsyncThumbnailView loads from disk on a background thread with a loading placeholder. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `xcodegen generate && xcodebuild build -project Pastel.xcodeproj -scheme Pastel -destination 'platform=macOS'` succeeds
2. All card view files exist in `Pastel/Views/Panel/`
3. `NSWorkspace+AppIcon.swift` exists in `Pastel/Extensions/`
4. PanelContentView renders ClipboardCardView in its ForEach
5. ClipboardCardView dispatches to TextCardView, ImageCardView, URLCardView, FileCardView based on content type
6. AsyncThumbnailView loads thumbnails via ImageStorageService.resolveImageURL
7. URL cards use accent color (blue) and globe icon
8. Text cards show lineLimit(3)
9. Cards have hover states and rounded corners
10. Source app icon shown on each card
11. Relative timestamp shown on each card
</verification>

<success_criteria>
- App compiles with zero errors
- Text items show readable multi-line text preview (2-3 lines)
- Image items show thumbnail loaded asynchronously (no scroll jank)
- URL items are visually distinct with blue accent color and globe icon
- File items show file name and path
- Each card shows source app icon (small, left side) when available
- Each card shows relative timestamp ("2m ago" style)
- Cards are ~70-90px tall with rounded corners
- Cards have subtle hover effect
</success_criteria>

<output>
After completion, create `.planning/phases/02-sliding-panel/02-02-SUMMARY.md`
</output>
