---
phase: 09-quick-paste-hotkeys
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Pastel/Services/PasteService.swift
  - Pastel/App/AppState.swift
  - Pastel/Views/Panel/PanelController.swift
  - Pastel/Views/Panel/PanelContentView.swift
  - Pastel/Views/Panel/FilteredCardListView.swift
  - Pastel/Views/Settings/GeneralSettingsView.swift
autonomous: true

must_haves:
  truths:
    - "User opens panel, presses Cmd+3, and the 3rd visible item is pasted into the active app"
    - "User opens panel, presses Cmd+Shift+3, and the 3rd visible item is pasted as plain text (RTF stripped)"
    - "User disables quick paste in Settings and Cmd+1-9 no longer triggers paste"
    - "User filters by label, presses Cmd+1, and the first filtered item (not first overall) is pasted"
  artifacts:
    - path: "Pastel/Services/PasteService.swift"
      provides: "pastePlainText method that writes to NSPasteboard without RTF data"
      contains: "func pastePlainText"
    - path: "Pastel/App/AppState.swift"
      provides: "pastePlainText(item:) coordination method"
      contains: "func pastePlainText"
    - path: "Pastel/Views/Panel/FilteredCardListView.swift"
      provides: ".onKeyPress(characters: .decimalDigits) handler for Cmd+1-9 and Cmd+Shift+1-9"
      contains: ".onKeyPress(characters: .decimalDigits)"
    - path: "Pastel/Views/Settings/GeneralSettingsView.swift"
      provides: "Quick paste toggle under Hotkey section"
      contains: "quickPasteEnabled"
  key_links:
    - from: "FilteredCardListView.swift"
      to: "PanelContentView.swift"
      via: "onPastePlainText callback parameter"
      pattern: "onPastePlainText"
    - from: "PanelContentView.swift"
      to: "PanelActions"
      via: "panelActions.pastePlainTextItem?(item)"
      pattern: "pastePlainTextItem"
    - from: "PanelController.swift"
      to: "AppState.swift"
      via: "onPastePlainTextItem callback"
      pattern: "onPastePlainTextItem"
    - from: "AppState.swift"
      to: "PasteService.swift"
      via: "pasteService.pastePlainText()"
      pattern: "pastePlainText"
---

<objective>
Add panel-scoped quick paste hotkeys (Cmd+1-9 for normal paste, Cmd+Shift+1-9 for plain text paste) and a Settings toggle to enable/disable them.

Purpose: Users can instantly paste any of the first 9 visible items by pressing Cmd+N while the panel is open, without manual arrow key navigation. Cmd+Shift+N provides a "paste and match style" variant that strips RTF formatting.

Output: `.onKeyPress` handlers in FilteredCardListView, `pastePlainText` method on PasteService, plain text callback chain through PanelActions/PanelController/AppState, Settings toggle under Hotkey section.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-quick-paste-hotkeys/09-CONTEXT.md
@.planning/phases/09-quick-paste-hotkeys/09-RESEARCH.md
@Pastel/Services/PasteService.swift
@Pastel/App/AppState.swift
@Pastel/Views/Panel/PanelController.swift
@Pastel/Views/Panel/PanelContentView.swift
@Pastel/Views/Panel/FilteredCardListView.swift
@Pastel/Views/Settings/GeneralSettingsView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pastePlainText to PasteService and wire callback chain through AppState/PanelController/PanelActions</name>
  <files>
    Pastel/Services/PasteService.swift
    Pastel/App/AppState.swift
    Pastel/Views/Panel/PanelController.swift
  </files>
  <action>
**PasteService.swift** -- Add a `pastePlainText(item:clipboardMonitor:panelController:)` method alongside existing `paste()`. This method follows the SAME flow as `paste()` (check paste behavior, check accessibility, check secure input, write to pasteboard, set skipNextChange, hide panel, simulate Cmd+V after 250ms) but calls a new `writeToPasteboardPlainText(item:)` private method instead of `writeToPasteboard(item:)`.

The `writeToPasteboardPlainText(item:)` method writes to NSPasteboard.general but OMITS the `.rtf` data type:
- For `.text`, `.richText`, `.code`, `.color`: write `.string` and `.html` only. Do NOT write `.rtf` data. This is the key difference -- omitting RTF causes the receiving app to fall back to plain text styling.
- For `.url`, `.image`, `.file`: delegate to the existing `writeToPasteboard(item:)` since these types have no RTF to strip. Both paste modes are identical for non-text content.

Do NOT refactor the existing `paste()` method or `writeToPasteboard()`. Keep them untouched. The new plain text methods are additive.

**AppState.swift** -- Add `pastePlainText(item:)` method mirroring the existing `paste(item:)`:
```swift
func pastePlainText(item: ClipboardItem) {
    guard let clipboardMonitor else { return }
    pasteService.pastePlainText(item: item, clipboardMonitor: clipboardMonitor, panelController: panelController)
}
```

**PanelController.swift** -- Add a `pastePlainTextItem` property on `PanelActions` class (alongside existing `pasteItem`):
```swift
var pastePlainTextItem: ((ClipboardItem) -> Void)?
```

Add `onPastePlainTextItem` callback property on `PanelController` (alongside existing `onPasteItem`):
```swift
var onPastePlainTextItem: ((ClipboardItem) -> Void)?
```

Wire the new callback in the same 3 places where `onPasteItem` is wired:
1. In `show()` where `panelActions.pasteItem = onPasteItem`, add `panelActions.pastePlainTextItem = onPastePlainTextItem`
2. In `createPanel()` where `panelActions.pasteItem = onPasteItem`, add `panelActions.pastePlainTextItem = onPastePlainTextItem`

**AppState.swift** -- In `setupPanel(modelContainer:)`, wire the new callback alongside the existing one:
```swift
panelController.onPastePlainTextItem = { [weak self] item in
    self?.pastePlainText(item: item)
}
```
  </action>
  <verify>
Build the project with `xcodebuild build -scheme Pastel -destination 'platform=macOS'`. Verify no compilation errors.
  </verify>
  <done>
PasteService has `pastePlainText()` that writes to pasteboard without RTF. AppState has `pastePlainText(item:)`. PanelActions has `pastePlainTextItem` callback. PanelController wires `onPastePlainTextItem` to PanelActions in show() and createPanel(). The full callback chain is: FilteredCardListView -> PanelContentView -> PanelActions.pastePlainTextItem -> PanelController.onPastePlainTextItem -> AppState.pastePlainText -> PasteService.pastePlainText.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add .onKeyPress handlers for Cmd+1-9 and Cmd+Shift+1-9, wire onPastePlainText through FilteredCardListView and PanelContentView, add Settings toggle</name>
  <files>
    Pastel/Views/Panel/FilteredCardListView.swift
    Pastel/Views/Panel/PanelContentView.swift
    Pastel/Views/Settings/GeneralSettingsView.swift
  </files>
  <action>
**FilteredCardListView.swift** -- Add a new callback parameter `onPastePlainText: @escaping (ClipboardItem) -> Void` alongside the existing `onPaste`. Update the init to accept it and store it as a property.

Add `@AppStorage("quickPasteEnabled") private var quickPasteEnabled: Bool = true` at the top of the struct.

Add a new `.onKeyPress(characters: .decimalDigits)` handler AFTER the existing `.onKeyPress(.return)` handler. Implementation:

```swift
.onKeyPress(characters: .decimalDigits) { keyPress in
    // Only handle when Command is held and quick paste is enabled
    guard quickPasteEnabled, keyPress.modifiers.contains(.command) else { return .ignored }

    // Extract digit 1-9 (ignore 0)
    guard let digit = keyPress.characters.first,
          let number = digit.wholeNumberValue,
          number >= 1, number <= 9 else { return .ignored }

    let index = number - 1  // Convert 1-based to 0-based
    guard index < items.count else { return .ignored }

    let item = items[index]

    if keyPress.modifiers.contains(.shift) {
        // Cmd+Shift+N: Plain text paste
        onPastePlainText(item)
    } else {
        // Cmd+N: Normal paste (preserving formatting)
        onPaste(item)
    }

    return .handled
}
```

**PanelContentView.swift** -- Update the `FilteredCardListView(...)` call site to pass the new `onPastePlainText` parameter:

```swift
FilteredCardListView(
    searchText: debouncedSearchText,
    selectedLabelID: selectedLabel?.persistentModelID,
    selectedIndex: $selectedIndex,
    onPaste: { item in pasteItem(item) },
    onPastePlainText: { item in pastePlainTextItem(item) }
)
```

Add a new private helper method `pastePlainTextItem`:
```swift
private func pastePlainTextItem(_ item: ClipboardItem) {
    panelActions.pastePlainTextItem?(item)
}
```

**GeneralSettingsView.swift** -- Add `@AppStorage("quickPasteEnabled") private var quickPasteEnabled: Bool = true` at the top of the struct.

Add a quick paste toggle INSIDE the existing "Hotkey" section (section 2), below the KeyboardShortcuts.Recorder:

```swift
// 2. Panel toggle hotkey + Quick paste
VStack(alignment: .leading, spacing: 6) {
    Text("Hotkey")
        .font(.headline)
    KeyboardShortcuts.Recorder("Panel Toggle Hotkey:", name: .togglePanel)

    Toggle("Quick paste with \u{2318}1-9 while panel is open", isOn: $quickPasteEnabled)
        .toggleStyle(.switch)
    Text("Use \u{2318}N to paste the Nth item, \u{2318}\u{21E7}N to paste as plain text.")
        .font(.caption)
        .foregroundStyle(.secondary)
}
```

The `\u{2318}` is the command symbol (⌘) and `\u{21E7}` is the shift symbol (⇧). Using unicode escapes keeps the source clean.
  </action>
  <verify>
Build the project with `xcodebuild build -scheme Pastel -destination 'platform=macOS'`. Verify no compilation errors.
  </verify>
  <done>
FilteredCardListView has `.onKeyPress(characters: .decimalDigits)` that dispatches Cmd+1-9 to `onPaste` and Cmd+Shift+1-9 to `onPastePlainText`, gated by `@AppStorage("quickPasteEnabled")`. PanelContentView passes both callbacks. GeneralSettingsView has a toggle under the Hotkey section. When disabled, the handler returns `.ignored` and the key events propagate normally.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `xcodebuild build -scheme Pastel -destination 'platform=macOS'`
2. No warnings or errors related to the new code
3. Verify `PasteService.swift` has both `writeToPasteboard(item:)` and `writeToPasteboardPlainText(item:)` methods
4. Verify `FilteredCardListView.swift` has `.onKeyPress(characters: .decimalDigits)` handler
5. Verify `GeneralSettingsView.swift` has `quickPasteEnabled` toggle under Hotkey section
6. Verify callback chain: FilteredCardListView -> PanelContentView -> PanelActions -> PanelController -> AppState -> PasteService for both normal and plain text paths
</verification>

<success_criteria>
- Cmd+1-9 pastes the Nth visible item (normal paste with all formatting preserved)
- Cmd+Shift+1-9 pastes the Nth visible item as plain text (RTF stripped, HTML kept)
- Out-of-range digits (e.g., Cmd+7 when only 3 items exist) are silently ignored
- The `quickPasteEnabled` toggle in Settings disables both hotkey sets when off
- Existing keyboard navigation (arrow keys, Enter) is unaffected
- Panel closes after quick paste (same as Enter/double-click paste behavior)
</success_criteria>

<output>
After completion, create `.planning/phases/09-quick-paste-hotkeys/09-01-SUMMARY.md`
</output>
