---
phase: 18-codebase-audit-anti-patterns-performance-and-security-encryption
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Pastel/Services/SwiftDataHelpers.swift
  - Pastel/Services/MigrationService.swift
  - Pastel/Services/URLMetadataService.swift
  - Pastel/Views/Panel/ClipboardCardView.swift
  - Pastel/Views/Panel/ChipBarView.swift
  - Pastel/Views/Panel/FilteredCardListView.swift
  - Pastel/Views/Settings/HistoryBrowserView.swift
  - Pastel/Views/Settings/LabelSettingsView.swift
  - Pastel/Views/Panel/PanelController.swift
  - Pastel/App/AppState.swift
  - Pastel/Services/PasteService.swift
autonomous: true

must_haves:
  truths:
    - "All 17 silent try? modelContext.save() calls are replaced with a shared error handler that logs failures via OSLog"
    - "Debug timing logs in PanelController.show() are removed"
    - "Temporary DistributedNotification observer for togglePanel in AppState.setupPanel() is removed"
    - "HistoryBrowserView.bulkPaste() calls PasteService.simulatePaste() instead of duplicating CGEvent logic inline"
  artifacts:
    - path: "Pastel/Services/SwiftDataHelpers.swift"
      provides: "saveWithLogging(@MainActor function) for shared SwiftData error handling"
      contains: "func saveWithLogging"
    - path: "Pastel/Services/PasteService.swift"
      provides: "Public static simulatePaste() method accessible to HistoryBrowserView"
      contains: "static func simulatePaste"
  key_links:
    - from: "Pastel/Views/Settings/HistoryBrowserView.swift"
      to: "Pastel/Services/PasteService.swift"
      via: "PasteService.simulatePaste() call in bulkPaste()"
      pattern: "PasteService\\.simulatePaste"
    - from: "All views with modelContext.save()"
      to: "Pastel/Services/SwiftDataHelpers.swift"
      via: "saveWithLogging() calls"
      pattern: "saveWithLogging"
---

<objective>
Create a shared SwiftData error handler, replace all 17 silent `try? modelContext.save()` calls with logged error handling, remove debug artifacts from production code, and extract duplicated CGEvent paste simulation to use the canonical PasteService implementation.

Purpose: Eliminate silent error swallowing (A3), remove debug/temporary code (A7), and consolidate duplicated paste simulation logic (A2). These are foundational cleanup items that improve debuggability and code maintainability.

Output: SwiftDataHelpers.swift utility, updated save calls across 8 files, cleaned PanelController/AppState, refactored HistoryBrowserView.bulkPaste().
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-codebase-audit-anti-patterns-performance-and-security-encryption/18-RESEARCH.md

Source files to modify:
@Pastel/Services/MigrationService.swift
@Pastel/Services/URLMetadataService.swift
@Pastel/Views/Panel/ClipboardCardView.swift
@Pastel/Views/Panel/ChipBarView.swift
@Pastel/Views/Panel/FilteredCardListView.swift
@Pastel/Views/Settings/HistoryBrowserView.swift
@Pastel/Views/Settings/LabelSettingsView.swift
@Pastel/Views/Panel/PanelController.swift
@Pastel/App/AppState.swift
@Pastel/Services/PasteService.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create saveWithLogging utility and replace all 17 try? modelContext.save() calls</name>
  <files>
    Pastel/Services/SwiftDataHelpers.swift
    Pastel/Services/MigrationService.swift
    Pastel/Services/URLMetadataService.swift
    Pastel/Views/Panel/ClipboardCardView.swift
    Pastel/Views/Panel/ChipBarView.swift
    Pastel/Views/Panel/FilteredCardListView.swift
    Pastel/Views/Settings/HistoryBrowserView.swift
    Pastel/Views/Settings/LabelSettingsView.swift
  </files>
  <action>
    1. Create `Pastel/Services/SwiftDataHelpers.swift` with a `@MainActor` free function:
       ```swift
       import SwiftData
       import OSLog

       private let swiftDataLogger = Logger(
           subsystem: Bundle.main.bundleIdentifier ?? "app.pastel.Pastel",
           category: "SwiftData"
       )

       @MainActor
       func saveWithLogging(_ modelContext: ModelContext, operation: String) {
           do {
               try modelContext.save()
           } catch {
               swiftDataLogger.error("Save failed during \(operation): \(error.localizedDescription)")
           }
       }
       ```

    2. Replace every `try? modelContext.save()` across all 8 files with `saveWithLogging(modelContext, operation: "description")`. Use a context-appropriate operation string for each call site:

       **MigrationService.swift** (1 occurrence):
       - Line 24: `try? modelContext.save()` -> `saveWithLogging(modelContext, operation: "label migration")`

       **URLMetadataService.swift** (4 occurrences):
       - Line 93: -> `saveWithLogging(modelContext, operation: "URL metadata fetch")`
       - Line 100: -> `saveWithLogging(modelContext, operation: "URL metadata failure")`
       - Line 137: -> `saveWithLogging(modelContext, operation: "URL favicon save")`
       - Line 202: -> `saveWithLogging(modelContext, operation: "URL preview image save")`

       **ClipboardCardView.swift** (3 occurrences):
       - Line 184: -> `saveWithLogging(modelContext, operation: "label toggle")`
       - Line 200: -> `saveWithLogging(modelContext, operation: "remove all labels")`
       - Line 234: -> `saveWithLogging(modelContext, operation: "delete item")`

       **ChipBarView.swift** (1 occurrence):
       - Line 204: -> `saveWithLogging(modelContext, operation: "label reorder")`

       **FilteredCardListView.swift** (2 occurrences):
       - Line 150: -> `saveWithLogging(modelContext, operation: "label drop assignment")`
       - Line 209: -> `saveWithLogging(modelContext, operation: "label drop assignment")`

       **HistoryBrowserView.swift** (1 occurrence):
       - Line 179: -> `saveWithLogging(modelContext, operation: "bulk delete")`

       **LabelSettingsView.swift** (5 occurrences):
       - Line 66: -> `saveWithLogging(modelContext, operation: "create label")`
       - Line 71: -> `saveWithLogging(modelContext, operation: "delete label")`
       - Line 123: -> `saveWithLogging(modelContext, operation: "update label name")`
       - Line 170: -> `saveWithLogging(modelContext, operation: "update label emoji")`
       - Line 195: -> `saveWithLogging(modelContext, operation: "update label color")`

    3. Add `SwiftDataHelpers.swift` to the Xcode project by including it in project.yml under the Pastel target sources (if XcodeGen is used), OR verify it's auto-included by the existing directory-based source inclusion.

    IMPORTANT: The function signature is `saveWithLogging(_ modelContext: ModelContext, operation: String)`. The first parameter has no label (underscore). Every call site must pass `modelContext` as the first argument and a descriptive string as the second.

    Do NOT change `try modelContext.save()` calls (without the `?`) in ImportExportService.swift or ClipboardMonitor.swift -- those already use proper do/catch error handling.
  </action>
  <verify>
    Build the project with `cd /Users/phulsechinmay/Desktop/Projects/pastel && xcodebuild build -scheme Pastel -destination 'platform=macOS' -quiet 2>&1 | tail -5`
    Verify zero occurrences of `try? modelContext.save()`: `grep -r "try? modelContext.save()" Pastel/ | wc -l` should be 0.
    Verify 17 occurrences of `saveWithLogging`: `grep -r "saveWithLogging" Pastel/ --include="*.swift" | grep -v "func saveWithLogging" | wc -l` should be 17.
  </verify>
  <done>
    All 17 `try? modelContext.save()` calls replaced with `saveWithLogging(modelContext, operation:)`. SwiftDataHelpers.swift exists with the shared error handler. Build succeeds. No remaining silent try? save calls.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove debug logs, temporary observer, and extract duplicated paste simulation</name>
  <files>
    Pastel/Views/Panel/PanelController.swift
    Pastel/App/AppState.swift
    Pastel/Services/PasteService.swift
    Pastel/Views/Settings/HistoryBrowserView.swift
  </files>
  <action>
    **A7: Remove debug timing logs from PanelController.show()**

    In `PanelController.swift`, remove the two `DispatchQueue.main.asyncAfter` debug blocks near lines 211-216:
    ```swift
    // DELETE these lines:
    DispatchQueue.main.asyncAfter(deadline: .now() + 0.2) { [weak self] in
        self?.logger.info("200ms later: isActive=\(NSApp.isActive), panel.isKey=\(panel.isKeyWindow)")
    }
    DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) { [weak self] in
        self?.logger.info("500ms later: isActive=\(NSApp.isActive), panel.isKey=\(panel.isKeyWindow)")
    }
    ```
    Keep the `logger.info("Panel shown on...")` and `logger.info("Panel windowNumber...")` lines -- those are useful production logs.

    **A7: Remove temporary DistributedNotification observer from AppState.setupPanel()**

    In `AppState.swift`, remove the entire block at lines 92-101:
    ```swift
    // DELETE these lines (including the comment):
    // TEMPORARY: Allow toggling panel via DistributedNotification (for automated testing loop)
    // Remove after liquid glass fix is verified
    DistributedNotificationCenter.default().addObserver(
        forName: .init("app.pastel.togglePanel"),
        object: nil, queue: .main
    ) { [weak self] _ in
        MainActor.assumeIsolated {
            self?.togglePanel()
        }
    }
    ```

    **A2: Make PasteService.simulatePaste() accessible and use it from HistoryBrowserView**

    1. In `PasteService.swift`, change `simulatePaste()` from `private static` to just `static` (remove `private`):
       ```swift
       // BEFORE:
       private static func simulatePaste() {
       // AFTER:
       static func simulatePaste() {
       ```
       Keep the entire implementation unchanged. The method is already `static` and `@MainActor` (inherited from the class).

    2. In `HistoryBrowserView.swift`, replace the inline CGEvent paste simulation in `bulkPaste()` (lines 144-153):
       ```swift
       // BEFORE:
       DispatchQueue.main.asyncAfter(deadline: .now() + 0.35) {
           let source = CGEventSource(stateID: .combinedSessionState)
           let vKeyCode: CGKeyCode = 0x09
           let keyDown = CGEvent(keyboardEventSource: source, virtualKey: vKeyCode, keyDown: true)
           let keyUp = CGEvent(keyboardEventSource: source, virtualKey: vKeyCode, keyDown: false)
           keyDown?.flags = .maskCommand
           keyUp?.flags = .maskCommand
           keyDown?.post(tap: .cgSessionEventTap)
           keyUp?.post(tap: .cgSessionEventTap)
       }

       // AFTER:
       DispatchQueue.main.asyncAfter(deadline: .now() + 0.35) {
           PasteService.simulatePaste()
       }
       ```

    3. Remove the now-unused `import CoreGraphics` and `import Carbon` from HistoryBrowserView.swift if they were only needed for the CGEvent code. Check if any other code in the file uses these imports before removing.
  </action>
  <verify>
    Build the project: `cd /Users/phulsechinmay/Desktop/Projects/pastel && xcodebuild build -scheme Pastel -destination 'platform=macOS' -quiet 2>&1 | tail -5`
    Verify no debug timing logs: `grep -n "200ms later\|500ms later" Pastel/Views/Panel/PanelController.swift` should return nothing.
    Verify no temporary observer: `grep -n "app.pastel.togglePanel" Pastel/App/AppState.swift` should return nothing.
    Verify PasteService call in HistoryBrowserView: `grep "PasteService.simulatePaste" Pastel/Views/Settings/HistoryBrowserView.swift` should return 1 match.
    Verify no inline CGEvent in HistoryBrowserView: `grep "CGEventSource\|CGEvent(" Pastel/Views/Settings/HistoryBrowserView.swift` should return nothing.
  </verify>
  <done>
    Debug timing logs removed from PanelController.show(). Temporary DistributedNotification observer removed from AppState.setupPanel(). HistoryBrowserView.bulkPaste() calls PasteService.simulatePaste() instead of duplicating CGEvent logic. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild build -scheme Pastel -destination 'platform=macOS' -quiet` succeeds with no errors
2. `grep -r "try? modelContext.save()" Pastel/` returns zero matches
3. `grep -r "saveWithLogging" Pastel/ --include="*.swift" | grep -v "func saveWithLogging" | wc -l` returns 17
4. `grep -n "200ms later\|500ms later\|app.pastel.togglePanel" Pastel/Views/Panel/PanelController.swift Pastel/App/AppState.swift` returns nothing
5. `grep "PasteService.simulatePaste" Pastel/Views/Settings/HistoryBrowserView.swift` returns 1 match
</verification>

<success_criteria>
- Zero silent `try? modelContext.save()` calls remain in codebase
- All SwiftData save operations log errors via OSLog on failure
- No debug timing logs in PanelController
- No temporary DistributedNotification observer in AppState
- Paste simulation logic exists in exactly one place (PasteService.simulatePaste)
- Build compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/18-codebase-audit-anti-patterns-performance-and-security-encryption/18-01-SUMMARY.md`
</output>
