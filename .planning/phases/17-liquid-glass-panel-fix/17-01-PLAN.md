---
phase: 17-liquid-glass-panel-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Pastel/Views/Panel/PanelController.swift
autonomous: false

must_haves:
  truths:
    - "Panel window number is accessible for screencapture -l command"
    - "Panel shows full Liquid Glass (lensing, refraction, specular highlights) when triggered via Option+V hotkey"
    - "Panel glass appearance is visually identical when triggered via hotkey vs DistributedNotification"
    - "Debug logs confirm NSApp.isActive=true at all checkpoints (before, after, 200ms, 500ms) while panel is visible"
  artifacts:
    - path: "Pastel/Views/Panel/PanelController.swift"
      provides: "Public panelWindowNumber property for screencapture"
      contains: "panelWindowNumber"
  key_links:
    - from: "PanelController.show()"
      to: "NSApp.activate()"
      via: "Activation ensures full glass rendering"
      pattern: "NSApp\\.activate"
    - from: "PanelController.panelWindowNumber"
      to: "screencapture -l"
      via: "Window ID enables targeted screenshot capture"
      pattern: "windowNumber"
---

<objective>
Verify that the sliding panel renders full Liquid Glass when triggered via the global hotkey, and that the glass quality matches when triggered via DistributedNotification.

Purpose: This is the primary success criterion for Phase 17 -- proving the existing NSGlassEffectView + NSApp.activate() implementation works correctly. All code is already implemented; this plan verifies it visually and captures proof.
Output: PanelController with exposed window number, screenshots proving glass renders correctly, log evidence of activation state.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-liquid-glass-panel-fix/17-RESEARCH.md
@Pastel/Views/Panel/PanelController.swift
@Pastel/Views/Panel/SlidingPanel.swift
@Pastel/Views/Panel/PanelContentView.swift
@Pastel/App/AppState.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expose panel window ID and build verification harness</name>
  <files>Pastel/Views/Panel/PanelController.swift</files>
  <action>
**1. Add panelWindowNumber property to PanelController:**

Add a public computed property after the existing `isVisible` property (around line 80):

```swift
/// The CGWindowID of the panel, used for `screencapture -l` during visual verification.
var panelWindowNumber: Int {
    panel?.windowNumber ?? 0
}
```

This allows external callers (and Console.app log inspection) to get the window ID needed for `screencapture -l$WINDOW_ID -x -o /tmp/panel.png`.

**2. Log the window number on show():**

In PanelController.show(), right after the existing `logger.info("Panel shown on \(edge.rawValue) edge...")` line (around line 191), add:

```swift
logger.info("Panel windowNumber (for screencapture -l): \(panel.windowNumber)")
```

This logs the window ID to Console.app so the user can grab it for screenshot comparison without needing code changes.

**3. Build the project:**

Run `xcodebuild build -scheme Pastel -destination 'platform=macOS'` to verify the project compiles cleanly. This confirms all existing code plus the new property compiles without errors.

Do NOT modify any other files. The only change is adding the computed property and one log line to PanelController.swift.
  </action>
  <verify>
`xcodebuild build -scheme Pastel -destination 'platform=macOS'` completes with zero errors. Grep PanelController.swift for `panelWindowNumber` to confirm the property exists.
  </verify>
  <done>PanelController has a public `panelWindowNumber` computed property. The window number is logged on every show(). Project builds cleanly.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of Liquid Glass rendering</name>
  <what-built>The panel now logs its window number to Console.app on each show(). The implementation from quick tasks 017/018 (NSGlassEffectView, NSApp.activate() on show, previousApp.activate() on hide, DistributedNotification hotkey routing) is already complete.</what-built>
  <how-to-verify>
**Step 1: Launch the app**
Build and run Pastel from Xcode (Cmd+R). Open Console.app and filter by process "Pastel" and category "PanelController".

**Step 2: Verify glass via hotkey**
1. Make sure another app (e.g., TextEdit or Safari) is in the foreground with visible content behind where the panel will appear
2. Press Option+V (or your configured hotkey) to open the panel
3. Look at the panel background -- it should show full Liquid Glass: lensing (content behind is magnified/distorted), refraction effects, specular highlights on the glass surface. NOT a flat dark blur.
4. Check Console.app logs:
   - "Before activate: isActive=..." should show the pre-activation state
   - "After activate: isActive=true" -- activation succeeded
   - "200ms later: isActive=true, panel.isKey=true" -- still active
   - "500ms later: isActive=true, panel.isKey=true" -- still active
   - "Panel windowNumber (for screencapture -l): XXXX" -- note the number
5. Press Escape to dismiss

**Step 3: Capture screenshots for comparison**
1. Open Terminal
2. Press Option+V to show the panel
3. Wait 1 second for glass to fully render
4. Run: `screencapture -l$(WINDOW_NUMBER_FROM_LOGS) -x -o /tmp/panel-hotkey.png`
   (Replace WINDOW_NUMBER_FROM_LOGS with the actual number from Console)
5. Press Escape to dismiss
6. From Terminal, trigger via notification:
   ```bash
   /usr/bin/swift -e 'import Foundation; DistributedNotificationCenter.default().post(name: .init("app.pastel.togglePanel"), object: nil)'
   ```
7. Wait 1 second, then run: `screencapture -l$(WINDOW_NUMBER) -x -o /tmp/panel-notification.png`
8. Press Escape to dismiss
9. Compare: `open /tmp/panel-hotkey.png /tmp/panel-notification.png`
   - Both should show the same glass quality
   - Minor pixel differences are acceptable if glass effect is visually equivalent

**Step 4: Evaluate**
- If glass looks correct in both cases: type "approved"
- If glass is degraded (dark blur, no lensing): describe what you see
- If hotkey and notification differ visually: describe the difference

**Note:** If `screencapture -l` produces blank/black images, Terminal may need Screen Recording permission in System Settings > Privacy & Security > Screen Recording.
  </how-to-verify>
  <resume-signal>Type "approved" if glass renders correctly via both hotkey and notification trigger, or describe the issue if it does not.</resume-signal>
</task>

</tasks>

<verification>
1. `xcodebuild build -scheme Pastel -destination 'platform=macOS'` completes with zero errors
2. Console.app shows `panelWindowNumber` log on panel show
3. Console.app shows `isActive=true` at all checkpoints during panel visibility
4. Visual inspection confirms full Liquid Glass (lensing, refraction, specular highlights)
5. Screenshot comparison confirms matching glass quality between hotkey and notification triggers
</verification>

<success_criteria>
- PanelController exposes panelWindowNumber and logs it on show()
- User visually confirms full Liquid Glass rendering via hotkey trigger
- Screenshots captured via both hotkey and notification triggers show matching glass quality
- Debug logs confirm NSApp.isActive=true throughout panel visibility
</success_criteria>

<output>
After completion, create `.planning/phases/17-liquid-glass-panel-fix/17-01-SUMMARY.md`
</output>
