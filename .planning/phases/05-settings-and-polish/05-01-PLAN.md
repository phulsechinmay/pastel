---
phase: 05-settings-and-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Pastel/Models/PanelEdge.swift
  - Pastel/Views/Panel/PanelController.swift
  - Pastel/Views/Settings/SettingsWindowController.swift
  - Pastel/Views/Settings/SettingsView.swift
  - Pastel/Views/Settings/GeneralSettingsView.swift
  - Pastel/Views/Settings/ScreenEdgePicker.swift
  - Pastel/Services/RetentionService.swift
  - Pastel/App/AppState.swift
  - Pastel/PastelApp.swift
  - Pastel/Views/Panel/PanelContentView.swift
  - Pastel/Views/MenuBar/StatusPopoverView.swift
autonomous: true

must_haves:
  truths:
    - "User opens Settings from the gear icon in the panel header"
    - "User opens Settings from the menu bar popover"
    - "Settings window shows General tab with launch at login toggle, hotkey recorder, panel position picker, and retention dropdown"
    - "User toggles launch at login and the setting persists"
    - "User records a custom hotkey and it replaces the default Cmd+Shift+V"
    - "User selects a different panel edge and the panel appears at that edge on next toggle"
    - "User sets history retention and old items are auto-purged"
  artifacts:
    - path: "Pastel/Models/PanelEdge.swift"
      provides: "PanelEdge enum with frame calculation methods"
      contains: "enum PanelEdge"
    - path: "Pastel/Views/Settings/SettingsWindowController.swift"
      provides: "Singleton NSWindow manager for settings"
      contains: "class SettingsWindowController"
    - path: "Pastel/Views/Settings/SettingsView.swift"
      provides: "Root settings view with custom tab bar"
      contains: "struct SettingsView"
    - path: "Pastel/Views/Settings/GeneralSettingsView.swift"
      provides: "General tab with all 4 settings controls"
      contains: "LaunchAtLogin"
    - path: "Pastel/Views/Settings/ScreenEdgePicker.swift"
      provides: "Visual screen diagram with clickable edges"
      contains: "struct ScreenEdgePicker"
    - path: "Pastel/Services/RetentionService.swift"
      provides: "History auto-purge based on retention setting"
      contains: "class RetentionService"
  key_links:
    - from: "Pastel/Views/Panel/PanelContentView.swift"
      to: "SettingsWindowController.shared.showSettings"
      via: "gear icon button in header"
      pattern: "SettingsWindowController\\.shared\\.showSettings"
    - from: "Pastel/Views/MenuBar/StatusPopoverView.swift"
      to: "SettingsWindowController.shared.showSettings"
      via: "Settings button in popover"
      pattern: "SettingsWindowController\\.shared\\.showSettings"
    - from: "Pastel/Views/Panel/PanelController.swift"
      to: "PanelEdge"
      via: "UserDefaults read for current edge"
      pattern: "PanelEdge.*rawValue"
    - from: "Pastel/App/AppState.swift"
      to: "RetentionService"
      via: "startPeriodicPurge called during setup"
      pattern: "retentionService.*startPeriodicPurge"
---

<objective>
Settings window infrastructure, General tab with all 4 settings, PanelEdge enum, PanelController refactor for all 4 edges, RetentionService, and access point wiring.

Purpose: Delivers the settings window (INFR-03), launch at login (INFR-02), and panel position configuration (PNUI-03) -- all 3 success criteria for Phase 5. Plan 02 handles the Labels tab and horizontal panel layout adaptation.

Output: Working settings window accessible from gear icon and menu bar, with General tab containing launch at login toggle, hotkey recorder, visual panel position picker, and history retention dropdown. PanelController supports all 4 screen edges.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-settings-and-polish/05-RESEARCH.md
@.planning/phases/05-settings-and-polish/05-CONTEXT.md
@Pastel/Views/Panel/PanelController.swift
@Pastel/App/AppState.swift
@Pastel/PastelApp.swift
@Pastel/Views/Panel/PanelContentView.swift
@Pastel/Views/MenuBar/StatusPopoverView.swift
@Pastel/Views/Onboarding/AccessibilityPromptView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: PanelEdge enum + PanelController refactor for 4 edges</name>
  <files>
    Pastel/Models/PanelEdge.swift
    Pastel/Views/Panel/PanelController.swift
  </files>
  <action>
**Create `Pastel/Models/PanelEdge.swift`:**

Define a `PanelEdge` enum that drives all frame calculations. This replaces the hard-coded right-edge logic in PanelController.

```swift
import AppKit

enum PanelEdge: String, CaseIterable {
    case left, right, top, bottom

    var isVertical: Bool { self == .left || self == .right }

    func panelSize(screenFrame: NSRect) -> NSSize {
        if isVertical {
            return NSSize(width: 320, height: screenFrame.height)
        } else {
            return NSSize(width: screenFrame.width, height: 300)
        }
    }

    func onScreenFrame(screenFrame: NSRect) -> NSRect {
        let size = panelSize(screenFrame: screenFrame)
        switch self {
        case .right:
            return NSRect(x: screenFrame.maxX - size.width, y: screenFrame.origin.y,
                          width: size.width, height: size.height)
        case .left:
            return NSRect(x: screenFrame.origin.x, y: screenFrame.origin.y,
                          width: size.width, height: size.height)
        case .top:
            return NSRect(x: screenFrame.origin.x, y: screenFrame.maxY - size.height,
                          width: size.width, height: size.height)
        case .bottom:
            return NSRect(x: screenFrame.origin.x, y: screenFrame.origin.y,
                          width: size.width, height: size.height)
        }
    }

    func offScreenFrame(screenFrame: NSRect) -> NSRect {
        let size = panelSize(screenFrame: screenFrame)
        switch self {
        case .right:
            return NSRect(x: screenFrame.maxX, y: screenFrame.origin.y,
                          width: size.width, height: size.height)
        case .left:
            return NSRect(x: screenFrame.origin.x - size.width, y: screenFrame.origin.y,
                          width: size.width, height: size.height)
        case .top:
            return NSRect(x: screenFrame.origin.x, y: screenFrame.maxY,
                          width: size.width, height: size.height)
        case .bottom:
            return NSRect(x: screenFrame.origin.x, y: screenFrame.origin.y - size.height,
                          width: size.width, height: size.height)
        }
    }
}
```

**Modify `Pastel/Views/Panel/PanelController.swift`:**

1. Remove the hard-coded `panelWidth` constant.
2. Add a helper to read the current edge from UserDefaults:
   ```swift
   private var currentEdge: PanelEdge {
       PanelEdge(rawValue: UserDefaults.standard.string(forKey: "panelEdge") ?? "right") ?? .right
   }
   ```
3. Refactor `show()` to use `currentEdge.onScreenFrame(screenFrame:)` and `currentEdge.offScreenFrame(screenFrame:)` instead of the hard-coded right-edge NSRect calculations.
4. Refactor `hide()` to use `currentEdge.offScreenFrame(screenFrame:)` for the slide-out target frame. Use `panel.screen?.frame` (already done) for the screen reference.
5. Add a `handleEdgeChange()` method that: (a) if the panel is visible, hides it immediately; (b) sets `panel = nil` to force recreation (content layout may differ for vertical vs horizontal); (c) logs the edge change.
6. In `show()`, before creating the panel, check if the panel's current frame orientation (vertical vs horizontal) matches the current edge. If not, destroy and recreate the panel. This handles the case where the edge changed while the panel was hidden.
7. Keep the `animationDuration`, event monitors, `screenWithMouse()`, `createPanel()`, and all other logic the same. Only the frame calculation in `show()`/`hide()` changes.

**Important:** The `createPanel()` method stays the same for now -- horizontal layout adaptation will be handled in Plan 02 by modifying FilteredCardListView/PanelContentView to read the panel edge and adapt layout dynamically.
  </action>
  <verify>
Run `cd /Users/phulsechinmay/Desktop/Projects/pastel && xcodebuild -scheme Pastel -destination 'platform=macOS' build 2>&1 | tail -5` -- must compile with zero errors. Verify PanelEdge.swift exists and PanelController.swift no longer has hard-coded `screenFrame.maxX - panelWidth` calculations.
  </verify>
  <done>
PanelEdge enum exists with `onScreenFrame`/`offScreenFrame` methods for all 4 edges. PanelController reads `UserDefaults "panelEdge"` to determine slide direction. Panel slides from the configured edge instead of always from the right.
  </done>
</task>

<task type="auto">
  <name>Task 2: Settings window, General tab, RetentionService, and access point wiring</name>
  <files>
    Pastel/Views/Settings/SettingsWindowController.swift
    Pastel/Views/Settings/SettingsView.swift
    Pastel/Views/Settings/GeneralSettingsView.swift
    Pastel/Views/Settings/ScreenEdgePicker.swift
    Pastel/Services/RetentionService.swift
    Pastel/App/AppState.swift
    Pastel/PastelApp.swift
    Pastel/Views/Panel/PanelContentView.swift
    Pastel/Views/MenuBar/StatusPopoverView.swift
  </files>
  <action>
**Create `Pastel/Views/Settings/SettingsWindowController.swift`:**

Singleton NSWindow controller following the proven AccessibilityPromptView pattern from AppState.checkAccessibilityOnLaunch(). Key details:

```swift
@MainActor
final class SettingsWindowController {
    static let shared = SettingsWindowController()
    private var window: NSWindow?

    func showSettings(modelContainer: ModelContainer) {
        // If already visible, just bring to front
        if let window, window.isVisible {
            window.makeKeyAndOrderFront(nil)
            NSApp.activate(ignoringOtherApps: true)
            return
        }

        let settingsView = SettingsView()
            .preferredColorScheme(.dark)
            .modelContainer(modelContainer)

        let hostingView = NSHostingView(rootView: settingsView)
        hostingView.translatesAutoresizingMaskIntoConstraints = false

        let window = NSWindow(
            contentRect: NSRect(x: 0, y: 0, width: 500, height: 420),
            styleMask: [.titled, .closable],
            backing: .buffered,
            defer: true
        )
        window.contentView = hostingView
        window.title = "Pastel Settings"
        window.center()
        window.isReleasedWhenClosed = false
        window.appearance = NSAppearance(named: .darkAqua)
        window.makeKeyAndOrderFront(nil)
        NSApp.activate(ignoringOtherApps: true)
        self.window = window
    }
}
```

Import SwiftUI, AppKit, SwiftData.

**Create `Pastel/Views/Settings/SettingsView.swift`:**

Root view with custom horizontal tab bar (keyogre pattern). Two tabs: General and Labels.

- Define `SettingsTab` enum with cases `.general` and `.labels`, each with an icon name (`"gearshape"`, `"tag"`) and display name.
- `@State private var selectedTab: SettingsTab = .general`
- Layout: VStack with tab bar at top, then content area below.
- Tab bar: HStack centered, each tab is an 80x60pt button with icon (SF Symbol, size 16) above text (size 12). Selected tab has `Color.accentColor.opacity(0.2)` background and `Color.accentColor` border on a RoundedRectangle(cornerRadius: 8). Unselected tabs have `Color.white.opacity(0.6)` foreground and no background. Use `.ultraThinMaterial` background on the entire tab bar row with rounded corners.
- Content area: switch on selectedTab, show GeneralSettingsView or LabelSettingsView (placeholder Text("Labels") for now -- Plan 02 builds LabelSettingsView).
- Add `.frame(width: 500, height: 420)` to the root VStack.

**Create `Pastel/Views/Settings/GeneralSettingsView.swift`:**

Form-style layout with all 4 settings. Top to bottom:

1. **Launch at login toggle:**
   ```swift
   import LaunchAtLogin
   LaunchAtLogin.Toggle("Launch at login")
       .toggleStyle(.switch)
   ```

2. **Panel toggle hotkey recorder:**
   ```swift
   import KeyboardShortcuts
   KeyboardShortcuts.Recorder("Panel Toggle Hotkey:", name: .togglePanel)
   ```
   Note: `KeyboardShortcuts.Name.togglePanel` is already defined in `AppState.swift`.

3. **Panel position selector:**
   ```swift
   @AppStorage("panelEdge") private var panelEdgeRaw: String = PanelEdge.right.rawValue

   VStack(alignment: .leading, spacing: 8) {
       Text("Panel Position")
           .font(.headline)
       ScreenEdgePicker(selectedEdge: $panelEdgeRaw)
   }
   ```
   When panelEdgeRaw changes, call `handleEdgeChange()` on PanelController. Wire this via `.onChange(of: panelEdgeRaw)`. Access PanelController through AppState environment or pass a closure.

   For wiring: add `@Environment(AppState.self) private var appState` and in the `.onChange(of: panelEdgeRaw)` call `appState.panelController.handleEdgeChange()`.

4. **History retention dropdown:**
   ```swift
   @AppStorage("historyRetention") private var retentionDays: Int = 90

   Picker("History Retention", selection: $retentionDays) {
       Text("1 Week").tag(7)
       Text("1 Month").tag(30)
       Text("3 Months").tag(90)
       Text("1 Year").tag(365)
       Text("Forever").tag(0)
   }
   ```

Layout: Use a VStack(alignment: .leading, spacing: 20) with padding. Each setting group has a label (Text) and the control below it. The whole view scrolls if needed.

**Create `Pastel/Views/Settings/ScreenEdgePicker.swift`:**

Visual screen diagram with clickable edges. ZStack with:
- A RoundedRectangle (160x100pt) representing the screen, filled with `Color.white.opacity(0.05)` and stroked with `Color.white.opacity(0.2)`.
- Four edge bars: top (120x12pt, centered horizontally at top), bottom (120x12pt, centered at bottom), left (12x70pt, centered vertically at left), right (12x70pt, centered at right).
- Each bar is a RoundedRectangle(cornerRadius: 3). Selected edge bar is `Color.accentColor`, unselected is `Color.white.opacity(0.15)`.
- Each bar has `.onTapGesture { selectedEdge = edge.rawValue }`.
- `@Binding var selectedEdge: String`

See the RESEARCH.md ScreenEdgePicker example for exact layout.

**Create `Pastel/Services/RetentionService.swift`:**

Follow the pattern from RESEARCH.md exactly. `@MainActor final class RetentionService` with:
- `init(modelContext: ModelContext)`
- `func startPeriodicPurge()` -- runs purge immediately, then schedules hourly via `Timer.scheduledTimer(withTimeInterval: 3600, repeats: true)`. The timer closure uses `Task { @MainActor in self?.purgeExpiredItems() }` for concurrency safety.
- `func purgeExpiredItems()` -- reads `UserDefaults.standard.integer(forKey: "historyRetention")`. If 0 (Forever), return early. Otherwise compute cutoff date (`Calendar.current.date(byAdding: .day, value: -retentionDays, to: .now)`). Fetch items older than cutoff, delete their images via `ImageStorageService.shared.deleteImage()`, then delete from SwiftData with `modelContext.delete(model: ClipboardItem.self, where:)`. Save. Rollback on error.
- Add `import OSLog` and a Logger for structured logging.

**Modify `Pastel/App/AppState.swift`:**

1. Add a `var retentionService: RetentionService?` property.
2. In `setup(modelContext:)`, after creating and starting the monitor, create and start the retention service:
   ```swift
   let retention = RetentionService(modelContext: modelContext)
   retention.startPeriodicPurge()
   self.retentionService = retention
   ```
3. Keep everything else unchanged.

**Modify `Pastel/PastelApp.swift`:**

Pass the modelContainer to AppState so settings views can access it. Add a `modelContainer` property to AppState:
```swift
// In AppState.swift:
var modelContainer: ModelContainer?
```
In `PastelApp.init()`, after `state.setupPanel(modelContainer: container)`, add:
```swift
state.modelContainer = container
```

This allows the settings gear icon to call `SettingsWindowController.shared.showSettings(modelContainer: appState.modelContainer!)`.

**Modify `Pastel/Views/Panel/PanelContentView.swift`:**

Add a gear icon button to the right side of the header HStack:
```swift
HStack {
    Text("Pastel")
        .font(.headline)
        .foregroundStyle(.secondary)
    Spacer()
    Button {
        if let container = appState.modelContainer {
            SettingsWindowController.shared.showSettings(modelContainer: container)
        }
    } label: {
        Image(systemName: "gearshape")
            .font(.system(size: 14))
            .foregroundStyle(.secondary)
    }
    .buttonStyle(.plain)
}
```

**Modify `Pastel/Views/MenuBar/StatusPopoverView.swift`:**

Add a "Settings..." button between the "Show History" button and the first Divider (or between the divider and "Clear All History"). Place it before the divider that precedes "Clear All History":

```swift
Button(action: {
    if let container = appState.modelContainer {
        SettingsWindowController.shared.showSettings(modelContainer: container)
    }
}) {
    HStack {
        Image(systemName: "gearshape")
        Text("Settings...")
        Spacer()
    }
}
.buttonStyle(.plain)
```

Note: `appState` is already available via `@Environment(AppState.self)`. Just need to add `modelContainer` property to AppState (done above).
  </action>
  <verify>
Run `cd /Users/phulsechinmay/Desktop/Projects/pastel && xcodebuild -scheme Pastel -destination 'platform=macOS' build 2>&1 | tail -5` -- must compile with zero errors. Verify all 6 new files exist under Views/Settings/ and Services/. Verify gear icon appears in PanelContentView header. Verify "Settings..." button appears in StatusPopoverView.
  </verify>
  <done>
Settings window opens from both the gear icon in the panel header and the "Settings..." button in the menu bar popover. General tab shows launch at login toggle (LaunchAtLogin.Toggle), hotkey recorder (KeyboardShortcuts.Recorder), visual panel position picker (ScreenEdgePicker bound to @AppStorage "panelEdge"), and history retention dropdown (Picker bound to @AppStorage "historyRetention"). RetentionService auto-purges expired history hourly. Changing panel position triggers PanelController.handleEdgeChange(). Labels tab shows placeholder text (implemented in Plan 02).
  </done>
</task>

</tasks>

<verification>
- [ ] `xcodebuild -scheme Pastel -destination 'platform=macOS' build` succeeds with zero errors
- [ ] PanelEdge.swift defines left, right, top, bottom with `onScreenFrame`/`offScreenFrame` methods
- [ ] PanelController.show() uses `currentEdge` instead of hard-coded right-edge frame math
- [ ] PanelController.hide() uses `currentEdge` for off-screen slide direction
- [ ] PanelController.handleEdgeChange() exists and destroys the panel for recreation
- [ ] SettingsWindowController.swift is a @MainActor singleton with showSettings(modelContainer:)
- [ ] SettingsView.swift has custom tab bar with General and Labels tabs
- [ ] GeneralSettingsView has 4 controls: LaunchAtLogin.Toggle, KeyboardShortcuts.Recorder, ScreenEdgePicker, retention Picker
- [ ] ScreenEdgePicker shows a visual screen diagram with 4 clickable edge bars
- [ ] RetentionService reads "historyRetention" from UserDefaults and purges items older than cutoff
- [ ] Gear icon in PanelContentView header opens settings window
- [ ] "Settings..." button in StatusPopoverView opens settings window
- [ ] @AppStorage("panelEdge") defaults to "right"
- [ ] @AppStorage("historyRetention") defaults to 90 (3 months)
</verification>

<success_criteria>
1. Build succeeds -- zero errors from xcodebuild
2. Settings window infrastructure complete -- SettingsWindowController singleton, SettingsView with tabbed UI, GeneralSettingsView with all 4 settings
3. Panel position configurable -- PanelEdge enum drives frame calculations for left/right/top/bottom, PanelController reads from UserDefaults
4. Launch at login wired -- LaunchAtLogin.Toggle in General settings
5. History retention wired -- RetentionService with periodic purge, retention Picker in General settings
6. Two access points -- gear icon in panel header and Settings button in menu bar popover both open settings window
</success_criteria>

<output>
After completion, create `.planning/phases/05-settings-and-polish/05-01-SUMMARY.md`
</output>
